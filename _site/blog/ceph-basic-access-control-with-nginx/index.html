<!DOCTYPE html>
<!--[if lt IE 7]><html class="no-js lt-ie9 lt-ie8 lt-ie7"><![endif]-->
<!--[if IE 7]><html class="no-js lt-ie9 lt-ie8" <![endif]-->
<!--[if IE 8]><html class="no-js lt-ie9" <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js"> <!--<![endif]-->

<head>
    <!-- Google Tag Manager -->
    <script>(function(w,d,s,l,i){w[l]=w[l]||[];w[l].push({'gtm.start':
       new Date().getTime(),event:'gtm.js'});var f=d.getElementsByTagName(s)[0],
       j=d.createElement(s),dl=l!='dataLayer'?'&l='+l:'';j.async=true;j.src=
       'https://www.googletagmanager.com/gtm.js?id='+i+dl;f.parentNode.insertBefore(j,f);
       })(window,document,'script','dataLayer','GTM-WP54B9K');</script>
    <!-- End Google Tag Manager -->

    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="description" content="">
    <title>Ceph: Basic Access Control and Rate Limit with Nginx</title>

    <!-- Favicon -->
    <link rel="icon" type="image/x-icon" href="/assets/img/favicon.ico" />

    <!-- Come and get me RSS readers -->
    <link rel="alternate" type="application/rss+xml" title="ArthurChiao's Blog" href="http://0.0.0.0:4000/feed.xml" />
    
    <!-- Stylesheet -->
    <link rel="stylesheet" href="/assets/css/style.css">
    <!--[if IE 8]><link rel="stylesheet" href="/assets/css/ie.css"><![endif]-->
    <link rel="canonical" href="http://0.0.0.0:4000/blog/ceph-basic-access-control-with-nginx/">

    <!-- Modernizr -->
    <script src="/assets/js/modernizr.custom.15390.js" type="text/javascript"></script>

    
</head>


<body>
  <!-- Google Tag Manager (noscript) -->
  <noscript><iframe src="https://www.googletagmanager.com/ns.html?id=GTM-WP54B9K"
    height="0" width="0" style="display:none;visibility:hidden"></iframe></noscript>
  <!-- End Google Tag Manager (noscript) -->

    <div class="header">
     <div class="container">
         <h1 class="logo"><a href="/">ArthurChiao's Blog</a></h1>
         <nav class="nav-collapse">
             <ul class="noList">
                 
                   
                   
                   <li class="element first  ">
                     <a href="/index.html">Home</a>
                   </li> 
                 
                   
                   
                   <li class="element   ">
                     <a href="/articles">Articles</a>
                   </li> 
                 
                   
                   
                   <li class="element   ">
                     <a href="/articles-zh">Articles (中文)</a>
                   </li> 
                 
                   
                   
                   <li class="element   ">
                     <a href="/categories">Categories</a>
                   </li> 
                 
                   
                   
                   <li class="element   last">
                     <a href="/about">About</a>
                   </li> 
                 
                 <!-- <li> <a href="https://github.com/arthurchiao/reading" target="_blank">Reading</a></li> -->
                 <!-- <li> <a href="https://github.com/arthurchiao/" target="_blank">GitHub</a></li> -->
             </ul>
         </nav>
     </div>
 </div><!-- end .header -->


   <div class="content">
      <div class="container">
         <div class="post">
  
  <h1 class="postTitle">Ceph: Basic Access Control and Rate Limit with Nginx</h1>
  <p class="meta">2018-11-05 | <span class="time">7</span> Minute Read</p>

  
  
  <p>In <a href="/blog/monitoring-ceph-obj-storage/">previous</a> article, we
mentioned that we placed Nginx in front of RGW
as a reverse proxy. <strong>The most important consideration was to collect monitoring metrics</strong>.
Besides that, nginx as a reverse proxy also brings us manyfold benefits.</p>

<p>In this post, we will see that how we could achieve basic access control
and rate limiting capabilities with nginx, which are invaluable in trouble shooting and failure recovery senarios.</p>

<h2 id="1-access-control">1 Access Control</h2>

<p>Highly imbalanced requests may exhaust a small number of Ceph nodes in a
cluster, to the extent that RGW returns many internal errors (<code class="highlighter-rouge">5xx</code>), while the rest stays idle.
If mojority of the requests are from several distinct clients, we could exclude
them from accessing the cluster with <code class="highlighter-rouge">deny</code> and <code class="highlighter-rouge">allow</code> primitives, this could win us valuable time for trouble shooting.</p>

<p>Snippet of original conf:</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>server {
  location / {
    proxy_pass http://radosgw;
  }
}
</code></pre></div></div>

<p>Forbide client <code class="highlighter-rouge">192.168.1.2</code>:</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>server {
  location / {
    deny 192.168.1.2;

    proxy_pass http://radosgw;
  }
}
</code></pre></div></div>

<p>then reload nginx with <code class="highlighter-rouge">service nginx reload</code>. If there are configuration errors,
the logs will be printed to nginx error log, usually <code class="highlighter-rouge">/var/log/nginx/error.log</code>.</p>

<p>Test on <code class="highlighter-rouge">192.168.1.2</code>, will receive <code class="highlighter-rouge">403 Forbidden</code>:</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>$ curl -i &lt;CEPH URL&gt;
Auth GET failed: http://&lt;CEPH URL&gt;/auth/1.0 403 Forbidden
</code></pre></div></div>

<p>And, you could see an entry in nginx error log like following:</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>2018/11/05 11:18:45 [error]: *965977 access forbidden by rule, client: 192.168.1.2, server: , request: "GET /auth/1.0 HTTP/1.1"
</code></pre></div></div>

<p>Combining <code class="highlighter-rouge">deny</code> and <code class="highlighter-rouge">allow</code>, we could exclude all clients from the same network,
e.g. <code class="highlighter-rouge">192.168.1.0/30</code>, and allow some specific IPs in that network. See [1][2] for more info.</p>

<h2 id="2-rate-limiting">2 Rate Limiting</h2>

<p>Nginx provides multiple primitives for rate limiting, with respect to different
aspects:</p>

<ul>
  <li>limit client QPS</li>
  <li>limit client connections</li>
  <li>limit bandwidth</li>
</ul>

<h3 id="21-limit-client-qps">2.1 Limit Client QPS</h3>

<p>Snippet of original conf:</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>server {
  listen 80;
}
</code></pre></div></div>

<p>Now we want to achieve:</p>

<ul>
  <li>limit QPS by client IP (binary form presentation)</li>
  <li>allow maximum QPS: 1 request/second</li>
  <li>put exceeded requests in a <code class="highlighter-rouge">10MB</code> memory zone <code class="highlighter-rouge">limitbyaddr</code></li>
  <li>indicating too many requests with HTTP code <code class="highlighter-rouge">429</code></li>
</ul>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>http {
  limit_req_zone $binary_remote_addr zone=limitbyaddr:10m rate=1r/s;
  limit_req_status 429;

  server {
    listen 80;

    limit_req zone=limitbyaddr;
  }
}
</code></pre></div></div>

<p>Test on RGW node:</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>$ for i in {1..3}; do curl localhost; done
<span class="cp">&lt;?xml version="1.0" encoding="UTF-8"?&gt;</span><span class="nt">&lt;html&gt;</span>
...
<span class="nt">&lt;head&gt;&lt;title&gt;</span>429 Too Many Requests<span class="nt">&lt;/title&gt;&lt;/head&gt;</span>
<span class="nt">&lt;body</span> <span class="na">bgcolor=</span><span class="s">"white"</span><span class="nt">&gt;</span>
<span class="nt">&lt;center&gt;&lt;h1&gt;</span>429 Too Many Requests<span class="nt">&lt;/h1&gt;&lt;/center&gt;</span>
<span class="nt">&lt;hr&gt;&lt;center&gt;</span>nginx/1.14.0<span class="nt">&lt;/center&gt;</span>
<span class="nt">&lt;/body&gt;</span>
<span class="nt">&lt;/html&gt;</span>
<span class="nt">&lt;html&gt;</span>
<span class="nt">&lt;head&gt;&lt;title&gt;</span>429 Too Many Requests<span class="nt">&lt;/title&gt;&lt;/head&gt;</span>
<span class="nt">&lt;body</span> <span class="na">bgcolor=</span><span class="s">"white"</span><span class="nt">&gt;</span>
<span class="nt">&lt;center&gt;&lt;h1&gt;</span>429 Too Many Requests<span class="nt">&lt;/h1&gt;&lt;/center&gt;</span>
<span class="nt">&lt;hr&gt;&lt;center&gt;</span>nginx/1.14.0<span class="nt">&lt;/center&gt;</span>
<span class="nt">&lt;/body&gt;</span>
<span class="nt">&lt;/html&gt;</span>
</code></pre></div></div>

<h3 id="22-limit-client-connections">2.2 Limit Client Connections</h3>

<p>Snippet of original conf:</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>server {
  listen 80;
}
</code></pre></div></div>

<p>Now:</p>

<ul>
  <li>limit QPS by client IP (binary form presentation)</li>
  <li>allow maximum 1 connection per client IP</li>
  <li>put exceeded requests in a <code class="highlighter-rouge">10MB</code> memory zone <code class="highlighter-rouge">limitbyaddr</code></li>
  <li>indicating too many requests with HTTP code <code class="highlighter-rouge">429</code></li>
</ul>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>http {
  limit_conn_zone $binary_remote_addr zone=limitbyaddr:10m;
  limit_conn_status 429;

  server {
    listen 80;

    limit_conn limitbyaddr 1;
  }
}
</code></pre></div></div>

<p>Test, download a large file simultaneously on the same node in two bash windows:</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>node-1 $ swift download bkt test_2G
(normal logs ...)
</code></pre></div></div>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>node-1 $ swift download bkt test_2G
Error downloading object 'bkt/test_2G': Object GET failed: http://&lt;CEPH URL&gt;/swift/v1/bkt/test_2G 429 Too Many Requests
</code></pre></div></div>

<h3 id="23-limit-bandwidth">2.3 Limit Bandwidth</h3>

<p>Similar as above with:</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>limit_rate_after 10m;
limit_rate 1m;
</code></pre></div></div>

<p>Quote from nginx <a href="http://nginx.org/en/docs/http/ngx_http_core_module.html#limit_rate">doc</a>:
<strong><em>“The limit is set per a request, and so if a client simultaneously opens two connections, the overall rate will be twice as much as the specified limit.</em></strong></p>

<h2 id="3-summary">3. Summary</h2>

<p>Nginx provides powerful privimitives for access controling and rate limiting.
In this post we just showed how we used these functionalities to win
us time for trouble shooting and failure recovery. Examples in this post
are quite simple, and we highly recommend readers to [1][2] for more powerful usage instructions.</p>

<h2 id="references">References</h2>

<ol>
  <li><a href="http://nginx.org/en/docs/">Nginx Doc</a></li>
  <li>O’Reilly Ebook, <a href="https://www.nginx.com/resources/library/complete-nginx-cookbook"><em>Complete Nginx Cookbook</em></a></li>
  <li><a href="/blog/monitoring-ceph-obj-storage/">CtripCloud: Monitoring Ceph Object Storage</a></li>
</ol>


  <!-- POST NAVIGATION -->
  <div class="postNav clearfix">
     
      <a class="prev" href="/blog/using-ceph-rbd-client/"><span>&laquo;&nbsp;Using Ceph RBD Client</span>
      
    </a>
      
      
      <a class="next" href="/blog/play-with-container-network-if/"><span>Play With Container Network Interface&nbsp;&raquo;</span>
       
      </a>
     
  </div>
</div>


         

      </div>
   </div><!-- end .content -->

   <div class="footer">
   <div class="container">
      <p class="copy">&copy; 2016-2019
      <a href="https://arthurchiao.github.io">Arthur Chiao</a>, Powered by
      <a href="http://jekyllrb.com">Jekyll </a>, Theme originated from
      <a href="https://github.com/brianmaierjr/long-haul"> Long Haul.</a>

      <script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>
      <span id="busuanzi_container_site_pv"> Site visits:
          <span id="busuanzi_value_site_pv"></span>, powered by<a href="http://busuanzi.ibruce.info/"> busuanzi</a>
      </span>

      </p>

      <div class="footer-links"> 
         <ul class="noList"> 
            
            <li><a href="https://www.facebook.com/profile.php?id=100014334455077">
                  <svg id="facebook-square" class="custom-icon" version="1.1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" viewBox="0 0 100 100" style="height: 30px; width: 30px;"><circle class="outer-shape" cx="50" cy="50" r="48" style="opacity: 1;"></circle>
                  <path class="inner-shape" style="opacity: 1;" transform="translate(25,25) scale(0.5)" d="M82.667,1H17.335C8.351,1,1,8.351,1,17.336v65.329c0,8.99,7.351,16.335,16.334,16.335h65.332 C91.652,99.001,99,91.655,99,82.665V17.337C99,8.353,91.652,1.001,82.667,1L82.667,1z M84.318,50H68.375v42.875H50V50h-8.855V35.973 H50v-9.11c0-12.378,5.339-19.739,19.894-19.739h16.772V22.3H72.967c-4.066-0.007-4.57,2.12-4.57,6.078l-0.023,7.594H86.75 l-2.431,14.027V50z"></path>
                  </svg>
            </a></li>
            
            
            <li><a href="https://linkedin.com/in/yanan-zhao-7691317b?trk=hp-identity-photo">
                  <svg id="linkedin" class="custom-icon" version="1.1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" viewBox="0 0 100 100" style="height: 30px; width: 30px;"><circle class="outer-shape" cx="50" cy="50" r="48" style="opacity: 1;"></circle>
                  <path class="inner-shape" style="opacity: 1;" transform="translate(25,25) scale(0.5)" d="M99.001,19.428c-3.606,1.608-7.48,2.695-11.547,3.184c4.15-2.503,7.338-6.466,8.841-11.189 c-3.885,2.318-8.187,4-12.768,4.908c-3.667-3.931-8.893-6.387-14.676-6.387c-11.104,0-20.107,9.054-20.107,20.223 c0,1.585,0.177,3.128,0.52,4.609c-16.71-0.845-31.525-8.895-41.442-21.131C6.092,16.633,5.1,20.107,5.1,23.813 c0,7.017,3.55,13.208,8.945,16.834c-3.296-0.104-6.397-1.014-9.106-2.529c-0.002,0.085-0.002,0.17-0.002,0.255 c0,9.799,6.931,17.972,16.129,19.831c-1.688,0.463-3.463,0.71-5.297,0.71c-1.296,0-2.555-0.127-3.783-0.363 c2.559,8.034,9.984,13.882,18.782,14.045c-6.881,5.424-15.551,8.657-24.971,8.657c-1.623,0-3.223-0.096-4.796-0.282 c8.898,5.738,19.467,9.087,30.82,9.087c36.982,0,57.206-30.817,57.206-57.543c0-0.877-0.02-1.748-0.059-2.617 C92.896,27.045,96.305,23.482,99.001,19.428z"></path>
                  </svg>
            </a></li>
            
            
            <li><a href="https://github.com/ArthurChiao">
                  <svg id="github" class="custom-icon" version="1.1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" viewBox="0 0 100 100" style="height: 30px; width: 30px;"><circle class="outer-shape" cx="50" cy="50" r="48" style="opacity: 1;"></circle>
                  <path class="inner-shape" style="opacity: 1;" transform="translate(25,25) scale(0.5)" d="M50,1C22.938,1,1,22.938,1,50s21.938,49,49,49s49-21.938,49-49S77.062,1,50,1z M79.099,79.099 c-3.782,3.782-8.184,6.75-13.083,8.823c-1.245,0.526-2.509,0.989-3.79,1.387v-7.344c0-3.86-1.324-6.699-3.972-8.517 c1.659-0.16,3.182-0.383,4.57-0.67c1.388-0.287,2.855-0.702,4.402-1.245c1.547-0.543,2.935-1.189,4.163-1.938 c1.228-0.75,2.409-1.723,3.541-2.919s2.082-2.552,2.847-4.067s1.372-3.334,1.818-5.455c0.446-2.121,0.67-4.458,0.67-7.01 c0-4.945-1.611-9.155-4.833-12.633c1.467-3.828,1.308-7.991-0.478-12.489l-1.197-0.143c-0.829-0.096-2.321,0.255-4.474,1.053 c-2.153,0.798-4.57,2.105-7.249,3.924c-3.797-1.053-7.736-1.579-11.82-1.579c-4.115,0-8.039,0.526-11.772,1.579 c-1.69-1.149-3.294-2.097-4.809-2.847c-1.515-0.75-2.727-1.26-3.637-1.532c-0.909-0.271-1.754-0.439-2.536-0.503 c-0.782-0.064-1.284-0.079-1.507-0.048c-0.223,0.031-0.383,0.064-0.478,0.096c-1.787,4.53-1.946,8.694-0.478,12.489 c-3.222,3.477-4.833,7.688-4.833,12.633c0,2.552,0.223,4.889,0.67,7.01c0.447,2.121,1.053,3.94,1.818,5.455 c0.765,1.515,1.715,2.871,2.847,4.067s2.313,2.169,3.541,2.919c1.228,0.751,2.616,1.396,4.163,1.938 c1.547,0.543,3.014,0.957,4.402,1.245c1.388,0.287,2.911,0.511,4.57,0.67c-2.616,1.787-3.924,4.626-3.924,8.517v7.487 c-1.445-0.43-2.869-0.938-4.268-1.53c-4.899-2.073-9.301-5.041-13.083-8.823c-3.782-3.782-6.75-8.184-8.823-13.083 C9.934,60.948,8.847,55.56,8.847,50s1.087-10.948,3.231-16.016c2.073-4.899,5.041-9.301,8.823-13.083s8.184-6.75,13.083-8.823 C39.052,9.934,44.44,8.847,50,8.847s10.948,1.087,16.016,3.231c4.9,2.073,9.301,5.041,13.083,8.823 c3.782,3.782,6.75,8.184,8.823,13.083c2.143,5.069,3.23,10.457,3.23,16.016s-1.087,10.948-3.231,16.016 C85.848,70.915,82.88,75.317,79.099,79.099L79.099,79.099z"></path>
                  </svg>
            </a></li>
             
            
            <li><a href="mailto:arthurchiao@hotmail.com">
                  <svg id="mail" class="custom-icon" version="1.1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" viewBox="0 0 100 100" style="height: 30px; width: 30px;"><circle class="outer-shape" cx="50" cy="50" r="48" style="opacity: 1;"></circle>
                  <path class="inner-shape" style="opacity: 1;" transform="translate(25,25) scale(0.5)" d="M50,1C22.938,1,1,22.938,1,50s21.938,49,49,49s49-21.938,49-49S77.062,1,50,1z M25.5,25.5h49 c0.874,0,1.723,0.188,2.502,0.542L50,57.544L22.998,26.041C23.777,25.687,24.626,25.499,25.5,25.5L25.5,25.5z M19.375,68.375v-36.75 c0-0.128,0.005-0.256,0.014-0.383l17.96,20.953L19.587,69.958C19.448,69.447,19.376,68.916,19.375,68.375L19.375,68.375z M74.5,74.5 h-49c-0.541,0-1.072-0.073-1.583-0.212l17.429-17.429L50,66.956l8.653-10.096l17.429,17.429C75.572,74.427,75.041,74.5,74.5,74.5 L74.5,74.5z M80.625,68.375c0,0.541-0.073,1.072-0.211,1.583L62.652,52.195l17.96-20.953c0.008,0.127,0.014,0.255,0.014,0.383 L80.625,68.375L80.625,68.375z"></path>
                  </svg>
            </a></li>
            
         </ul>
      </div>
   </div>
</div><!-- end .footer -->

   <!-- Add jQuery and other scripts -->
<script src="//ajax.googleapis.com/ajax/libs/jquery/1.11.2/jquery.min.js"></script>
<script>window.jQuery || document.write('<script src=""><\/script>')</script>
<script src="/assets/js/dropcap.min.js"></script>
<script src="/assets/js/responsive-nav.min.js"></script>
<script src="/assets/js/scripts.js"></script>


</body>

</html>
