<!DOCTYPE html>
<!--[if lt IE 7]><html class="no-js lt-ie9 lt-ie8 lt-ie7"><![endif]-->
<!--[if IE 7]><html class="no-js lt-ie9 lt-ie8" <![endif]-->
<!--[if IE 8]><html class="no-js lt-ie9" <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js"> <!--<![endif]-->

<head>
    <!-- Google Tag Manager -->
    <script>(function(w,d,s,l,i){w[l]=w[l]||[];w[l].push({'gtm.start':
       new Date().getTime(),event:'gtm.js'});var f=d.getElementsByTagName(s)[0],
       j=d.createElement(s),dl=l!='dataLayer'?'&l='+l:'';j.async=true;j.src=
       'https://www.googletagmanager.com/gtm.js?id='+i+dl;f.parentNode.insertBefore(j,f);
       })(window,document,'script','dataLayer','GTM-WP54B9K');</script>
    <!-- End Google Tag Manager -->

    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="description" content="">
    <title>[译] 深入理解 iptables 和 netfilter 架构</title>

    <!-- Favicon -->
    <link rel="icon" type="image/x-icon" href="/assets/img/favicon.ico" />

    <!-- Come and get me RSS readers -->
    <link rel="alternate" type="application/rss+xml" title="ArthurChiao's Blog" href="http://0.0.0.0:4000/feed.xml" />
    
    <!-- Stylesheet -->
    <link rel="stylesheet" href="/assets/css/style.css">
    <!--[if IE 8]><link rel="stylesheet" href="/assets/css/ie.css"><![endif]-->
    <link rel="canonical" href="http://0.0.0.0:4000/blog/deep-dive-into-iptables-and-netfilter-arch-zh/">

    <!-- Modernizr -->
    <script src="/assets/js/modernizr.custom.15390.js" type="text/javascript"></script>

    
</head>


<body>
  <!-- Google Tag Manager (noscript) -->
  <noscript><iframe src="https://www.googletagmanager.com/ns.html?id=GTM-WP54B9K"
    height="0" width="0" style="display:none;visibility:hidden"></iframe></noscript>
  <!-- End Google Tag Manager (noscript) -->

    <div class="header">
     <div class="container">
         <h1 class="logo"><a href="/">ArthurChiao's Blog</a></h1>
         <nav class="nav-collapse">
             <ul class="noList">
                 
                   
                   
                   <li class="element first  ">
                     <a href="/index.html">Home</a>
                   </li> 
                 
                   
                   
                   <li class="element   ">
                     <a href="/articles">Articles</a>
                   </li> 
                 
                   
                   
                   <li class="element   ">
                     <a href="/articles-zh">Articles (中文)</a>
                   </li> 
                 
                   
                   
                   <li class="element   ">
                     <a href="/categories">Categories</a>
                   </li> 
                 
                   
                   
                   <li class="element   last">
                     <a href="/about">About</a>
                   </li> 
                 
                 <!-- <li> <a href="https://github.com/arthurchiao/reading" target="_blank">Reading</a></li> -->
                 <!-- <li> <a href="https://github.com/arthurchiao/" target="_blank">GitHub</a></li> -->
             </ul>
         </nav>
     </div>
 </div><!-- end .header -->


   <div class="content">
      <div class="container">
         <div class="post">
  
  <h1 class="postTitle">[译] 深入理解 iptables 和 netfilter 架构</h1>
  <p class="meta">2019-02-18 | <span class="time">10</span> Minute Read</p>

  
  
  <h3 id="译者序">译者序</h3>

<p>本文翻译自2015年的一篇英文博客 <a href="https://www.digitalocean.com/community/tutorials/a-deep-dive-into-iptables-and-netfilter-architecture">A Deep Dive into Iptables and Netfilter
Architecture</a>
。</p>

<p>这篇对 iptables 和 netfilter 的设计和原理介绍比较全面，美中不足的是没有那张
内核协议栈各 hook 点位置和 iptables 规则优先级的经典配图，这里补充如下（来自
<a href="https://upload.wikimedia.org/wikipedia/commons/3/37/Netfilter-packet-flow.svg">Wikipedia</a>
）：</p>

<p align="center"><img src="/assets/img/deep-dive-into-iptables-netfilter/Netfilter-packet-flow.svg" width="100%" height="100%" /></p>

<p>另外，本文只讲理论，而下面这篇则侧重实战（基于 iptables 做 NAT）：</p>

<ol>
  <li><a href="/blog/nat-zh/">(译) NAT - 网络地址转换</a></li>
</ol>

<p>可作为本文的补充阅读。</p>

<p><strong>由于译者水平有限，本文不免存在遗漏或错误之处。如有疑问，请查阅原文。</strong></p>

<p>以下是译文。</p>

<hr />

<h3 id="前言">前言</h3>

<p>防火墙是保护服务器和基础设施安全的重要工具。在 Linux 生态系统中，<code class="highlighter-rouge">iptables</code> 是使
用很广泛的防火墙工具之一，它基于内核的包过滤框架（packet filtering framework）
<code class="highlighter-rouge">netfilter</code>。如果管理员或用户不了解这些系统的架构，那可能就无法创建出可靠的防火
墙策略，一方面是因为 iptables 的语法颇有挑战性，另外一方面是 netfilter 框架内部
相互交织而变得错综复杂。</p>

<p>本文将带领读者深入理解 <code class="highlighter-rouge">iptables</code> 框架，让那些需要创建防火墙策略的用户对它有一个
更全面的认识。我们会讨论 iptables 是如何与 netfilter 交互的，几个组件是如何组织
成<strong>一个全面的过滤和矫正系统</strong>（a comprehensive filtering and mangling system）的。</p>

<h2 id="1-iptables-和-netfilter-是什么">1 IPTables 和 Netfilter 是什么？</h2>

<p>Linux 上最常用的防火墙工具是 iptables。iptables 与协议栈内有包过滤功能的hook 交
互来完成工作。这些内核 hook 构成了 netfilter 框架。</p>

<p>每个进入网络系统的包（接收或发送）在经过协议栈时都会触发这些 hook，程序
可以通过<strong>注册 hook 函数</strong>的方式在一些关键路径上处理网络流量。iptables 相关的内核模
块在这些 hook 点注册了处理函数，因此可以通过配置 iptables 规则来使得网络流量符合
防火墙规则。</p>

<h2 id="2-netfilter-hooks">2. Netfilter Hooks</h2>

<p>netfilter 提供了 5 个 hook 点。包经过协议栈时会触发<strong>内核模块注册在这里的处理函数</strong>
。触发哪个 hook 取决于包的方向（是发送还是接收）、包的目的地址、以及包在上一个
hook 点是被丢弃还是拒绝等等。</p>

<p>下面几个 hook 是内核协议栈中已经定义好的：</p>

<ul>
  <li><code class="highlighter-rouge">NF_IP_PRE_ROUTING</code>: 接收到的包进入协议栈后立即触发此 hook，在进行任何路由判断
（将包发往哪里）之前</li>
  <li><code class="highlighter-rouge">NF_IP_LOCAL_IN</code>: 接收到的包经过路由判断，如果目的是本机，将触发此 hook</li>
  <li><code class="highlighter-rouge">NF_IP_FORWARD</code>: 接收到的包经过路由判断，如果目的是其他机器，将触发此 hook</li>
  <li><code class="highlighter-rouge">NF_IP_LOCAL_OUT</code>: 本机产生的准备发送的包，在进入协议栈后立即触发此 hook</li>
  <li><code class="highlighter-rouge">NF_IP_POST_ROUTING</code>: 本机产生的准备发送的包或者转发的包，在经过路由判断之后，
将触发此 hook</li>
</ul>

<p><strong>注册处理函数时必须提供优先级</strong>，以便 hook 触发时能按照
优先级高低调用处理函数。这使得<strong>多个模块（或者同一内核模块的多个实例）可以在同一
hook 点注册，并且有确定的处理顺序</strong>。内核模块会依次被调用，每次返回一个结果给
netfilter 框架，提示该对这个包做什么操作。</p>

<h2 id="3-iptables-表和链tables-and-chains">3 IPTables 表和链（Tables and Chains）</h2>

<p>iptables 使用 table 来组织规则，根据<strong>用来做什么类型的判断</strong>（the type of
decisions they are used to make）标准，将规则分为不同table。例如，如果规则是处理
网络地址转换的，那会放到 <code class="highlighter-rouge">nat</code> table；如果是判断是否允许包继续向前，那可能会放到
<code class="highlighter-rouge">filter</code> table。</p>

<p>在每个 table 内部，规则被进一步组织成 chain，<strong>内置的 chain 是由内置的 hook 触发
的</strong>。chain 基本上能决定（basically determin）规则<strong>何时</strong>被匹配。</p>

<p>下面可以看出，内置的 chain 名字和 netfilter hook 名字是一一对应的：</p>

<ul>
  <li><code class="highlighter-rouge">PREROUTING</code>: 由 <code class="highlighter-rouge">NF_IP_PRE_ROUTING</code> hook 触发</li>
  <li><code class="highlighter-rouge">INPUT</code>: 由 <code class="highlighter-rouge">NF_IP_LOCAL_IN</code> hook 触发</li>
  <li><code class="highlighter-rouge">FORWARD</code>: 由 <code class="highlighter-rouge">NF_IP_FORWARD</code> hook 触发</li>
  <li><code class="highlighter-rouge">OUTPUT</code>: 由 <code class="highlighter-rouge">NF_IP_LOCAL_OUT</code> hook 触发</li>
  <li><code class="highlighter-rouge">POSTROUTING</code>: 由 <code class="highlighter-rouge">NF_IP_POST_ROUTING</code> hook 触发</li>
</ul>

<p>chain 使管理员可以控制在<strong>包的传输路径上哪个点</strong>（where in a packet’s delivery
path）应用策略。因为每个 table 有多个 chain，因此一个 table 可以在处理过程中的多
个地方施加影响。<strong>特定类型的规则只在协议栈的特定点有意义，因此并不是每个table 都
会在内核的每个 hook 注册 chain</strong>。</p>

<p>内核一共只有 5 个 netfilter hook，因此不同 table 的 chain 最终都是注册到这几个点
。例如，有三个 table 有 <code class="highlighter-rouge">PRETOUTING</code> chain。当这些 chain 注册到对应的
<code class="highlighter-rouge">NF_IP_PRE_ROUTING</code> hook 点时，它们需要指定优先级，应该依次调用哪个 table 的
<code class="highlighter-rouge">PRETOUTING</code> chain，优先级从高到低。我们一会就会看到 chain 的优先级问题。</p>

<h2 id="4-table-种类">4. table 种类</h2>

<p>先来看看 iptables 提供的 table 类型。这些 table 是按规则类型区分的。</p>

<h3 id="41-filter-table">4.1 Filter Table</h3>

<p><code class="highlighter-rouge">filter</code> table 是最常用的 table 之一，用于<strong>判断是否允许一个包通过</strong>。</p>

<p>在防火墙领域，这通常称作“过滤”包（”filtering” packets）。这个 table 提供了防火墙
的一些常见功能。</p>

<h3 id="42-nat-table">4.2 NAT Table</h3>

<p><code class="highlighter-rouge">nat</code> table 用于实现网络地址转换规则。</p>

<p>当包进入协议栈的时候，这些规则决定是否以及如何修改包的源/目的地址，以改变包被
路由时的行为。<code class="highlighter-rouge">nat</code> table 通常用于将包路由到无法直接访问的网络。</p>

<h3 id="43-mangle-table">4.3 Mangle Table</h3>

<p><code class="highlighter-rouge">mangle</code> （修正）table 用于<strong>修改包的 IP 头</strong>。</p>

<p>例如，可以修改包的 TTL，增加或减少包可以经过的跳数。</p>

<p>这个 table 还可以对包打<strong>只在内核内有效的</strong>“标记”（internal kernel “mark”），后
续的 table 或工具处理的时候可以用到这些标记。标记不会修改包本身，只是在包的内核
表示上做标记。</p>

<h3 id="44-raw-table">4.4 Raw Table</h3>

<p><strong>iptables 防火墙是有状态的</strong>：对每个包进行判断的时候是<strong>依赖已经判断过的包</strong>。</p>

<p>建立在 netfilter 之上的连接跟踪（connection tracking）特性<strong>使得 iptables 将包
看作已有的连接或会话的一部分</strong>，而不是一个由独立、不相关的包组成的流。连接跟踪逻
辑在包到达网络接口之后很快就应用了。</p>

<p><code class="highlighter-rouge">raw</code> table 定义的功能非常有限，其<strong>唯一目的就是提供一个让包绕过连接跟踪的框架</strong>。</p>

<h3 id="45-security-table">4.5 Security Table</h3>

<p><code class="highlighter-rouge">security</code> table 的作用是给包打上 SELinux 标记，以此影响 SELinux 或其他可以解读
SELinux 安全上下文的系统处理包的行为。这些标记可以基于单个包，也可以基于连接。</p>

<h2 id="5-每种-table-实现的-chain">5 每种 table 实现的 chain</h2>

<p>前面已经分别讨论了 table 和 chain，接下来看每个 table 里各有哪些 chain。另外，我
们还将讨论注册到同一 hook 的不同 chain 的优先级问题。例如，如果三个 table 都有
<code class="highlighter-rouge">PRETOUTING</code> chain，那应该按照什么顺序调用它们呢？</p>

<p>下面的表格展示了 table 和 chain 的关系。横向是 table， 纵向是 chain，Y 表示 这个
table 里面有这个 chain。例如，第二行表示 <code class="highlighter-rouge">raw</code> table 有<code class="highlighter-rouge">PRETOUTING</code> 和 <code class="highlighter-rouge">OUTPUT</code> 两
个 chain。具体到每列，从上倒下的顺序就是netfilter hook 触发的时候，（对应
table 的）chain 被调用的顺序。</p>

<p>有几点需要说明一下。在下面的图中，<code class="highlighter-rouge">nat</code> table 被细分成了 <code class="highlighter-rouge">DNAT</code> （修改目的地址）
和 <code class="highlighter-rouge">SNAT</code>（修改源地址），以更方便地展示他们的优先级。另外，我们添加了路由决策点
和连接跟踪点，以使得整个过程更完整全面：</p>

<table>
  <thead>
    <tr>
      <th style="text-align: left">Tables/Chains</th>
      <th style="text-align: left">PREROUTING</th>
      <th style="text-align: left">INPUT</th>
      <th style="text-align: left">FORWARD</th>
      <th style="text-align: left">OUTPUT</th>
      <th style="text-align: left">POSTROUTING</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td style="text-align: left">(路由判断)</td>
      <td style="text-align: left"> </td>
      <td style="text-align: left"> </td>
      <td style="text-align: left"> </td>
      <td style="text-align: left">Y</td>
      <td style="text-align: left"> </td>
    </tr>
    <tr>
      <td style="text-align: left"><strong>raw</strong></td>
      <td style="text-align: left">Y</td>
      <td style="text-align: left"> </td>
      <td style="text-align: left"> </td>
      <td style="text-align: left">Y</td>
      <td style="text-align: left"> </td>
    </tr>
    <tr>
      <td style="text-align: left">(连接跟踪）</td>
      <td style="text-align: left">Y</td>
      <td style="text-align: left"> </td>
      <td style="text-align: left"> </td>
      <td style="text-align: left">Y</td>
      <td style="text-align: left"> </td>
    </tr>
    <tr>
      <td style="text-align: left"><strong>mangle</strong></td>
      <td style="text-align: left">Y</td>
      <td style="text-align: left">Y</td>
      <td style="text-align: left">Y</td>
      <td style="text-align: left">Y</td>
      <td style="text-align: left">Y</td>
    </tr>
    <tr>
      <td style="text-align: left"><strong>nat (DNAT)</strong></td>
      <td style="text-align: left">Y</td>
      <td style="text-align: left"> </td>
      <td style="text-align: left"> </td>
      <td style="text-align: left">Y</td>
      <td style="text-align: left"> </td>
    </tr>
    <tr>
      <td style="text-align: left">(路由判断)</td>
      <td style="text-align: left">Y</td>
      <td style="text-align: left"> </td>
      <td style="text-align: left"> </td>
      <td style="text-align: left">Y</td>
      <td style="text-align: left"> </td>
    </tr>
    <tr>
      <td style="text-align: left"><strong>filter</strong></td>
      <td style="text-align: left"> </td>
      <td style="text-align: left">Y</td>
      <td style="text-align: left">Y</td>
      <td style="text-align: left">Y</td>
      <td style="text-align: left"> </td>
    </tr>
    <tr>
      <td style="text-align: left"><strong>security</strong></td>
      <td style="text-align: left"> </td>
      <td style="text-align: left">Y</td>
      <td style="text-align: left">Y</td>
      <td style="text-align: left">Y</td>
      <td style="text-align: left"> </td>
    </tr>
    <tr>
      <td style="text-align: left"><strong>nat (SNAT)</strong></td>
      <td style="text-align: left"> </td>
      <td style="text-align: left">Y</td>
      <td style="text-align: left"> </td>
      <td style="text-align: left">Y</td>
      <td style="text-align: left">Y</td>
    </tr>
  </tbody>
</table>

<p><strong>当一个包触发 netfilter hook 时，处理过程将沿着列从上向下执行。</strong> 触发哪个 hook
（列）和包的方向（ingress/egress）、路由判断、过滤条件等相关。</p>

<p>特定事件会导致 table 的 chain 被跳过。例如，只有每个连接的第一个包会去匹配 NAT
规则，对这个包的动作会应用于此连接后面的所有包。到这个连接的应答包会被自动应用反
方向的 NAT 规则。</p>

<h3 id="chain-遍历优先级">Chain 遍历优先级</h3>

<p>假设服务器知道如何路由数据包，而且防火墙允许数据包传输，下面就是不同场景下包的游
走流程：</p>

<ul>
  <li>收到的、目的是本机的包：<code class="highlighter-rouge">PRETOUTING</code> -&gt; <code class="highlighter-rouge">INPUT</code></li>
  <li>收到的、目的是其他主机的包：<code class="highlighter-rouge">PRETOUTING</code> -&gt; <code class="highlighter-rouge">FORWARD</code> -&gt; <code class="highlighter-rouge">POSTROUTING</code></li>
  <li>本地产生的包：<code class="highlighter-rouge">OUTPUT</code> -&gt; <code class="highlighter-rouge">POSTROUTING</code></li>
</ul>

<p><strong>综合前面讨论的 table 顺序问题，我们可以看到对于一个收到的、目的是本机的包</strong>：
首先依次经过 <code class="highlighter-rouge">PRETOUTING</code> chain 上面的 <code class="highlighter-rouge">raw</code>、<code class="highlighter-rouge">mangle</code>、<code class="highlighter-rouge">nat</code> table；然后依次经
过<code class="highlighter-rouge">INPUT</code> chain 的 <code class="highlighter-rouge">mangle</code>、<code class="highlighter-rouge">filter</code>、<code class="highlighter-rouge">security</code>、<code class="highlighter-rouge">nat</code> table，然后才会到达本机
的某个 socket。</p>

<h2 id="6-iptables-规则">6 IPTables 规则</h2>

<p>规则放置在特定 table 的特定 chain 里面。当 chain 被调用的时候，包会依次匹配chain
里面的规则。每条规则都有一个匹配部分和一个动作部分。</p>

<h3 id="61-匹配">6.1 匹配</h3>

<p>规则的匹配部分指定了一些条件，包必须满足这些条件才会和相应的将要执行的动作（“
target”）进行关联。</p>

<p>匹配系统非常灵活，还可以通过 iptables extension大大扩展其功能。规则可以匹配<strong>协
议类型、目的或源地址、目的或源端口、目的或源网段、接收或发送的接口（网卡）、协议
头、连接状态</strong>等等条件。这些综合起来，能够组合成非常复杂的规则来区分不同的网络流
量。</p>

<h3 id="62-目标">6.2 目标</h3>

<p>包符合某种规则的条件而触发的动作（action）叫做目标（target）。目标分为两种类型：</p>

<ul>
  <li><strong>终止目标</strong>（terminating targets）：这种 target 会终止 chain 的匹配，将控制权
转移回 netfilter hook。根据返回值的不同，hook 或者将包丢弃，或者允许包进行下一
阶段的处理</li>
  <li><strong>非终止目标</strong>（non-terminating targets）：非终止目标执行动作，然后继续 chain
的执行。虽然每个 chain 最终都会回到一个终止目标，但是在这之前，可以执行任意多
个非终止目标</li>
</ul>

<p>每个规则可以跳转到哪个 target 依上下文而定，例如，table 和 chain 可能会设置
target 可用或不可用。规则里激活的 extensions 和匹配条件也影响 target 的可用性。</p>

<h2 id="7-跳转到用户自定义-chain">7 跳转到用户自定义 chain</h2>

<p>这里要介绍一种特殊的非终止目标：跳转目标（jump target）。jump target 是跳转到其
他 chain 继续处理的动作。我们已经讨论了很多内置的 chain，它们和调用它们的
netfilter hook 紧密联系在一起。然而，iptables 也支持管理员创建他们自己的用于管理
目的的 chain。</p>

<p>向用户自定义 chain 添加规则和向内置的 chain 添加规则的方式是相同的。<strong>不同的地方
在于，用户定义的 chain 只能通过从另一个规则跳转（jump）到它，因为它们没有注册到
netfilter hook</strong>。</p>

<p>用户定义的 chain 可以看作是对调用它的 chain 的扩展。例如，用户定义的 chain 在结
束的时候，可以返回 netfilter hook，也可以继续跳转到其他自定义 chain。</p>

<p>这种设计使框架具有强大的分支功能，使得管理员可以组织更大更复杂的网络规则。</p>

<h2 id="8-iptables-和连接跟踪">8 IPTables 和连接跟踪</h2>

<p>在讨论 <code class="highlighter-rouge">raw</code> table 和 匹配连接状态的时候，我们介绍了构建在 netfilter 之上的连
接跟踪系统。连接跟踪系统使得 iptables 基于连接上下文而不是单个包来做出规则判
断，给 iptables 提供了有状态操作的功能。</p>

<p>连接跟踪在包进入协议栈之后很快（very soon）就开始工作了。在给包分配连接之前所做
的工作非常少，只有检查 <code class="highlighter-rouge">raw</code> table 和一些基本的完整性检查。</p>

<p>跟踪系统将包和已有的连接进行比较，如果包所属的连接已经存在就更新连接状态，否则就
创建一个新连接。如果 <code class="highlighter-rouge">raw</code> table 的某个 chain 对包标记为目标是 <code class="highlighter-rouge">NOTRACK</code>，那这
个包会跳过连接跟踪系统。</p>

<h3 id="连接的状态">连接的状态</h3>

<p>连接跟踪系统中的连接状态有：</p>

<ul>
  <li>
    <p><code class="highlighter-rouge">NEW</code>：如果到达的包关连不到任何已有的连接，但包是合法的，就为这个包创建一个新连接。对
面向连接的（connection-aware）的协议例如 TCP 以及非面向连接的（connectionless
）的协议例如 UDP 都适用</p>
  </li>
  <li>
    <p><code class="highlighter-rouge">ESTABLISHED</code>：当一个连接收到应答方向的合法包时，状态从 <code class="highlighter-rouge">NEW</code> 变成
<code class="highlighter-rouge">ESTABLISHED</code>。对 TCP 这个合法包其实就是 <code class="highlighter-rouge">SYN/ACK</code> 包；对 UDP 和 ICMP 是源和目
的 IP 与原包相反的包</p>
  </li>
  <li>
    <p><code class="highlighter-rouge">RELATED</code>：包不属于已有的连接，但是和已有的连接有一定关系。这可能是辅助连接（
helper connection），例如 FTP 数据传输连接，或者是其他协议试图建立连接时的
ICMP 应答包</p>
  </li>
  <li>
    <p><code class="highlighter-rouge">INVALID</code>：包不属于已有连接，并且因为某些原因不能用来创建一个新连接，例如无法
识别、无法路由等等</p>
  </li>
  <li>
    <p><code class="highlighter-rouge">UNTRACKED</code>：如果在 <code class="highlighter-rouge">raw</code> table 中标记为目标是 <code class="highlighter-rouge">UNTRACKED</code>，这个包将不会进入连
接跟踪系统</p>
  </li>
  <li>
    <p><code class="highlighter-rouge">SNAT</code>：包的源地址被 NAT 修改之后会进入的虚拟状态。连接跟踪系统据此在收到
反向包时对地址做反向转换</p>
  </li>
  <li>
    <p><code class="highlighter-rouge">DNAT</code>：包的目的地址被 NAT 修改之后会进入的虚拟状态。连接跟踪系统据此在收到
反向包时对地址做反向转换</p>
  </li>
</ul>

<p>这些状态可以定位到连接生命周期内部，管理员可以编写出更加细粒度、适用范围更大、更
安全的规则。</p>

<h2 id="9-总结">9 总结</h2>

<p>netfilter 包过滤框架和 iptables 防火墙是 Linux 服务器上大部分防火墙解决方案的基
础。netfilter 的内核 hook 和协议栈足够紧密，提供了包经过系统时的强大控制功能。
iptables 防火墙基于这些功能提供了一个灵活的、可扩展的、将策略需求转化到内核的方
法。理解了这些不同部分是如何联系到一起的，就可以使用它们控制和保护你的的服务器环
境。</p>

<p>想了解更多 iptables 使用方式，参考这个<a href="https://www.digitalocean.com/community/tutorials/how-to-choose-an-effective-firewall-policy-to-secure-your-servers">教程
</a>
。</p>


  <!-- POST NAVIGATION -->
  <div class="postNav clearfix">
     
      <a class="prev" href="/blog/nat-zh/"><span>&laquo;&nbsp;[译] NAT - 网络地址转换</span>
      
    </a>
      
      
      <a class="next" href="/blog/intro-to-modern-lb-and-proxy-zh/"><span>[译] 现代网络负载均衡与代理导论&nbsp;&raquo;</span>
       
      </a>
     
  </div>
</div>


         

      </div>
   </div><!-- end .content -->

   <div class="footer">
   <div class="container">
      <p class="copy">&copy; 2016-2019
      <a href="https://arthurchiao.github.io">Arthur Chiao</a>, Powered by
      <a href="http://jekyllrb.com">Jekyll </a>, Theme originated from
      <a href="https://github.com/brianmaierjr/long-haul"> Long Haul.</a>

      <script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>
      <span id="busuanzi_container_site_pv"> Site visits:
          <span id="busuanzi_value_site_pv"></span>, powered by<a href="http://busuanzi.ibruce.info/"> busuanzi</a>
      </span>

      </p>

      <div class="footer-links"> 
         <ul class="noList"> 
            
            <li><a href="https://www.facebook.com/profile.php?id=100014334455077">
                  <svg id="facebook-square" class="custom-icon" version="1.1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" viewBox="0 0 100 100" style="height: 30px; width: 30px;"><circle class="outer-shape" cx="50" cy="50" r="48" style="opacity: 1;"></circle>
                  <path class="inner-shape" style="opacity: 1;" transform="translate(25,25) scale(0.5)" d="M82.667,1H17.335C8.351,1,1,8.351,1,17.336v65.329c0,8.99,7.351,16.335,16.334,16.335h65.332 C91.652,99.001,99,91.655,99,82.665V17.337C99,8.353,91.652,1.001,82.667,1L82.667,1z M84.318,50H68.375v42.875H50V50h-8.855V35.973 H50v-9.11c0-12.378,5.339-19.739,19.894-19.739h16.772V22.3H72.967c-4.066-0.007-4.57,2.12-4.57,6.078l-0.023,7.594H86.75 l-2.431,14.027V50z"></path>
                  </svg>
            </a></li>
            
            
            <li><a href="https://linkedin.com/in/yanan-zhao-7691317b?trk=hp-identity-photo">
                  <svg id="linkedin" class="custom-icon" version="1.1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" viewBox="0 0 100 100" style="height: 30px; width: 30px;"><circle class="outer-shape" cx="50" cy="50" r="48" style="opacity: 1;"></circle>
                  <path class="inner-shape" style="opacity: 1;" transform="translate(25,25) scale(0.5)" d="M99.001,19.428c-3.606,1.608-7.48,2.695-11.547,3.184c4.15-2.503,7.338-6.466,8.841-11.189 c-3.885,2.318-8.187,4-12.768,4.908c-3.667-3.931-8.893-6.387-14.676-6.387c-11.104,0-20.107,9.054-20.107,20.223 c0,1.585,0.177,3.128,0.52,4.609c-16.71-0.845-31.525-8.895-41.442-21.131C6.092,16.633,5.1,20.107,5.1,23.813 c0,7.017,3.55,13.208,8.945,16.834c-3.296-0.104-6.397-1.014-9.106-2.529c-0.002,0.085-0.002,0.17-0.002,0.255 c0,9.799,6.931,17.972,16.129,19.831c-1.688,0.463-3.463,0.71-5.297,0.71c-1.296,0-2.555-0.127-3.783-0.363 c2.559,8.034,9.984,13.882,18.782,14.045c-6.881,5.424-15.551,8.657-24.971,8.657c-1.623,0-3.223-0.096-4.796-0.282 c8.898,5.738,19.467,9.087,30.82,9.087c36.982,0,57.206-30.817,57.206-57.543c0-0.877-0.02-1.748-0.059-2.617 C92.896,27.045,96.305,23.482,99.001,19.428z"></path>
                  </svg>
            </a></li>
            
            
            <li><a href="https://github.com/ArthurChiao">
                  <svg id="github" class="custom-icon" version="1.1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" viewBox="0 0 100 100" style="height: 30px; width: 30px;"><circle class="outer-shape" cx="50" cy="50" r="48" style="opacity: 1;"></circle>
                  <path class="inner-shape" style="opacity: 1;" transform="translate(25,25) scale(0.5)" d="M50,1C22.938,1,1,22.938,1,50s21.938,49,49,49s49-21.938,49-49S77.062,1,50,1z M79.099,79.099 c-3.782,3.782-8.184,6.75-13.083,8.823c-1.245,0.526-2.509,0.989-3.79,1.387v-7.344c0-3.86-1.324-6.699-3.972-8.517 c1.659-0.16,3.182-0.383,4.57-0.67c1.388-0.287,2.855-0.702,4.402-1.245c1.547-0.543,2.935-1.189,4.163-1.938 c1.228-0.75,2.409-1.723,3.541-2.919s2.082-2.552,2.847-4.067s1.372-3.334,1.818-5.455c0.446-2.121,0.67-4.458,0.67-7.01 c0-4.945-1.611-9.155-4.833-12.633c1.467-3.828,1.308-7.991-0.478-12.489l-1.197-0.143c-0.829-0.096-2.321,0.255-4.474,1.053 c-2.153,0.798-4.57,2.105-7.249,3.924c-3.797-1.053-7.736-1.579-11.82-1.579c-4.115,0-8.039,0.526-11.772,1.579 c-1.69-1.149-3.294-2.097-4.809-2.847c-1.515-0.75-2.727-1.26-3.637-1.532c-0.909-0.271-1.754-0.439-2.536-0.503 c-0.782-0.064-1.284-0.079-1.507-0.048c-0.223,0.031-0.383,0.064-0.478,0.096c-1.787,4.53-1.946,8.694-0.478,12.489 c-3.222,3.477-4.833,7.688-4.833,12.633c0,2.552,0.223,4.889,0.67,7.01c0.447,2.121,1.053,3.94,1.818,5.455 c0.765,1.515,1.715,2.871,2.847,4.067s2.313,2.169,3.541,2.919c1.228,0.751,2.616,1.396,4.163,1.938 c1.547,0.543,3.014,0.957,4.402,1.245c1.388,0.287,2.911,0.511,4.57,0.67c-2.616,1.787-3.924,4.626-3.924,8.517v7.487 c-1.445-0.43-2.869-0.938-4.268-1.53c-4.899-2.073-9.301-5.041-13.083-8.823c-3.782-3.782-6.75-8.184-8.823-13.083 C9.934,60.948,8.847,55.56,8.847,50s1.087-10.948,3.231-16.016c2.073-4.899,5.041-9.301,8.823-13.083s8.184-6.75,13.083-8.823 C39.052,9.934,44.44,8.847,50,8.847s10.948,1.087,16.016,3.231c4.9,2.073,9.301,5.041,13.083,8.823 c3.782,3.782,6.75,8.184,8.823,13.083c2.143,5.069,3.23,10.457,3.23,16.016s-1.087,10.948-3.231,16.016 C85.848,70.915,82.88,75.317,79.099,79.099L79.099,79.099z"></path>
                  </svg>
            </a></li>
             
            
            <li><a href="mailto:arthurchiao@hotmail.com">
                  <svg id="mail" class="custom-icon" version="1.1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" viewBox="0 0 100 100" style="height: 30px; width: 30px;"><circle class="outer-shape" cx="50" cy="50" r="48" style="opacity: 1;"></circle>
                  <path class="inner-shape" style="opacity: 1;" transform="translate(25,25) scale(0.5)" d="M50,1C22.938,1,1,22.938,1,50s21.938,49,49,49s49-21.938,49-49S77.062,1,50,1z M25.5,25.5h49 c0.874,0,1.723,0.188,2.502,0.542L50,57.544L22.998,26.041C23.777,25.687,24.626,25.499,25.5,25.5L25.5,25.5z M19.375,68.375v-36.75 c0-0.128,0.005-0.256,0.014-0.383l17.96,20.953L19.587,69.958C19.448,69.447,19.376,68.916,19.375,68.375L19.375,68.375z M74.5,74.5 h-49c-0.541,0-1.072-0.073-1.583-0.212l17.429-17.429L50,66.956l8.653-10.096l17.429,17.429C75.572,74.427,75.041,74.5,74.5,74.5 L74.5,74.5z M80.625,68.375c0,0.541-0.073,1.072-0.211,1.583L62.652,52.195l17.96-20.953c0.008,0.127,0.014,0.255,0.014,0.383 L80.625,68.375L80.625,68.375z"></path>
                  </svg>
            </a></li>
            
         </ul>
      </div>
   </div>
</div><!-- end .footer -->

   <!-- Add jQuery and other scripts -->
<script src="//ajax.googleapis.com/ajax/libs/jquery/1.11.2/jquery.min.js"></script>
<script>window.jQuery || document.write('<script src=""><\/script>')</script>
<script src="/assets/js/dropcap.min.js"></script>
<script src="/assets/js/responsive-nav.min.js"></script>
<script src="/assets/js/scripts.js"></script>


</body>

</html>
