<!DOCTYPE html>
<!--[if lt IE 7]><html class="no-js lt-ie9 lt-ie8 lt-ie7"><![endif]-->
<!--[if IE 7]><html class="no-js lt-ie9 lt-ie8" <![endif]-->
<!--[if IE 8]><html class="no-js lt-ie9" <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js"> <!--<![endif]-->

<head>
    <!-- Google Tag Manager -->
    <script>(function(w,d,s,l,i){w[l]=w[l]||[];w[l].push({'gtm.start':
       new Date().getTime(),event:'gtm.js'});var f=d.getElementsByTagName(s)[0],
       j=d.createElement(s),dl=l!='dataLayer'?'&l='+l:'';j.async=true;j.src=
       'https://www.googletagmanager.com/gtm.js?id='+i+dl;f.parentNode.insertBefore(j,f);
       })(window,document,'script','dataLayer','GTM-WP54B9K');</script>
    <!-- End Google Tag Manager -->

    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="description" content="">
    <title>tcpdump/wireshark抓包及分析</title>

    <!-- Favicon -->
    <link rel="icon" type="image/x-icon" href="/assets/img/favicon.ico" />

    <!-- Come and get me RSS readers -->
    <link rel="alternate" type="application/rss+xml" title="ArthurChiao's Blog" href="http://0.0.0.0:4000/feed.xml" />
    
    <!-- Stylesheet -->
    <link rel="stylesheet" href="/assets/css/style.css">
    <!--[if IE 8]><link rel="stylesheet" href="/assets/css/ie.css"><![endif]-->
    <link rel="canonical" href="http://0.0.0.0:4000/blog/tcpdump-practice-zh/">

    <!-- Modernizr -->
    <script src="/assets/js/modernizr.custom.15390.js" type="text/javascript"></script>

    
</head>


<body>
  <!-- Google Tag Manager (noscript) -->
  <noscript><iframe src="https://www.googletagmanager.com/ns.html?id=GTM-WP54B9K"
    height="0" width="0" style="display:none;visibility:hidden"></iframe></noscript>
  <!-- End Google Tag Manager (noscript) -->

    <div class="header">
     <div class="container">
         <h1 class="logo"><a href="/">ArthurChiao's Blog</a></h1>
         <nav class="nav-collapse">
             <ul class="noList">
                 
                   
                   
                   <li class="element first  ">
                     <a href="/index.html">Home</a>
                   </li> 
                 
                   
                   
                   <li class="element   ">
                     <a href="/articles">Articles</a>
                   </li> 
                 
                   
                   
                   <li class="element   ">
                     <a href="/articles-zh">Articles (中文)</a>
                   </li> 
                 
                   
                   
                   <li class="element   ">
                     <a href="/categories">Categories</a>
                   </li> 
                 
                   
                   
                   <li class="element   last">
                     <a href="/about">About</a>
                   </li> 
                 
                 <!-- <li> <a href="https://github.com/arthurchiao/reading" target="_blank">Reading</a></li> -->
                 <!-- <li> <a href="https://github.com/arthurchiao/" target="_blank">GitHub</a></li> -->
             </ul>
         </nav>
     </div>
 </div><!-- end .header -->


   <div class="content">
      <div class="container">
         <div class="post">
  
  <h1 class="postTitle">tcpdump/wireshark抓包及分析</h1>
  <p class="meta">2018-12-14 | <span class="time">11</span> Minute Read</p>

  
  
  <p>本文将展示如何使用tcpdump抓包，以及如何用tcpdump和wireshark分析网络流量。
文中的例子比较简单，适合作为入门参考。</p>

<h2 id="1-基础环境准备">1 基础环境准备</h2>

<p>为方便大家跟着上手练习，本文将搭建一个容器环境。</p>

<h3 id="11-pull-docker镜像">1.1 Pull Docker镜像</h3>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span><span class="nb">sudo </span>docker pull alpine:3.8
</code></pre></div></div>

<h3 id="12-运行容器">1.2 运行容器</h3>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span><span class="nb">sudo </span>docker run <span class="nt">-d</span> <span class="nt">--name</span> ctn-1 alpine:3.8 <span class="nb">sleep </span>3600d
<span class="nv">$ </span><span class="nb">sudo </span>docker ps
CONTAINER ID    IMAGE        COMMAND         CREATED        STATUS          PORTS  NAMES
233bc36bde4b    alpine:3.8   <span class="s2">"sleep 3600d"</span>   1 minutes ago  Up 14 minutes           ctn-1
</code></pre></div></div>

<p>进入容器：</p>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span><span class="nb">sudo </span>docker <span class="nb">exec</span> <span class="nt">-it</span> ctn-1 sh
</code></pre></div></div>

<p>查看容器网络信息：</p>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code>/ <span class="c"># ifconfig</span>
eth0      Link encap:Ethernet  HWaddr 02:42:AC:11:00:09
          inet addr:172.17.0.9  Bcast:0.0.0.0  Mask:255.255.0.0
</code></pre></div></div>

<h3 id="13-安装tcpdump">1.3 安装tcpdump</h3>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code>/ <span class="c"># apk update</span>
/ <span class="c"># apk add tcpdump</span>
</code></pre></div></div>

<h2 id="2-httptcp抓包">2 HTTP/TCP抓包</h2>

<p>接下来我们用wget获取一个网站的首页文件（index.html），同时tcpdump抓包，对抓到的
网络流量进行分析。</p>

<h3 id="21-http请求下载测试页面">2.1 HTTP请求：下载测试页面</h3>

<p><a href="www.example.com">example.com</a>是一个测试网站，wget是一个linux下面的命令行工具，
可以下载网络文件。</p>

<p>如下命令可以下载一个example.com网站的首页文件index.html：</p>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code>/ <span class="c"># wget http://example.com</span>
Connecting to example.com <span class="o">(</span>93.184.216.34:80<span class="o">)</span>
index.html           100% |<span class="k">*****************************</span>|  1270   0:00:00 ETA
</code></pre></div></div>

<p>虽然这看起来极其简单，但背后却涵盖了很多复杂的过程，例如：</p>

<ol>
  <li><strong>域名查找</strong>：通过访问DNS服务查找<code class="highlighter-rouge">example.com</code>服务器对应的IP地址</li>
  <li><strong>TCP连接参数初始化</strong>：临时端口、初始序列号的选择等等</li>
  <li>客户端（容器）通过<strong>TCP三次握手协议</strong>和服务器IP建立TCP连接</li>
  <li>客户端发起HTTP GET请求</li>
  <li>服务器返回HTTP响应，包含页面数据传输</li>
  <li>如果页面超过一个MTU，会分为多个packet进行传输（后面会看到，确实超过MTU了）</li>
  <li>TCP断开连接的<strong>四次挥手</strong></li>
</ol>

<h3 id="22-抓包打到标准输出">2.2 抓包：打到标准输出</h3>

<p>用下面的tcpdump命令抓包，另一窗口执行<code class="highlighter-rouge">wget http://example.com</code>，能看到如下类似
的输出。为了方便后面的讨论，这里将一些字段去掉了，并做了适当的对齐：</p>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code>/ <span class="c"># tcpdump -n -S -i eth0 host example.com</span>
1  02:52:44.513700 IP 172.17.0.9.41038 <span class="o">&gt;</span> 93.184.216.34.80: Flags <span class="o">[</span>S] , <span class="nb">seq </span>3310420140,                            length 0
2  02:52:44.692890 IP 93.184.216.34.80 <span class="o">&gt;</span> 172.17.0.9.41038: Flags <span class="o">[</span>S.], <span class="nb">seq </span>1353235534,            ack 3310420141, length 0
3  02:52:44.692953 IP 172.17.0.9.41038 <span class="o">&gt;</span> 93.184.216.34.80: Flags <span class="o">[</span>.] ,                            ack 1353235535, length 0
4  02:52:44.693009 IP 172.17.0.9.41038 <span class="o">&gt;</span> 93.184.216.34.80: Flags <span class="o">[</span>P.], <span class="nb">seq </span>3310420141:3310420215, ack 1353235535, length 74: HTTP: GET / HTTP/1.1
5  02:52:44.872266 IP 93.184.216.34.80 <span class="o">&gt;</span> 172.17.0.9.41038: Flags <span class="o">[</span>.] ,                            ack 3310420215, length 0
6  02:52:44.873342 IP 93.184.216.34.80 <span class="o">&gt;</span> 172.17.0.9.41038: Flags <span class="o">[</span>.] , <span class="nb">seq </span>1353235535:1353236983, ack 3310420215, length 1448: HTTP: HTTP/1.1 200 OK
7  02:52:44.873405 IP 172.17.0.9.41038 <span class="o">&gt;</span> 93.184.216.34.80: Flags <span class="o">[</span>.] ,                            ack 1353236983, length 0
8  02:52:44.874533 IP 93.184.216.34.80 <span class="o">&gt;</span> 172.17.0.9.41038: Flags <span class="o">[</span>P.], <span class="nb">seq </span>1353236983:1353237162, ack 3310420215, length 179: HTTP
9  02:52:44.874560 IP 172.17.0.9.41038 <span class="o">&gt;</span> 93.184.216.34.80: Flags <span class="o">[</span>.] ,                            ack 1353237162, length 0
10 02:52:44.874705 IP 172.17.0.9.41038 <span class="o">&gt;</span> 93.184.216.34.80: Flags <span class="o">[</span>F.], <span class="nb">seq </span>3310420215,            ack 1353237162, length 0
11 02:52:45.053732 IP 93.184.216.34.80 <span class="o">&gt;</span> 172.17.0.9.41038: Flags <span class="o">[</span>.] ,                            ack 3310420216, length 0
12 02:52:45.607825 IP 93.184.216.34.80 <span class="o">&gt;</span> 172.17.0.9.41038: Flags <span class="o">[</span>F.], <span class="nb">seq </span>1353237162,            ack 3310420216, length 0
13 02:52:45.607869 IP 172.17.0.9.41038 <span class="o">&gt;</span> 93.184.216.34.80: Flags <span class="o">[</span>.] ,                            ack 1353237163, length 0
</code></pre></div></div>

<p>参数说明：</p>

<ul>
  <li><code class="highlighter-rouge">-n</code>：打印IP而不是hostname，打印端口号而不是协议（例如打印80而不是http）</li>
  <li><code class="highlighter-rouge">-S</code>：打印绝对时间戳</li>
  <li><code class="highlighter-rouge">-i eth0</code>：指定从eth0网卡抓包</li>
  <li><code class="highlighter-rouge">host example.com</code>：抓和<code class="highlighter-rouge">example.com</code>通信的包（双向）</li>
</ul>

<p>更多tcpdump的常用命令，可以参考<a href="https://arthurchiao.github.io/blog/tcpdump/">tcpdump: An Incomplete
Guide</a>。</p>

<h3 id="23-抓包存文件">2.3 抓包：存文件</h3>

<p><code class="highlighter-rouge">-w</code>命令可以将抓到的包写到文件，注意这和用重定向方式将输出写到文件是不同的。
后者写的只是标准输出打印的LOG，而<code class="highlighter-rouge">-w</code>写的是原始包。</p>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code>/ <span class="c"># tcpdump -i eth0 host example.com -w example.pcap</span>
^C
13 packets captured
13 packets received by filter
0 packets dropped by kernel
</code></pre></div></div>

<p>生成的pcap文件可以用<code class="highlighter-rouge">tcpdump</code>或者<code class="highlighter-rouge">wireshark</code>之类的网络流量分析工具打开。</p>

<h2 id="3-流量分析-tcpdump">3 流量分析: tcpdump</h2>

<p>如果不指定输出的话，tcpdump会直接将信息打到标准输出，就是我们上面看到的那样。从
这些输出里，我们看到很多信息。</p>

<h3 id="31-每列说明">3.1 每列说明</h3>

<p>第1列是为了讨论方便而加的行号，实际的tcpdump输出并没有这一列。接下来将用<code class="highlighter-rouge">#</code>号加
数字表示第几个包，例如<code class="highlighter-rouge">#3</code>表示第3个包。</p>

<p>接下来依次为：</p>

<ul>
  <li>packet<strong>时间戳</strong>，例如<code class="highlighter-rouge">02:52:44.513700</code>表示抓到这个包的时间是<strong>02时52分44秒513毫秒</strong></li>
  <li>packet<strong>类型</strong>，这里是<code class="highlighter-rouge">IP</code>包</li>
  <li>源(SRC) IP和端口，目的(DST) IP和端口</li>
  <li>packet TCP flags，其中
    <ul>
      <li><code class="highlighter-rouge">S</code>表示<code class="highlighter-rouge">syn</code>包</li>
      <li><code class="highlighter-rouge">.</code>表示<code class="highlighter-rouge">ack</code>包</li>
      <li><code class="highlighter-rouge">F</code>表示<code class="highlighter-rouge">fin</code>包</li>
      <li><code class="highlighter-rouge">P</code>表示<code class="highlighter-rouge">push</code>包（发送正常数据）</li>
    </ul>
  </li>
  <li>序列号（seq）</li>
  <li>应答号（ack）</li>
  <li>包的payload长度</li>
  <li>包的部分内容（ASCII）</li>
</ul>

<h3 id="32-三次握手13">3.2 三次握手（1～3）</h3>

<p>wget是基于HTTP协议，因此它在下载文件之前，必定要和服务端建立一个连接。</p>

<p>而TCP建立连接的过程就是著名的<strong>三次握手</strong> [4]：</p>

<ol>
  <li>client -&gt; server: SYN</li>
  <li>server -&gt; client: SYN+ACK</li>
  <li>client -&gt; server: ACK</li>
</ol>

<p>我们可以看到，这刚好对应于前三个包：</p>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code>1  02:52:44.513700 IP 172.17.0.9.41038 <span class="o">&gt;</span> 93.184.216.34.80: Flags <span class="o">[</span>S] , <span class="nb">seq </span>3310420140,                 length 0
2  02:52:44.692890 IP 93.184.216.34.80 <span class="o">&gt;</span> 172.17.0.9.41038: Flags <span class="o">[</span>S.], <span class="nb">seq </span>1353235534, ack 3310420141, length 0
3  02:52:44.692953 IP 172.17.0.9.41038 <span class="o">&gt;</span> 93.184.216.34.80: Flags <span class="o">[</span>.] ,                 ack 1353235535, length 0
</code></pre></div></div>

<h4 id="第一次握手-syn">第一次握手: SYN</h4>

<p><code class="highlighter-rouge">#1</code>包含以下信息：</p>

<ol>
  <li><code class="highlighter-rouge">02:52:44.513700</code>时刻，客户端主动向server（93.184.216.34）发起一个SYN请求，请求建立连接</li>
  <li>客户端请求的<strong>服务端端口是80</strong>（HTTP服务默认80端口），客户端使用的是<strong>临时端口</strong>（大于1024）41038</li>
  <li><code class="highlighter-rouge">#1</code> 序列号是<code class="highlighter-rouge">3310420140</code>，这是客户端的初始序列号（客户端和服务端分别维护自己的序列号，两者没有关系；另外，初始序列号是系统选择的，一般不是0）</li>
  <li><code class="highlighter-rouge">#1</code> length为0，因为SYN包不带TCP payload，所有信息都在TCP header</li>
</ol>

<h4 id="第二次握手-synack">第二次握手: SYN+ACK</h4>

<p><code class="highlighter-rouge">#2</code>的ack是<code class="highlighter-rouge">3310420140</code>，等于<code class="highlighter-rouge">#1</code>的seq加1，这就说明，<code class="highlighter-rouge">#2</code>是<code class="highlighter-rouge">#1</code>的应答包。</p>

<p>这个应答包的特点：</p>

<ol>
  <li>TCP flags为<code class="highlighter-rouge">S.</code>，即SYN+ACK</li>
  <li>length也是0，说明没有payload</li>
  <li>seq为<code class="highlighter-rouge">1353235534</code>，这是<strong>服务端的初始序列号</strong></li>
  <li>到达eth0的时间为<code class="highlighter-rouge">02:52:44.692890</code>，说明时间过了<code class="highlighter-rouge">18ms</code></li>
</ol>

<h4 id="第三次握手-ack">第三次握手: ACK</h4>

<p>同理，<code class="highlighter-rouge">#3</code>的ack等于<code class="highlighter-rouge">#2</code>的seq加1，说明<code class="highlighter-rouge">#3</code>是<code class="highlighter-rouge">#2</code>的应答包。</p>

<p>这个包的特点：</p>

<ol>
  <li>TCP flags为<code class="highlighter-rouge">.</code>，即ACK</li>
  <li>长度为0，说明没有TCP payload</li>
</ol>

<p>至此，三次握手完成。</p>

<h3 id="33-正常数据传输">3.3 正常数据传输</h3>

<p>三次握手完成后，client和server开始HTTP通信，客户端通过HTTP GET方法下载index.html。</p>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code>4  02:52:44.693009 IP 172.17.0.9.41038 <span class="o">&gt;</span> 93.184.216.34.80: Flags <span class="o">[</span>P.], <span class="nb">seq </span>3310420141:3310420215, ack 1353235535, length 74: HTTP: GET / HTTP/1.1
5  02:52:44.872266 IP 93.184.216.34.80 <span class="o">&gt;</span> 172.17.0.9.41038: Flags <span class="o">[</span>.] ,                            ack 3310420215, length 0
6  02:52:44.873342 IP 93.184.216.34.80 <span class="o">&gt;</span> 172.17.0.9.41038: Flags <span class="o">[</span>.] , <span class="nb">seq </span>1353235535:1353236983, ack 3310420215, length 1448: HTTP: HTTP/1.1 200 OK
7  02:52:44.873405 IP 172.17.0.9.41038 <span class="o">&gt;</span> 93.184.216.34.80: Flags <span class="o">[</span>.] ,                            ack 1353236983, length 0
8  02:52:44.874533 IP 93.184.216.34.80 <span class="o">&gt;</span> 172.17.0.9.41038: Flags <span class="o">[</span>P.], <span class="nb">seq </span>1353236983:1353237162, ack 3310420215, length 179: HTTP
9  02:52:44.874560 IP 172.17.0.9.41038 <span class="o">&gt;</span> 93.184.216.34.80: Flags <span class="o">[</span>.] ,                            ack 1353237162, length 0
</code></pre></div></div>

<p>这里可以看到：</p>

<ol>
  <li><code class="highlighter-rouge">#4</code>: client向server发起HTTP GET请求，请求路径为根路径（<code class="highlighter-rouge">/</code>），这个packet长度为74字节</li>
  <li><code class="highlighter-rouge">#5</code>: 发送了ACK包，对<code class="highlighter-rouge">#4</code>进行确认</li>
  <li><code class="highlighter-rouge">#6</code>: 发送了1448字节的数据给client</li>
  <li><code class="highlighter-rouge">#7</code>: client对server的<code class="highlighter-rouge">#6</code>进行应答</li>
  <li><code class="highlighter-rouge">#8</code>: server向client端继续发送179字节数据</li>
  <li><code class="highlighter-rouge">#9</code>: client对server的<code class="highlighter-rouge">#8</code>进行应答</li>
</ol>

<h3 id="34-四次挥手">3.4 四次挥手</h3>

<p>最后是四次挥手 [5]：</p>

<ol>
  <li>client -&gt; server: FIN （我们看到的是FIN+ACK，这是因为这个FIN包除了正常的关闭连接功能之外，还被用于应答client发过来的前一个包）</li>
  <li>server -&gt; client: ACK</li>
  <li>client -&gt; server: FIN+ACK</li>
  <li>server -&gt; client: ACK</li>
</ol>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code>10 02:52:44.874705 IP 172.17.0.9.41038 <span class="o">&gt;</span> 93.184.216.34.80: Flags <span class="o">[</span>F.], <span class="nb">seq </span>3310420215, ack 1353237162, length 0
11 02:52:45.053732 IP 93.184.216.34.80 <span class="o">&gt;</span> 172.17.0.9.41038: Flags <span class="o">[</span>.] ,                 ack 3310420216, length 0
12 02:52:45.607825 IP 93.184.216.34.80 <span class="o">&gt;</span> 172.17.0.9.41038: Flags <span class="o">[</span>F.], <span class="nb">seq </span>1353237162, ack 3310420216, length 0
13 02:52:45.607869 IP 172.17.0.9.41038 <span class="o">&gt;</span> 93.184.216.34.80: Flags <span class="o">[</span>.] ,                 ack 1353237163, length 0
</code></pre></div></div>

<h2 id="4-流量分析-wireshark">4 流量分析: wireshark</h2>

<p>tcpdump可以指定<code class="highlighter-rouge">-r</code>读取pcap文件，并以指定的格式输出包的信息，最后输出的内容和上
面看到的类似。我们上面的流量非常简单，所以看tcpdump的输出就够了。</p>

<p>对于复杂的pcap，例如，其中包含了上百个IP地址、上千个端口、上万个连接的pcap，只通
过看tcpdump输出就非常低效了。</p>

<p>这时，<a href="https://www.wireshark.org">wireshark</a>这样带图形用户界面，且功能强大的网
络流分析工具就派上了用场。</p>

<p>wireshark支持强大的过滤功能，支持按IP、端口、协议、连接、TCP flag以及它们的各种
组合进行过滤，然后进行分析，大大节省网络排障的时间。</p>

<p>wireshark官方维护了一个sample pcap<a href="https://wiki.wireshark.org/SampleCapturesA">列表
</a>，我们拿
<a href="https://wiki.wireshark.org/SampleCaptures?action=AttachFile&amp;do=get&amp;target=iperf-mptcp-0-0.pcap">iperf-mptcp-0-0.pcap</a>
作为例子来展示如何使用wireshark。</p>

<h3 id="41-追踪tcp流">4.1 追踪TCP流</h3>

<p>下载后双击就可以用wireshark打开。看到有重传（TCP Retransmition）的包：</p>

<p align="center"><img src="/assets/img/tcpdump-practice/retrans.jpg" width="80%" height="80%" /></p>

<p>在重传的包上，<code class="highlighter-rouge">右键 -&gt; Follow -&gt; TCP Stream</code>，会过滤出<strong>只属于这个连接的包</strong>：</p>

<p align="center"><img src="/assets/img/tcpdump-practice/retrans-stream.jpg" width="80%" height="80%" /></p>

<p>我们看到，这个连接只有3个包：</p>

<ol>
  <li><code class="highlighter-rouge">#1</code>在<code class="highlighter-rouge">08:00:05.125</code>发送出去，请求建立连接</li>
  <li>大约<code class="highlighter-rouge">1s</code>后，客户端仍然没有收到服务端的ACK包，触发客户端<strong>TCP超时重传</strong></li>
  <li>又过了大约<code class="highlighter-rouge">2s</code>，仍然没有收到ACK包，<strong>再次触发超时重传</strong></li>
  <li>这里其实还可以看出TCP重传的机制：<strong>指数后退</strong>，比如第一次等待1s，第二次等待2s
，第三次等待4s，第四次8s</li>
</ol>

<p>因此，从这个抓包文件看，这次连接没有建立起来，而直接原因就是client没有收到server
的应答包。要跟进这个问题，就需要在server端一起抓包，看应答包是否有发出来。本文不
对此展开。</p>

<h3 id="42-过滤流">4.2 过滤流</h3>

<p>上面的截图我们看到wireshark里有<code class="highlighter-rouge">tcp.stream eq 1</code>，这其实就是其强大的过滤表达式。</p>

<p>我们可以直接手写表达式，然后回车，符合条件的包就会显示出来。而且，在编辑表达式的
时候，wireshark有自动提示，还是比较方便的。这些表达式和tcpdump的filter表达式很类
似，如果熟悉tcpdump，那这里不会有太大困难。</p>

<p>下面举一些例子：</p>

<ol>
  <li><code class="highlighter-rouge">ip.addr == 192.168.1.1</code> 过滤SRC IP<strong>或</strong>DST IP是<code class="highlighter-rouge">192.168.1.1</code>的包</li>
  <li><code class="highlighter-rouge">ip.src_host == 192.168.1.1 and ip.dst_host == 192.168.1.2</code> 过滤SRC IP是
<code class="highlighter-rouge">192.168.1.1</code>，并且DST IP是<code class="highlighter-rouge">192.168.1.2</code>的包</li>
  <li><code class="highlighter-rouge">tcp.port == 80</code> 源端口或目的端口是80的包</li>
  <li><code class="highlighter-rouge">tcp.flags.reset == 1</code> 过滤TCP RST包。先找到RST包，然后右键Follow -&gt; TCP
Stream是常用的排障方式</li>
  <li><code class="highlighter-rouge">tcp.analysis.retransmission</code> 过滤所有的重传包</li>
</ol>

<h3 id="43-导出符合条件的包">4.3 导出符合条件的包</h3>

<p>有时pcap文件太大，导致wireshark非常慢，而大部分数据包可能是不需要的。在这种情况
下，可以先用过滤条件筛选出感兴趣的包，然后<code class="highlighter-rouge">File -&gt; Export Specified Packets ...</code>
，弹出的对话框里，可以选择当前显示的包，或者某个指定区间的包另存为新pcap。</p>

<p>然后就可以关闭原来的pcap，打开新的pcap进行分析。</p>

<h2 id="5-总结">5 总结</h2>

<p>tcpdump和wireshark功能非常强大，组合起来更是网络排障的首选利器。这里介绍的内容只
是九牛一毛，更多的时候，你需要 <strong>tcpdump+wireshark+google</strong>。</p>

<h2 id="references">References</h2>

<ol>
  <li><a href="https://www.tcpdump.org/manpages/tcpdump.1.html">Man Page of tcpdump</a></li>
  <li><a href="https://www.wireshark.org">Wireshark</a></li>
  <li><a href="https://wiki.wireshark.org/SampleCapturesA">Wireshark: Sample Pcaps</a></li>
  <li><a href="https://en.wikipedia.org/wiki/Handshaking#TCP_three-way_handshake">TCP 3-way Handshaking</a></li>
  <li><a href="https://wiki.wireshark.org/TCP%204-times%20close">TCP 4-times Close</a></li>
</ol>


  <!-- POST NAVIGATION -->
  <div class="postNav clearfix">
     
      <a class="prev" href="/blog/tuning-stack-rx-zh-5/"><span>&laquo;&nbsp;[译] Linux网络栈监控和调优：接收数据 5</span>
      
    </a>
      
      
      <a class="next" href="/blog/dns-practice-zh/"><span>DNS问题分析示例&nbsp;&raquo;</span>
       
      </a>
     
  </div>
</div>


         

      </div>
   </div><!-- end .content -->

   <div class="footer">
   <div class="container">
      <p class="copy">&copy; 2016-2019
      <a href="https://arthurchiao.github.io">Arthur Chiao</a>, Powered by
      <a href="http://jekyllrb.com">Jekyll </a>, Theme originated from
      <a href="https://github.com/brianmaierjr/long-haul"> Long Haul.</a>

      <script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>
      <span id="busuanzi_container_site_pv"> Site visits:
          <span id="busuanzi_value_site_pv"></span>, powered by<a href="http://busuanzi.ibruce.info/"> busuanzi</a>
      </span>

      </p>

      <div class="footer-links"> 
         <ul class="noList"> 
            
            <li><a href="https://www.facebook.com/profile.php?id=100014334455077">
                  <svg id="facebook-square" class="custom-icon" version="1.1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" viewBox="0 0 100 100" style="height: 30px; width: 30px;"><circle class="outer-shape" cx="50" cy="50" r="48" style="opacity: 1;"></circle>
                  <path class="inner-shape" style="opacity: 1;" transform="translate(25,25) scale(0.5)" d="M82.667,1H17.335C8.351,1,1,8.351,1,17.336v65.329c0,8.99,7.351,16.335,16.334,16.335h65.332 C91.652,99.001,99,91.655,99,82.665V17.337C99,8.353,91.652,1.001,82.667,1L82.667,1z M84.318,50H68.375v42.875H50V50h-8.855V35.973 H50v-9.11c0-12.378,5.339-19.739,19.894-19.739h16.772V22.3H72.967c-4.066-0.007-4.57,2.12-4.57,6.078l-0.023,7.594H86.75 l-2.431,14.027V50z"></path>
                  </svg>
            </a></li>
            
            
            <li><a href="https://linkedin.com/in/yanan-zhao-7691317b?trk=hp-identity-photo">
                  <svg id="linkedin" class="custom-icon" version="1.1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" viewBox="0 0 100 100" style="height: 30px; width: 30px;"><circle class="outer-shape" cx="50" cy="50" r="48" style="opacity: 1;"></circle>
                  <path class="inner-shape" style="opacity: 1;" transform="translate(25,25) scale(0.5)" d="M99.001,19.428c-3.606,1.608-7.48,2.695-11.547,3.184c4.15-2.503,7.338-6.466,8.841-11.189 c-3.885,2.318-8.187,4-12.768,4.908c-3.667-3.931-8.893-6.387-14.676-6.387c-11.104,0-20.107,9.054-20.107,20.223 c0,1.585,0.177,3.128,0.52,4.609c-16.71-0.845-31.525-8.895-41.442-21.131C6.092,16.633,5.1,20.107,5.1,23.813 c0,7.017,3.55,13.208,8.945,16.834c-3.296-0.104-6.397-1.014-9.106-2.529c-0.002,0.085-0.002,0.17-0.002,0.255 c0,9.799,6.931,17.972,16.129,19.831c-1.688,0.463-3.463,0.71-5.297,0.71c-1.296,0-2.555-0.127-3.783-0.363 c2.559,8.034,9.984,13.882,18.782,14.045c-6.881,5.424-15.551,8.657-24.971,8.657c-1.623,0-3.223-0.096-4.796-0.282 c8.898,5.738,19.467,9.087,30.82,9.087c36.982,0,57.206-30.817,57.206-57.543c0-0.877-0.02-1.748-0.059-2.617 C92.896,27.045,96.305,23.482,99.001,19.428z"></path>
                  </svg>
            </a></li>
            
            
            <li><a href="https://github.com/ArthurChiao">
                  <svg id="github" class="custom-icon" version="1.1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" viewBox="0 0 100 100" style="height: 30px; width: 30px;"><circle class="outer-shape" cx="50" cy="50" r="48" style="opacity: 1;"></circle>
                  <path class="inner-shape" style="opacity: 1;" transform="translate(25,25) scale(0.5)" d="M50,1C22.938,1,1,22.938,1,50s21.938,49,49,49s49-21.938,49-49S77.062,1,50,1z M79.099,79.099 c-3.782,3.782-8.184,6.75-13.083,8.823c-1.245,0.526-2.509,0.989-3.79,1.387v-7.344c0-3.86-1.324-6.699-3.972-8.517 c1.659-0.16,3.182-0.383,4.57-0.67c1.388-0.287,2.855-0.702,4.402-1.245c1.547-0.543,2.935-1.189,4.163-1.938 c1.228-0.75,2.409-1.723,3.541-2.919s2.082-2.552,2.847-4.067s1.372-3.334,1.818-5.455c0.446-2.121,0.67-4.458,0.67-7.01 c0-4.945-1.611-9.155-4.833-12.633c1.467-3.828,1.308-7.991-0.478-12.489l-1.197-0.143c-0.829-0.096-2.321,0.255-4.474,1.053 c-2.153,0.798-4.57,2.105-7.249,3.924c-3.797-1.053-7.736-1.579-11.82-1.579c-4.115,0-8.039,0.526-11.772,1.579 c-1.69-1.149-3.294-2.097-4.809-2.847c-1.515-0.75-2.727-1.26-3.637-1.532c-0.909-0.271-1.754-0.439-2.536-0.503 c-0.782-0.064-1.284-0.079-1.507-0.048c-0.223,0.031-0.383,0.064-0.478,0.096c-1.787,4.53-1.946,8.694-0.478,12.489 c-3.222,3.477-4.833,7.688-4.833,12.633c0,2.552,0.223,4.889,0.67,7.01c0.447,2.121,1.053,3.94,1.818,5.455 c0.765,1.515,1.715,2.871,2.847,4.067s2.313,2.169,3.541,2.919c1.228,0.751,2.616,1.396,4.163,1.938 c1.547,0.543,3.014,0.957,4.402,1.245c1.388,0.287,2.911,0.511,4.57,0.67c-2.616,1.787-3.924,4.626-3.924,8.517v7.487 c-1.445-0.43-2.869-0.938-4.268-1.53c-4.899-2.073-9.301-5.041-13.083-8.823c-3.782-3.782-6.75-8.184-8.823-13.083 C9.934,60.948,8.847,55.56,8.847,50s1.087-10.948,3.231-16.016c2.073-4.899,5.041-9.301,8.823-13.083s8.184-6.75,13.083-8.823 C39.052,9.934,44.44,8.847,50,8.847s10.948,1.087,16.016,3.231c4.9,2.073,9.301,5.041,13.083,8.823 c3.782,3.782,6.75,8.184,8.823,13.083c2.143,5.069,3.23,10.457,3.23,16.016s-1.087,10.948-3.231,16.016 C85.848,70.915,82.88,75.317,79.099,79.099L79.099,79.099z"></path>
                  </svg>
            </a></li>
             
            
            <li><a href="mailto:arthurchiao@hotmail.com">
                  <svg id="mail" class="custom-icon" version="1.1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" viewBox="0 0 100 100" style="height: 30px; width: 30px;"><circle class="outer-shape" cx="50" cy="50" r="48" style="opacity: 1;"></circle>
                  <path class="inner-shape" style="opacity: 1;" transform="translate(25,25) scale(0.5)" d="M50,1C22.938,1,1,22.938,1,50s21.938,49,49,49s49-21.938,49-49S77.062,1,50,1z M25.5,25.5h49 c0.874,0,1.723,0.188,2.502,0.542L50,57.544L22.998,26.041C23.777,25.687,24.626,25.499,25.5,25.5L25.5,25.5z M19.375,68.375v-36.75 c0-0.128,0.005-0.256,0.014-0.383l17.96,20.953L19.587,69.958C19.448,69.447,19.376,68.916,19.375,68.375L19.375,68.375z M74.5,74.5 h-49c-0.541,0-1.072-0.073-1.583-0.212l17.429-17.429L50,66.956l8.653-10.096l17.429,17.429C75.572,74.427,75.041,74.5,74.5,74.5 L74.5,74.5z M80.625,68.375c0,0.541-0.073,1.072-0.211,1.583L62.652,52.195l17.96-20.953c0.008,0.127,0.014,0.255,0.014,0.383 L80.625,68.375L80.625,68.375z"></path>
                  </svg>
            </a></li>
            
         </ul>
      </div>
   </div>
</div><!-- end .footer -->

   <!-- Add jQuery and other scripts -->
<script src="//ajax.googleapis.com/ajax/libs/jquery/1.11.2/jquery.min.js"></script>
<script>window.jQuery || document.write('<script src=""><\/script>')</script>
<script src="/assets/js/dropcap.min.js"></script>
<script src="/assets/js/responsive-nav.min.js"></script>
<script src="/assets/js/scripts.js"></script>


</body>

</html>
