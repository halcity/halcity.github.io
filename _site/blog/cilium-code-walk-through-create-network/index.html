<!DOCTYPE html>
<!--[if lt IE 7]><html class="no-js lt-ie9 lt-ie8 lt-ie7"><![endif]-->
<!--[if IE 7]><html class="no-js lt-ie9 lt-ie8" <![endif]-->
<!--[if IE 8]><html class="no-js lt-ie9" <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js"> <!--<![endif]-->

<head>
    <!-- Google Tag Manager -->
    <script>(function(w,d,s,l,i){w[l]=w[l]||[];w[l].push({'gtm.start':
       new Date().getTime(),event:'gtm.js'});var f=d.getElementsByTagName(s)[0],
       j=d.createElement(s),dl=l!='dataLayer'?'&l='+l:'';j.async=true;j.src=
       'https://www.googletagmanager.com/gtm.js?id='+i+dl;f.parentNode.insertBefore(j,f);
       })(window,document,'script','dataLayer','GTM-WP54B9K');</script>
    <!-- End Google Tag Manager -->

    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="description" content="">
    <title>Cilium Code Walk Through: CNI Create Network</title>

    <!-- Favicon -->
    <link rel="icon" type="image/x-icon" href="/assets/img/favicon.ico" />

    <!-- Come and get me RSS readers -->
    <link rel="alternate" type="application/rss+xml" title="ArthurChiao's Blog" href="http://0.0.0.0:4000/feed.xml" />
    
    <!-- Stylesheet -->
    <link rel="stylesheet" href="/assets/css/style.css">
    <!--[if IE 8]><link rel="stylesheet" href="/assets/css/ie.css"><![endif]-->
    <link rel="canonical" href="http://0.0.0.0:4000/blog/cilium-code-walk-through-create-network/">

    <!-- Modernizr -->
    <script src="/assets/js/modernizr.custom.15390.js" type="text/javascript"></script>

    
</head>


<body>
  <!-- Google Tag Manager (noscript) -->
  <noscript><iframe src="https://www.googletagmanager.com/ns.html?id=GTM-WP54B9K"
    height="0" width="0" style="display:none;visibility:hidden"></iframe></noscript>
  <!-- End Google Tag Manager (noscript) -->

    <div class="header">
     <div class="container">
         <h1 class="logo"><a href="/">ArthurChiao's Blog</a></h1>
         <nav class="nav-collapse">
             <ul class="noList">
                 
                   
                   
                   <li class="element first  ">
                     <a href="/index.html">Home</a>
                   </li> 
                 
                   
                   
                   <li class="element   ">
                     <a href="/articles">Articles</a>
                   </li> 
                 
                   
                   
                   <li class="element   ">
                     <a href="/articles-zh">Articles (中文)</a>
                   </li> 
                 
                   
                   
                   <li class="element   ">
                     <a href="/categories">Categories</a>
                   </li> 
                 
                   
                   
                   <li class="element   last">
                     <a href="/about">About</a>
                   </li> 
                 
                 <!-- <li> <a href="https://github.com/arthurchiao/reading" target="_blank">Reading</a></li> -->
                 <!-- <li> <a href="https://github.com/arthurchiao/" target="_blank">GitHub</a></li> -->
             </ul>
         </nav>
     </div>
 </div><!-- end .header -->


   <div class="content">
      <div class="container">
         <div class="post">
  
  <h1 class="postTitle">Cilium Code Walk Through: CNI Create Network</h1>
  <p class="meta">2019-02-08 | <span class="time">114</span> Minute Read</p>

  
  
  <h3 id="tldr">TL;DR</h3>

<p>This post describes how Cilium CNI plugin works. Specifically, we will examine
the calling flows when K8S creates a container and asks plugin for setting up
network for the container. This includes, but not limited to:</p>

<ol>
  <li>create link device (e.g. veth pair)</li>
  <li>allocate IP for container</li>
  <li>configure IP address, route table, sysctl parameters, etc</li>
  <li>create endpoint (cilium concept, namespaced interface to apply policy on)</li>
  <li>generate, compile, link and inject BPF code into kernel</li>
</ol>

<h2 id="0-high-level-overview">0 High Level Overview</h2>

<p>Cilium code in this article bases on version <code class="highlighter-rouge">1.3.2</code>. To focous on the main
aspects, we will omit lots of unrelated lines (e.g. error handling, stats,
varaible declerations) in functions below. You should refer to the <a href="https://github.com/cilium/cilium">source
code</a> in case you want to check more
implementation details.</p>

<p><strong>Note that I’m not very familir with Cilium at the time of writing this, so the
post may contain mistakes. I’m happy if anyone points them out and I’ll update
it.</strong></p>

<h3 id="01-source-code-tree">0.1 Source Code Tree</h3>

<ol>
  <li><code class="highlighter-rouge">api/</code> - cilium REST API entrypoints</li>
  <li>
    <p><code class="highlighter-rouge">daemon/</code> - cilium daemon (agent) implementation, including:</p>

    <ol>
      <li>IPAM API handler implementation</li>
      <li>endpoint API handler</li>
      <li>others</li>
    </ol>
  </li>
  <li><code class="highlighter-rouge">plugin/</code> - plugin implementations for CNI, docker, etc</li>
  <li>
    <p><code class="highlighter-rouge">pkg/</code> - cilium core functionalities implementation</p>

    <ol>
      <li><code class="highlighter-rouge">client/</code> - cilium client library</li>
      <li><code class="highlighter-rouge">datapath/</code> - packet forwarding plane related stuffs</li>
      <li><code class="highlighter-rouge">endpoint/</code> - real endpoint logic</li>
      <li><code class="highlighter-rouge">endpointmanager/</code> - real endpoint management logic</li>
      <li><code class="highlighter-rouge">ipam/</code> - local IPAM implementation, which internally uses k8s local IPAM</li>
      <li>others</li>
    </ol>
  </li>
</ol>

<h3 id="02-plugin-adding-network-skeleton-code">0.2 Plugin: Adding Network Skeleton Code</h3>

<p>The cilium CNI plugin is implemented in a single file
<code class="highlighter-rouge">plugins/cilium-cni/cilium-cni.go</code>.</p>

<p>When kubelet calls the plugin to add network for a container, <code class="highlighter-rouge">cmdAdd()</code>
function will be invoked. The skeleton code is as follows:</p>

<div class="language-go highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">func</span><span class="x"> </span><span class="n">cmdAdd</span><span class="p">(</span><span class="n">args</span><span class="x"> </span><span class="o">*</span><span class="n">skel</span><span class="o">.</span><span class="n">CmdArgs</span><span class="p">)</span><span class="x"> </span><span class="p">(</span><span class="n">err</span><span class="x"> </span><span class="kt">error</span><span class="p">)</span><span class="x"> </span><span class="p">{</span><span class="x">
	</span><span class="c">// load data from stdin, TODO: what data?</span><span class="x">
	</span><span class="n">n</span><span class="p">,</span><span class="x"> </span><span class="n">cniVer</span><span class="x"> </span><span class="o">:=</span><span class="x"> </span><span class="n">loadNetConf</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">StdinData</span><span class="p">)</span><span class="x">

	</span><span class="c">// init variables</span><span class="x">
	</span><span class="n">c</span><span class="x"> </span><span class="o">:=</span><span class="x"> </span><span class="n">client</span><span class="o">.</span><span class="n">NewDefaultClientWithTimeout</span><span class="p">(</span><span class="n">defaults</span><span class="o">.</span><span class="n">ClientConnectTimeout</span><span class="p">)</span><span class="x"> </span><span class="c">// cilium client</span><span class="x">
	</span><span class="n">ep</span><span class="x"> </span><span class="o">:=</span><span class="x"> </span><span class="o">&amp;</span><span class="n">models</span><span class="o">.</span><span class="n">EndpointChangeRequest</span><span class="p">{}</span><span class="x">

	</span><span class="c">// create link: veth pair, IPVLAN, etc</span><span class="x">
	</span><span class="k">switch</span><span class="x"> </span><span class="n">conf</span><span class="o">.</span><span class="n">DatapathMode</span><span class="x"> </span><span class="p">{</span><span class="x">
	</span><span class="k">case</span><span class="x"> </span><span class="n">option</span><span class="o">.</span><span class="n">DatapathModeVeth</span><span class="o">:</span><span class="x">
		</span><span class="n">veth</span><span class="p">,</span><span class="x"> </span><span class="n">peer</span><span class="p">,</span><span class="x"> </span><span class="n">tmpIfName</span><span class="x"> </span><span class="o">:=</span><span class="x"> </span><span class="n">connector</span><span class="o">.</span><span class="n">SetupVeth</span><span class="p">(</span><span class="n">ep</span><span class="o">.</span><span class="n">ContainerID</span><span class="p">,</span><span class="x"> </span><span class="kt">int</span><span class="p">(</span><span class="n">conf</span><span class="o">.</span><span class="n">DeviceMTU</span><span class="p">),</span><span class="x"> </span><span class="n">ep</span><span class="p">)</span><span class="x">
		</span><span class="n">netlink</span><span class="o">.</span><span class="n">LinkSetNsFd</span><span class="p">(</span><span class="o">*</span><span class="n">peer</span><span class="p">,</span><span class="x"> </span><span class="kt">int</span><span class="p">(</span><span class="n">netNs</span><span class="o">.</span><span class="n">Fd</span><span class="p">()))</span><span class="x">
		</span><span class="n">connector</span><span class="o">.</span><span class="n">SetupVethRemoteNs</span><span class="p">(</span><span class="n">netNs</span><span class="p">,</span><span class="x"> </span><span class="n">tmpIfName</span><span class="p">,</span><span class="x"> </span><span class="n">args</span><span class="o">.</span><span class="n">IfName</span><span class="p">)</span><span class="x">
	</span><span class="p">}</span><span class="x">

	</span><span class="c">// allocate IP (IPv4 &amp; IPv6) from local IPAM</span><span class="x">
	</span><span class="n">ipam</span><span class="x"> </span><span class="o">:=</span><span class="x"> </span><span class="n">c</span><span class="o">.</span><span class="n">IPAMAllocate</span><span class="p">(</span><span class="s">""</span><span class="p">)</span><span class="x">

	</span><span class="c">// configure network settings</span><span class="x">
	</span><span class="n">ep</span><span class="o">.</span><span class="n">Addressing</span><span class="o">.</span><span class="n">IPV4</span><span class="x"> </span><span class="o">=</span><span class="x"> </span><span class="n">ipam</span><span class="o">.</span><span class="n">Address</span><span class="o">.</span><span class="n">IPV4</span><span class="x">
	</span><span class="n">ipConfig</span><span class="p">,</span><span class="x"> </span><span class="n">routes</span><span class="x"> </span><span class="o">:=</span><span class="x"> </span><span class="n">prepareIP</span><span class="p">(</span><span class="n">ep</span><span class="o">.</span><span class="n">Addressing</span><span class="o">.</span><span class="n">IPV4</span><span class="p">,</span><span class="x"> </span><span class="no">false</span><span class="p">,</span><span class="x"> </span><span class="o">&amp;</span><span class="n">state</span><span class="p">,</span><span class="x"> </span><span class="kt">int</span><span class="p">(</span><span class="n">conf</span><span class="o">.</span><span class="n">RouteMTU</span><span class="p">))</span><span class="x">

	</span><span class="n">netNs</span><span class="o">.</span><span class="n">Do</span><span class="p">(</span><span class="k">func</span><span class="p">(</span><span class="n">_</span><span class="x"> </span><span class="n">ns</span><span class="o">.</span><span class="n">NetNS</span><span class="p">)</span><span class="x"> </span><span class="kt">error</span><span class="x"> </span><span class="p">{</span><span class="x">
		</span><span class="n">macAddrStr</span><span class="x"> </span><span class="o">=</span><span class="x"> </span><span class="n">configureIface</span><span class="p">(</span><span class="n">ipam</span><span class="p">,</span><span class="x"> </span><span class="n">args</span><span class="o">.</span><span class="n">IfName</span><span class="p">,</span><span class="x"> </span><span class="o">&amp;</span><span class="n">state</span><span class="p">)</span><span class="x">
	</span><span class="p">})</span><span class="x">

	</span><span class="c">// create endpoint, generate eBPF code</span><span class="x">
	</span><span class="n">c</span><span class="o">.</span><span class="n">EndpointCreate</span><span class="p">(</span><span class="n">ep</span><span class="p">)</span><span class="x">
</span><span class="p">}</span><span class="x">
</span></code></pre></div></div>

<h3 id="03-plugin-add-network-steps">0.3 Plugin: Add Network Steps</h3>

<p>Summarizing the above add network steps:</p>

<ol>
  <li>preparations: parse CNI parameters received from kubelet, init variables</li>
  <li>create link device for container and link it to host network, e.g. using veth pair, IPVLAN</li>
  <li>allocate IP addresses for container from local IPAM</li>
  <li>confiure IP addresses, route table, sysctl parameters, etc for container</li>
  <li>create endpoint, generate BPF code</li>
</ol>

<p>In the next, we will walk through this process in detail.</p>

<h2 id="1-preparation-works">1 Preparation Works</h2>

<h3 id="11-parse-cni-parameters">1.1 Parse CNI Parameters</h3>

<p>On requesting for adding network for a container, kubelet will pass a
<code class="highlighter-rouge">CmdArgs</code> type variable to CNI plugin, which is defined in
<code class="highlighter-rouge">github.com/containernetworking/cni/pkg/skel</code>:</p>

<div class="language-go highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c">// CmdArgs captures all the arguments passed in to the plugin</span><span class="x">
</span><span class="c">// via both env vars and stdin</span><span class="x">
</span><span class="k">type</span><span class="x"> </span><span class="n">CmdArgs</span><span class="x"> </span><span class="k">struct</span><span class="x"> </span><span class="p">{</span><span class="x">
        </span><span class="n">ContainerID</span><span class="x"> </span><span class="kt">string</span><span class="x">
        </span><span class="n">Netns</span><span class="x">       </span><span class="kt">string</span><span class="x">
        </span><span class="n">IfName</span><span class="x">      </span><span class="kt">string</span><span class="x">
        </span><span class="n">Args</span><span class="x">        </span><span class="kt">string</span><span class="x">
        </span><span class="n">Path</span><span class="x">        </span><span class="kt">string</span><span class="x">
        </span><span class="n">StdinData</span><span class="x">   </span><span class="p">[]</span><span class="kt">byte</span><span class="x">
</span><span class="p">}</span><span class="x">
</span></code></pre></div></div>

<p>information included in <code class="highlighter-rouge">CmdArgs</code>:</p>

<ul>
  <li>container ID</li>
  <li>container network namespace</li>
  <li>desired interface name for container, e.g. <code class="highlighter-rouge">eth0</code></li>
  <li>additional platform-dependent arguments of the container, e.g.
<code class="highlighter-rouge">K8S_POD_NAMESPACE=default;K8S_POD_NAME=busybox;K8S_POD_INFRA_CONTAINER_ID=3b126ac</code></li>
  <li>path for locating CNI plugin binary, e.g. <code class="highlighter-rouge">/opt/cni/bin</code></li>
  <li>network configuration information passed through stdin</li>
</ul>

<p>Among them, <code class="highlighter-rouge">StdinData</code> field will be unmarshalled into a <code class="highlighter-rouge">netConf</code> instance:</p>

<div class="language-go highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">type</span><span class="x"> </span><span class="n">netConf</span><span class="x"> </span><span class="k">struct</span><span class="x"> </span><span class="p">{</span><span class="x">
	</span><span class="n">cniTypes</span><span class="o">.</span><span class="n">NetConf</span><span class="x">
	</span><span class="n">MTU</span><span class="x">  </span><span class="kt">int</span><span class="x">  </span><span class="s">`json:"mtu"`</span><span class="x">
	</span><span class="n">Args</span><span class="x"> </span><span class="n">Args</span><span class="x"> </span><span class="s">`json:"args"`</span><span class="x">
</span><span class="p">}</span><span class="x">
</span></code></pre></div></div>

<p>where <code class="highlighter-rouge">cniTypes.NetConf</code> is defined in <code class="highlighter-rouge">github.com/containernetworking/cni/pkg/types/types.go</code>:</p>

<div class="language-go highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c">// NetConf describes a network.</span><span class="x">
</span><span class="k">type</span><span class="x"> </span><span class="n">NetConf</span><span class="x"> </span><span class="k">struct</span><span class="x"> </span><span class="p">{</span><span class="x">
	</span><span class="n">CNIVersion</span><span class="x"> </span><span class="kt">string</span><span class="x"> </span><span class="s">`json:"cniVersion,omitempty"`</span><span class="x">

	</span><span class="n">Name</span><span class="x">         </span><span class="kt">string</span><span class="x">          </span><span class="s">`json:"name,omitempty"`</span><span class="x">
	</span><span class="n">Type</span><span class="x">         </span><span class="kt">string</span><span class="x">          </span><span class="s">`json:"type,omitempty"`</span><span class="x">
	</span><span class="n">Capabilities</span><span class="x"> </span><span class="k">map</span><span class="p">[</span><span class="kt">string</span><span class="p">]</span><span class="kt">bool</span><span class="x"> </span><span class="s">`json:"capabilities,omitempty"`</span><span class="x">
	</span><span class="n">IPAM</span><span class="x">         </span><span class="n">IPAM</span><span class="x">            </span><span class="s">`json:"ipam,omitempty"`</span><span class="x">
	</span><span class="n">DNS</span><span class="x">          </span><span class="n">DNS</span><span class="x">             </span><span class="s">`json:"dns"`</span><span class="x">

	</span><span class="n">RawPrevResult</span><span class="x"> </span><span class="k">map</span><span class="p">[</span><span class="kt">string</span><span class="p">]</span><span class="k">interface</span><span class="p">{}</span><span class="x"> </span><span class="s">`json:"prevResult,omitempty"`</span><span class="x">
	</span><span class="n">PrevResult</span><span class="x">    </span><span class="n">Result</span><span class="x">                 </span><span class="s">`json:"-"`</span><span class="x">
</span><span class="p">}</span><span class="x">
</span></code></pre></div></div>

<h3 id="12-init-varaibles">1.2 Init Varaibles</h3>

<p>This section also initializes some varaibles that will be used later, the most
important ones:</p>

<ul>
  <li>a cilium client variable</li>
  <li>an <code class="highlighter-rouge">EndpointChangeRequest</code> variable, holding request data that will be
used for creating an Endpoint</li>
</ul>

<div class="language-go highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="x">	</span><span class="c">// init variables</span><span class="x">
	</span><span class="n">c</span><span class="x"> </span><span class="o">:=</span><span class="x"> </span><span class="n">client</span><span class="o">.</span><span class="n">NewDefaultClientWithTimeout</span><span class="p">(</span><span class="n">defaults</span><span class="o">.</span><span class="n">ClientConnectTimeout</span><span class="p">)</span><span class="x"> </span><span class="c">// cilium client</span><span class="x">
	</span><span class="n">ep</span><span class="x"> </span><span class="o">:=</span><span class="x"> </span><span class="o">&amp;</span><span class="n">models</span><span class="o">.</span><span class="n">EndpointChangeRequest</span><span class="p">{</span><span class="o">...</span><span class="p">}</span><span class="x">
</span></code></pre></div></div>

<h2 id="2-create-link-device">2 Create Link Device</h2>

<p>Cilium supports two kinds of datapath types (and thus link device types) at the
time of writing this post:</p>

<ol>
  <li>veth pair</li>
  <li>IPVLAN</li>
</ol>

<p>We will take veth pair as example in the following.</p>

<h3 id="21-create-veth-pair">2.1 Create Veth Pair</h3>

<p>In Cilium, the virtual device used for connecting container to host is called a
“connector”.</p>

<p>First, call <code class="highlighter-rouge">connector.SetupVeth()</code> to create a veth pair, taking container ID,
MTU and endpoint info as parameters.</p>

<div class="language-go highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="x">		</span><span class="n">veth</span><span class="p">,</span><span class="x"> </span><span class="n">peer</span><span class="p">,</span><span class="x"> </span><span class="n">tmpIfName</span><span class="x"> </span><span class="o">:=</span><span class="x"> </span><span class="n">connector</span><span class="o">.</span><span class="n">SetupVeth</span><span class="p">(</span><span class="n">ep</span><span class="o">.</span><span class="n">ContainerID</span><span class="p">,</span><span class="x"> </span><span class="kt">int</span><span class="p">(</span><span class="n">conf</span><span class="o">.</span><span class="n">DeviceMTU</span><span class="p">),</span><span class="x"> </span><span class="n">ep</span><span class="p">)</span><span class="x">
</span></code></pre></div></div>

<p>Naming rule for the veth pair devies:</p>

<ul>
  <li><strong>host side</strong>: <code class="highlighter-rouge">lxc</code> + first N digits of <code class="highlighter-rouge">sha256(containerID)</code>, e.g. <code class="highlighter-rouge">lxc12c45</code></li>
  <li><strong>peer (container) side</strong>: <code class="highlighter-rouge">tmp</code> + first N digits of <code class="highlighter-rouge">sha256(containerID)</code>, e.g. <code class="highlighter-rouge">tmp12c45</code></li>
</ul>

<p>Additional steps in <code class="highlighter-rouge">connector</code> (<code class="highlighter-rouge">pkg/endpoint/connector/veth.go</code>):</p>

<ol>
  <li>set sysctl parameters: <code class="highlighter-rouge">/proc/sys/net/ipv4/conf/&lt;veth&gt;/rp_filter = 0</code></li>
  <li>set MTU</li>
  <li>fill endpoint info: MAC (container side), host side MAC, interface name, interface index</li>
</ol>

<h3 id="22-set-peers-network-namespace">2.2 Set Peer’s Network Namespace</h3>

<p>Put the peer end to container by setting the peer’s network namespace
to container’s netns:</p>

<div class="language-go highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="x">		</span><span class="n">netlink</span><span class="o">.</span><span class="n">LinkSetNsFd</span><span class="p">(</span><span class="o">*</span><span class="n">peer</span><span class="p">,</span><span class="x"> </span><span class="kt">int</span><span class="p">(</span><span class="n">netNs</span><span class="o">.</span><span class="n">Fd</span><span class="p">()))</span><span class="x">
</span></code></pre></div></div>

<p>As a consequence, the peer device will “disapper” from host, namely, it will not
be listed when executing <code class="highlighter-rouge">ifconfig</code> or <code class="highlighter-rouge">ip link</code> commands on the host.
You must specify the netns in order to see it: <code class="highlighter-rouge">ip netns exec &lt;netns&gt; ip link</code>.</p>

<h3 id="23-rename-peer">2.3 Rename Peer</h3>

<p>After putting the peer end to container, rename the peer to the given name in
CNI arguments:</p>

<div class="language-go highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="x">		</span><span class="n">connector</span><span class="o">.</span><span class="n">SetupVethRemoteNs</span><span class="p">(</span><span class="n">netNs</span><span class="p">,</span><span class="x"> </span><span class="n">tmpIfName</span><span class="p">,</span><span class="x"> </span><span class="n">args</span><span class="o">.</span><span class="n">IfName</span><span class="p">)</span><span class="x">
</span></code></pre></div></div>

<p>This will, for example, rename <code class="highlighter-rouge">tmp53057</code> to <code class="highlighter-rouge">eth0</code> inside container.</p>

<p>Sum up, that is <strong>how the <code class="highlighter-rouge">eth0</code> device comes to exist of each container</strong>.</p>

<h2 id="3-allocating-ip">3 Allocating IP</h2>

<p>In the next, the pugin will try to allocate IP addresses (IPv4 &amp; IPv6) from the
local IPAM inside cilium agent.</p>

<p>Cilium agent is a daemon process running on each host, it includes many services
inside itself, for example, <strong>local IPAM</strong>, <strong>endpoint manager</strong>, etc.
These services expose REST APIs.</p>

<p>This part is more complicated than it looks like. The code is just one line in
plugin code:</p>

<div class="language-go highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="x">	</span><span class="n">ipam</span><span class="x"> </span><span class="o">:=</span><span class="x"> </span><span class="n">c</span><span class="o">.</span><span class="n">IPAMAllocate</span><span class="p">(</span><span class="s">""</span><span class="p">)</span><span class="x">
</span></code></pre></div></div>

<p>But the call stack will jump among different places:</p>

<ol>
  <li>plugin - <code class="highlighter-rouge">plugin/cilium-cni/</code></li>
  <li>cilium client - <code class="highlighter-rouge">pkg/client/</code></li>
  <li>clium REST API - <code class="highlighter-rouge">api/v1/server/restapi/ipam/</code></li>
  <li>cilium API server - <code class="highlighter-rouge">api/v1/server/restapi/ipam</code></li>
  <li>real HTTP handler - <code class="highlighter-rouge">daemon/ipam.go</code></li>
  <li>cilium IPAM implementation (actually is only a wrapper) - <code class="highlighter-rouge">pkg/ipam/</code></li>
  <li>final IPAM implementation (k8s builtin) - <code class="highlighter-rouge">k8s.io/kubernetes/pkg/registry/core/service/ipallocator</code></li>
</ol>

<p>Let’s see them.</p>

<h3 id="31-allocate-ip-address">3.1 Allocate IP Address</h3>

<p>Start from <code class="highlighter-rouge">plugin/cilium-cni/cilium-cni.go</code>:</p>

<div class="language-go highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="x">	</span><span class="n">ipam</span><span class="x"> </span><span class="o">:=</span><span class="x"> </span><span class="n">c</span><span class="o">.</span><span class="n">IPAMAllocate</span><span class="p">(</span><span class="s">""</span><span class="p">)</span><span class="x">
</span></code></pre></div></div>

<p>where <code class="highlighter-rouge">c</code> is an instance of cilium client.</p>

<p><code class="highlighter-rouge">IPAMAllocate()</code> takes address family as parameter; if not specified, it will
create both an IPv4 and an IPv6 address. Each of them will be saved at the
following fields:</p>

<ul>
  <li><code class="highlighter-rouge">ipam.Address.IPV4</code></li>
  <li><code class="highlighter-rouge">ipam.Address.IPV6</code></li>
</ul>

<p>Let’s move to this function.</p>

<h3 id="32-cilium-client-ipamallocate">3.2 Cilium Client: <code class="highlighter-rouge">IPAMAllocate()</code></h3>

<p><code class="highlighter-rouge">pkt/client/ipam.go</code>:</p>

<div class="language-go highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c">// IPAMAllocate allocates an IP address out of address family specific pool.</span><span class="x">
</span><span class="k">func</span><span class="x"> </span><span class="p">(</span><span class="n">c</span><span class="x"> </span><span class="o">*</span><span class="n">Client</span><span class="p">)</span><span class="x"> </span><span class="n">IPAMAllocate</span><span class="p">(</span><span class="n">family</span><span class="x"> </span><span class="kt">string</span><span class="p">)</span><span class="x"> </span><span class="p">(</span><span class="o">*</span><span class="n">models</span><span class="o">.</span><span class="n">IPAMResponse</span><span class="p">,</span><span class="x"> </span><span class="kt">error</span><span class="p">)</span><span class="x"> </span><span class="p">{</span><span class="x">
	</span><span class="n">params</span><span class="x"> </span><span class="o">:=</span><span class="x"> </span><span class="n">ipam</span><span class="o">.</span><span class="n">NewPostIPAMParams</span><span class="p">()</span><span class="o">.</span><span class="n">WithTimeout</span><span class="p">(</span><span class="n">api</span><span class="o">.</span><span class="n">ClientTimeout</span><span class="p">)</span><span class="x">

	</span><span class="k">if</span><span class="x"> </span><span class="n">family</span><span class="x"> </span><span class="o">!=</span><span class="x"> </span><span class="s">""</span><span class="x"> </span><span class="p">{</span><span class="x">
		</span><span class="n">params</span><span class="o">.</span><span class="n">SetFamily</span><span class="p">(</span><span class="o">&amp;</span><span class="n">family</span><span class="p">)</span><span class="x">
	</span><span class="p">}</span><span class="x">

	</span><span class="n">resp</span><span class="x"> </span><span class="o">:=</span><span class="x"> </span><span class="n">c</span><span class="o">.</span><span class="n">IPAM</span><span class="o">.</span><span class="n">PostIPAM</span><span class="p">(</span><span class="n">params</span><span class="p">)</span><span class="x">
	</span><span class="k">return</span><span class="x"> </span><span class="n">resp</span><span class="o">.</span><span class="n">Payload</span><span class="p">,</span><span class="x"> </span><span class="no">nil</span><span class="x">
</span><span class="p">}</span><span class="x">
</span></code></pre></div></div>

<p>where, the client structure is defined in <code class="highlighter-rouge">pkt/client/ipam.go</code>:</p>

<div class="language-go highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">type</span><span class="x"> </span><span class="n">Client</span><span class="x"> </span><span class="k">struct</span><span class="x"> </span><span class="p">{</span><span class="x">
	</span><span class="n">clientapi</span><span class="o">.</span><span class="n">Cilium</span><span class="x">
</span><span class="p">}</span><span class="x">
</span></code></pre></div></div>

<p>where in turn, the client API structure is defined in
<code class="highlighter-rouge">api/v1/client/cilium_client.go</code>:</p>

<div class="language-go highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c">// clientapi</span><span class="x">
</span><span class="k">type</span><span class="x"> </span><span class="n">Cilium</span><span class="x"> </span><span class="k">struct</span><span class="x"> </span><span class="p">{</span><span class="x">
	</span><span class="n">Daemon</span><span class="x"> </span><span class="o">*</span><span class="n">daemon</span><span class="o">.</span><span class="n">Client</span><span class="x">

	</span><span class="n">Endpoint</span><span class="x"> </span><span class="o">*</span><span class="n">endpoint</span><span class="o">.</span><span class="n">Client</span><span class="x">
	</span><span class="n">IPAM</span><span class="x"> </span><span class="o">*</span><span class="n">ipam</span><span class="o">.</span><span class="n">Client</span><span class="x">              </span><span class="c">// point to "api/v1/client/ipam"</span><span class="x">
	</span><span class="n">Metrics</span><span class="x"> </span><span class="o">*</span><span class="n">metrics</span><span class="o">.</span><span class="n">Client</span><span class="x">
	</span><span class="n">Policy</span><span class="x"> </span><span class="o">*</span><span class="n">policy</span><span class="o">.</span><span class="n">Client</span><span class="x">
	</span><span class="n">Prefilter</span><span class="x"> </span><span class="o">*</span><span class="n">prefilter</span><span class="o">.</span><span class="n">Client</span><span class="x">
	</span><span class="n">Service</span><span class="x"> </span><span class="o">*</span><span class="n">service</span><span class="o">.</span><span class="n">Client</span><span class="x">
	</span><span class="n">Transport</span><span class="x"> </span><span class="n">runtime</span><span class="o">.</span><span class="n">ClientTransport</span><span class="x">
</span><span class="p">}</span><span class="x">
</span></code></pre></div></div>

<p>OK, now we need to move to <code class="highlighter-rouge">c.IPAM.PostIPAM(params)</code>.</p>

<h3 id="33-call-rest-api-allocate-ip">3.3 Call REST API: Allocate IP</h3>

<p>The cilium API code is auto-generated with golang OpenAPI tools.</p>

<p><code class="highlighter-rouge">api/v1/client/ipam/i_p_a_m_client.go</code>:</p>

<div class="language-go highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">func</span><span class="x"> </span><span class="p">(</span><span class="n">a</span><span class="x"> </span><span class="o">*</span><span class="n">Client</span><span class="p">)</span><span class="x"> </span><span class="n">PostIPAM</span><span class="p">(</span><span class="n">params</span><span class="x"> </span><span class="o">*</span><span class="n">PostIPAMParams</span><span class="p">)</span><span class="x"> </span><span class="p">(</span><span class="o">*</span><span class="n">PostIPAMCreated</span><span class="p">,</span><span class="x"> </span><span class="kt">error</span><span class="p">)</span><span class="x"> </span><span class="p">{</span><span class="x">
	</span><span class="n">result</span><span class="x"> </span><span class="o">:=</span><span class="x"> </span><span class="n">a</span><span class="o">.</span><span class="n">transport</span><span class="o">.</span><span class="n">Submit</span><span class="p">(</span><span class="o">&amp;</span><span class="n">runtime</span><span class="o">.</span><span class="n">ClientOperation</span><span class="p">{</span><span class="x">
		</span><span class="n">ID</span><span class="o">:</span><span class="x">                 </span><span class="s">"PostIPAM"</span><span class="p">,</span><span class="x">
		</span><span class="n">Method</span><span class="o">:</span><span class="x">             </span><span class="s">"POST"</span><span class="p">,</span><span class="x">
		</span><span class="n">PathPattern</span><span class="o">:</span><span class="x">        </span><span class="s">"/ipam"</span><span class="p">,</span><span class="x">
		</span><span class="n">Params</span><span class="o">:</span><span class="x">             </span><span class="n">params</span><span class="p">,</span><span class="x">
	</span><span class="p">})</span><span class="x">
	</span><span class="k">return</span><span class="x"> </span><span class="n">result</span><span class="o">.</span><span class="p">(</span><span class="o">*</span><span class="n">PostIPAMCreated</span><span class="p">),</span><span class="x"> </span><span class="no">nil</span><span class="x">
</span><span class="p">}</span><span class="x">
</span></code></pre></div></div>

<p>This will send out the request with <code class="highlighter-rouge">POST</code> method, <code class="highlighter-rouge">/ipam</code> URI and many
other HTTP parameters.</p>

<h3 id="34-ipam-api-server">3.4 IPAM API Server</h3>

<p>HTTP request receiving side, <code class="highlighter-rouge">api/v1/server/restapi/ipam/post_ip_a_m.go</code>:</p>

<div class="language-go highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">func</span><span class="x"> </span><span class="p">(</span><span class="n">o</span><span class="x"> </span><span class="o">*</span><span class="n">PostIPAM</span><span class="p">)</span><span class="x"> </span><span class="n">ServeHTTP</span><span class="p">(</span><span class="n">rw</span><span class="x"> </span><span class="n">http</span><span class="o">.</span><span class="n">ResponseWriter</span><span class="p">,</span><span class="x"> </span><span class="n">r</span><span class="x"> </span><span class="o">*</span><span class="n">http</span><span class="o">.</span><span class="n">Request</span><span class="p">)</span><span class="x"> </span><span class="p">{</span><span class="x">
	</span><span class="n">route</span><span class="p">,</span><span class="x"> </span><span class="n">rCtx</span><span class="p">,</span><span class="x"> </span><span class="n">_</span><span class="x"> </span><span class="o">:=</span><span class="x"> </span><span class="n">o</span><span class="o">.</span><span class="n">Context</span><span class="o">.</span><span class="n">RouteInfo</span><span class="p">(</span><span class="n">r</span><span class="p">)</span><span class="x">
	</span><span class="k">if</span><span class="x"> </span><span class="n">rCtx</span><span class="x"> </span><span class="o">!=</span><span class="x"> </span><span class="no">nil</span><span class="x"> </span><span class="p">{</span><span class="x">
		</span><span class="n">r</span><span class="x"> </span><span class="o">=</span><span class="x"> </span><span class="n">rCtx</span><span class="x">
	</span><span class="p">}</span><span class="x">
	</span><span class="k">var</span><span class="x"> </span><span class="n">Params</span><span class="x"> </span><span class="o">=</span><span class="x"> </span><span class="n">NewPostIPAMParams</span><span class="p">()</span><span class="x">

	</span><span class="k">if</span><span class="x"> </span><span class="n">err</span><span class="x"> </span><span class="o">:=</span><span class="x"> </span><span class="n">o</span><span class="o">.</span><span class="n">Context</span><span class="o">.</span><span class="n">BindValidRequest</span><span class="p">(</span><span class="n">r</span><span class="p">,</span><span class="x"> </span><span class="n">route</span><span class="p">,</span><span class="x"> </span><span class="o">&amp;</span><span class="n">Params</span><span class="p">);</span><span class="x"> </span><span class="n">err</span><span class="x"> </span><span class="o">!=</span><span class="x"> </span><span class="no">nil</span><span class="x"> </span><span class="p">{</span><span class="x"> </span><span class="c">// bind params</span><span class="x">
		</span><span class="n">o</span><span class="o">.</span><span class="n">Context</span><span class="o">.</span><span class="n">Respond</span><span class="p">(</span><span class="n">rw</span><span class="p">,</span><span class="x"> </span><span class="n">r</span><span class="p">,</span><span class="x"> </span><span class="n">route</span><span class="o">.</span><span class="n">Produces</span><span class="p">,</span><span class="x"> </span><span class="n">route</span><span class="p">,</span><span class="x"> </span><span class="n">err</span><span class="p">)</span><span class="x">
		</span><span class="k">return</span><span class="x">
	</span><span class="p">}</span><span class="x">

	</span><span class="n">res</span><span class="x"> </span><span class="o">:=</span><span class="x"> </span><span class="n">o</span><span class="o">.</span><span class="n">Handler</span><span class="o">.</span><span class="n">Handle</span><span class="p">(</span><span class="n">Params</span><span class="p">)</span><span class="x"> </span><span class="c">// actually handle the request</span><span class="x">

	</span><span class="n">o</span><span class="o">.</span><span class="n">Context</span><span class="o">.</span><span class="n">Respond</span><span class="p">(</span><span class="n">rw</span><span class="p">,</span><span class="x"> </span><span class="n">r</span><span class="p">,</span><span class="x"> </span><span class="n">route</span><span class="o">.</span><span class="n">Produces</span><span class="p">,</span><span class="x"> </span><span class="n">route</span><span class="p">,</span><span class="x"> </span><span class="n">res</span><span class="p">)</span><span class="x">
</span><span class="p">}</span><span class="x">
</span></code></pre></div></div>

<p>As can be seen, the real processing logic is done in <code class="highlighter-rouge">o.Handler.Handle()</code>
method. This method is implemented in daemon code.</p>

<h3 id="35-ipam-http-handler">3.5 IPAM HTTP Handler</h3>

<p><code class="highlighter-rouge">daemon/ipam.go</code>:</p>

<div class="language-go highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c">// Handle incoming requests address allocation requests for the daemon.</span><span class="x">
</span><span class="k">func</span><span class="x"> </span><span class="p">(</span><span class="n">h</span><span class="x"> </span><span class="o">*</span><span class="n">postIPAM</span><span class="p">)</span><span class="x"> </span><span class="n">Handle</span><span class="p">(</span><span class="n">params</span><span class="x"> </span><span class="n">ipamapi</span><span class="o">.</span><span class="n">PostIPAMParams</span><span class="p">)</span><span class="x"> </span><span class="n">middleware</span><span class="o">.</span><span class="n">Responder</span><span class="x"> </span><span class="p">{</span><span class="x">
	</span><span class="n">resp</span><span class="x"> </span><span class="o">:=</span><span class="x"> </span><span class="o">&amp;</span><span class="n">models</span><span class="o">.</span><span class="n">IPAMResponse</span><span class="p">{</span><span class="x">
		</span><span class="n">HostAddressing</span><span class="o">:</span><span class="x"> </span><span class="n">node</span><span class="o">.</span><span class="n">GetNodeAddressing</span><span class="p">(),</span><span class="x">
		</span><span class="n">Address</span><span class="o">:</span><span class="x">        </span><span class="o">&amp;</span><span class="n">models</span><span class="o">.</span><span class="n">AddressPair</span><span class="p">{},</span><span class="x">
	</span><span class="p">}</span><span class="x">

	</span><span class="n">ipv4</span><span class="p">,</span><span class="x"> </span><span class="n">ipv6</span><span class="x"> </span><span class="o">:=</span><span class="x"> </span><span class="n">h</span><span class="o">.</span><span class="n">daemon</span><span class="o">.</span><span class="n">ipam</span><span class="o">.</span><span class="n">AllocateNext</span><span class="p">(</span><span class="n">params</span><span class="o">.</span><span class="n">Family</span><span class="p">)</span><span class="x">

	</span><span class="n">resp</span><span class="o">.</span><span class="n">Address</span><span class="o">.</span><span class="n">IPV4</span><span class="x"> </span><span class="o">=</span><span class="x"> </span><span class="n">ipv4</span><span class="o">.</span><span class="n">String</span><span class="p">()</span><span class="x">
	</span><span class="n">resp</span><span class="o">.</span><span class="n">Address</span><span class="o">.</span><span class="n">IPV6</span><span class="x"> </span><span class="o">=</span><span class="x"> </span><span class="n">ipv6</span><span class="o">.</span><span class="n">String</span><span class="p">()</span><span class="x">

	</span><span class="k">return</span><span class="x"> </span><span class="n">ipamapi</span><span class="o">.</span><span class="n">NewPostIPAMCreated</span><span class="p">()</span><span class="o">.</span><span class="n">WithPayload</span><span class="p">(</span><span class="n">resp</span><span class="p">)</span><span class="x">
</span><span class="p">}</span><span class="x">
</span></code></pre></div></div>

<p>where <code class="highlighter-rouge">h.daemon.ipam</code> is actually a CIDR range, initialized as:</p>

<p><code class="highlighter-rouge">pkg/ipam/ipam.go</code>:</p>

<div class="language-go highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">import</span><span class="x"> </span><span class="s">"k8s.io/kubernetes/pkg/registry/core/service/ipallocator"</span><span class="x">

</span><span class="c">// NewIPAM returns a new IP address manager</span><span class="x">
</span><span class="k">func</span><span class="x"> </span><span class="n">NewIPAM</span><span class="p">(</span><span class="n">nodeAddressing</span><span class="x"> </span><span class="n">datapath</span><span class="o">.</span><span class="n">NodeAddressing</span><span class="p">,</span><span class="x"> </span><span class="n">c</span><span class="x"> </span><span class="n">Configuration</span><span class="p">)</span><span class="x"> </span><span class="o">*</span><span class="n">IPAM</span><span class="x"> </span><span class="p">{</span><span class="x">
	</span><span class="n">ipam</span><span class="x"> </span><span class="o">:=</span><span class="x"> </span><span class="o">&amp;</span><span class="n">IPAM</span><span class="p">{</span><span class="x">
		</span><span class="n">nodeAddressing</span><span class="o">:</span><span class="x"> </span><span class="n">nodeAddressing</span><span class="p">,</span><span class="x">
		</span><span class="n">config</span><span class="o">:</span><span class="x">         </span><span class="n">c</span><span class="p">,</span><span class="x">
	</span><span class="p">}</span><span class="x">

	</span><span class="k">if</span><span class="x"> </span><span class="n">c</span><span class="o">.</span><span class="n">EnableIPv6</span><span class="x"> </span><span class="p">{</span><span class="x">
		</span><span class="n">ipam</span><span class="o">.</span><span class="n">IPv6Allocator</span><span class="x"> </span><span class="o">=</span><span class="x"> </span><span class="n">ipallocator</span><span class="o">.</span><span class="n">NewCIDRRange</span><span class="p">(</span><span class="n">nodeAddressing</span><span class="o">.</span><span class="n">IPv6</span><span class="p">()</span><span class="o">.</span><span class="n">AllocationCIDR</span><span class="p">()</span><span class="o">.</span><span class="n">IPNet</span><span class="p">)</span><span class="x">
	</span><span class="p">}</span><span class="x">

	</span><span class="k">if</span><span class="x"> </span><span class="n">c</span><span class="o">.</span><span class="n">EnableIPv4</span><span class="x"> </span><span class="p">{</span><span class="x">
		</span><span class="n">ipam</span><span class="o">.</span><span class="n">IPv4Allocator</span><span class="x"> </span><span class="o">=</span><span class="x"> </span><span class="n">ipallocator</span><span class="o">.</span><span class="n">NewCIDRRange</span><span class="p">(</span><span class="n">nodeAddressing</span><span class="o">.</span><span class="n">IPv4</span><span class="p">()</span><span class="o">.</span><span class="n">AllocationCIDR</span><span class="p">()</span><span class="o">.</span><span class="n">IPNet</span><span class="p">)</span><span class="x">
	</span><span class="p">}</span><span class="x">

	</span><span class="k">return</span><span class="x"> </span><span class="n">ipam</span><span class="x">
</span><span class="p">}</span><span class="x">
</span></code></pre></div></div>

<p>It will allocate IP addresses from the specified CIDR.</p>

<p>And more, this is an <strong>in-memory IPAM</strong> - which means, all its states (e.g.
allocated IPs, avaialbe IPs, reserved IPs) are stored in memory, thus will not
survive service restart. But don’t worry, Cilium has it’s own way to recovery
the states on service restart or host reboot - by using other states stored in
etcd.</p>

<p>Let’s moving on to <code class="highlighter-rouge">h.daemon.ipam.AllocateNext(params.Family)</code>.</p>

<h3 id="36-ipam-implementation-in-pkgipam">3.6 IPAM Implementation In <code class="highlighter-rouge">pkg/ipam</code></h3>

<p><code class="highlighter-rouge">pkg/ipam/allocator.go</code>:</p>

<div class="language-go highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c">// AllocateNext allocates the next available IPv4 and IPv6 address out of the</span><span class="x">
</span><span class="c">// configured address pool.</span><span class="x">
</span><span class="k">func</span><span class="x"> </span><span class="p">(</span><span class="n">ipam</span><span class="x"> </span><span class="o">*</span><span class="n">IPAM</span><span class="p">)</span><span class="x"> </span><span class="n">AllocateNext</span><span class="p">(</span><span class="n">family</span><span class="x"> </span><span class="kt">string</span><span class="p">)</span><span class="x"> </span><span class="p">(</span><span class="n">ipv4</span><span class="x"> </span><span class="n">net</span><span class="o">.</span><span class="n">IP</span><span class="p">,</span><span class="x"> </span><span class="n">ipv6</span><span class="x"> </span><span class="n">net</span><span class="o">.</span><span class="n">IP</span><span class="p">,</span><span class="x"> </span><span class="n">err</span><span class="x"> </span><span class="kt">error</span><span class="p">)</span><span class="x"> </span><span class="p">{</span><span class="x">
	</span><span class="n">ipv6</span><span class="x"> </span><span class="o">=</span><span class="x"> </span><span class="n">ipam</span><span class="o">.</span><span class="n">AllocateNextFamily</span><span class="p">(</span><span class="n">IPv6</span><span class="p">)</span><span class="x">
	</span><span class="n">ipv4</span><span class="x"> </span><span class="o">=</span><span class="x"> </span><span class="n">ipam</span><span class="o">.</span><span class="n">AllocateNextFamily</span><span class="p">(</span><span class="n">IPv4</span><span class="p">)</span><span class="x">
</span><span class="p">}</span><span class="x">

</span><span class="c">// AllocateNextFamily allocates the next IP of the requested address family</span><span class="x">
</span><span class="k">func</span><span class="x"> </span><span class="p">(</span><span class="n">ipam</span><span class="x"> </span><span class="o">*</span><span class="n">IPAM</span><span class="p">)</span><span class="x"> </span><span class="n">AllocateNextFamily</span><span class="p">(</span><span class="n">family</span><span class="x"> </span><span class="n">Family</span><span class="p">)</span><span class="x"> </span><span class="p">(</span><span class="n">ip</span><span class="x"> </span><span class="n">net</span><span class="o">.</span><span class="n">IP</span><span class="p">,</span><span class="x"> </span><span class="n">err</span><span class="x"> </span><span class="kt">error</span><span class="p">)</span><span class="x"> </span><span class="p">{</span><span class="x">
	</span><span class="k">switch</span><span class="x"> </span><span class="n">family</span><span class="x"> </span><span class="p">{</span><span class="x">
	</span><span class="k">case</span><span class="x"> </span><span class="n">IPv6</span><span class="o">:</span><span class="x">
		</span><span class="n">ip</span><span class="x"> </span><span class="o">=</span><span class="x"> </span><span class="n">allocateNextFamily</span><span class="p">(</span><span class="n">family</span><span class="p">,</span><span class="x"> </span><span class="n">ipam</span><span class="o">.</span><span class="n">IPv6Allocator</span><span class="p">)</span><span class="x">
	</span><span class="k">case</span><span class="x"> </span><span class="n">IPv4</span><span class="o">:</span><span class="x">
		</span><span class="n">ip</span><span class="x"> </span><span class="o">=</span><span class="x"> </span><span class="n">allocateNextFamily</span><span class="p">(</span><span class="n">family</span><span class="p">,</span><span class="x"> </span><span class="n">ipam</span><span class="o">.</span><span class="n">IPv4Allocator</span><span class="p">)</span><span class="x">
	</span><span class="k">default</span><span class="o">:</span><span class="x">
		</span><span class="n">fmt</span><span class="o">.</span><span class="n">Errorf</span><span class="p">(</span><span class="s">"unknown address </span><span class="se">\"</span><span class="s">%s</span><span class="se">\"</span><span class="s"> family requested"</span><span class="p">,</span><span class="x"> </span><span class="n">family</span><span class="p">)</span><span class="x">
	</span><span class="p">}</span><span class="x">
</span><span class="p">}</span><span class="x">

</span><span class="k">func</span><span class="x"> </span><span class="n">allocateNextFamily</span><span class="p">(</span><span class="n">family</span><span class="x"> </span><span class="n">Family</span><span class="p">,</span><span class="x"> </span><span class="n">allocator</span><span class="x"> </span><span class="o">*</span><span class="n">ipallocator</span><span class="o">.</span><span class="n">Range</span><span class="p">)</span><span class="x"> </span><span class="p">(</span><span class="n">ip</span><span class="x"> </span><span class="n">net</span><span class="o">.</span><span class="n">IP</span><span class="p">,</span><span class="x"> </span><span class="n">err</span><span class="x"> </span><span class="kt">error</span><span class="p">)</span><span class="x"> </span><span class="p">{</span><span class="x">
	</span><span class="n">ip</span><span class="x"> </span><span class="o">=</span><span class="x"> </span><span class="n">allocator</span><span class="o">.</span><span class="n">AllocateNext</span><span class="p">()</span><span class="x">
</span><span class="p">}</span><span class="x">
</span></code></pre></div></div>

<p>After several layers of calls, the execution comes to
<code class="highlighter-rouge">allocator.AllocateNext()</code>, where <code class="highlighter-rouge">AllocateNext()</code> is an interface defined in
<code class="highlighter-rouge">k8s.io/kubernetes/pkg/registry/core/service/ipallocator</code>.</p>

<h3 id="37-real-allocation-logic-in-k8s-builtin-ipam">3.7 Real Allocation Logic in K8S Builtin IPAM</h3>

<p>Now, IP allocation code comes to K8S code.</p>

<p>Reserve IP from pool, in <code class="highlighter-rouge">k8s.io/kubernetes/pkg/registry/core/service/ipallocator</code>:</p>

<div class="language-go highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">func</span><span class="x"> </span><span class="p">(</span><span class="n">r</span><span class="x"> </span><span class="o">*</span><span class="n">Range</span><span class="p">)</span><span class="x"> </span><span class="n">AllocateNext</span><span class="p">()</span><span class="x"> </span><span class="p">(</span><span class="n">net</span><span class="o">.</span><span class="n">IP</span><span class="p">,</span><span class="x"> </span><span class="kt">error</span><span class="p">)</span><span class="x"> </span><span class="p">{</span><span class="x">
	</span><span class="n">offset</span><span class="p">,</span><span class="x"> </span><span class="n">ok</span><span class="x"> </span><span class="o">:=</span><span class="x"> </span><span class="n">r</span><span class="o">.</span><span class="n">alloc</span><span class="o">.</span><span class="n">AllocateNext</span><span class="p">()</span><span class="x">
	</span><span class="k">return</span><span class="x"> </span><span class="n">addIPOffset</span><span class="p">(</span><span class="n">r</span><span class="o">.</span><span class="n">base</span><span class="p">,</span><span class="x"> </span><span class="n">offset</span><span class="p">),</span><span class="x"> </span><span class="no">nil</span><span class="x">
</span><span class="p">}</span><span class="x">
</span></code></pre></div></div>

<p>where <code class="highlighter-rouge">r.alloc</code> is an interface:</p>

<div class="language-go highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c">// Interface manages the allocation of IP addresses out of a range. Interface</span><span class="x">
</span><span class="c">// should be threadsafe.</span><span class="x">
</span><span class="k">type</span><span class="x"> </span><span class="n">Interface</span><span class="x"> </span><span class="k">interface</span><span class="x"> </span><span class="p">{</span><span class="x">
	</span><span class="n">Allocate</span><span class="p">(</span><span class="n">net</span><span class="o">.</span><span class="n">IP</span><span class="p">)</span><span class="x"> </span><span class="kt">error</span><span class="x">
	</span><span class="n">AllocateNext</span><span class="p">()</span><span class="x"> </span><span class="p">(</span><span class="n">net</span><span class="o">.</span><span class="n">IP</span><span class="p">,</span><span class="x"> </span><span class="kt">error</span><span class="p">)</span><span class="x">
	</span><span class="n">Release</span><span class="p">(</span><span class="n">net</span><span class="o">.</span><span class="n">IP</span><span class="p">)</span><span class="x"> </span><span class="kt">error</span><span class="x">
	</span><span class="n">ForEach</span><span class="p">(</span><span class="k">func</span><span class="p">(</span><span class="n">net</span><span class="o">.</span><span class="n">IP</span><span class="p">))</span><span class="x">

	</span><span class="c">// For testing</span><span class="x">
	</span><span class="n">Has</span><span class="p">(</span><span class="n">ip</span><span class="x"> </span><span class="n">net</span><span class="o">.</span><span class="n">IP</span><span class="p">)</span><span class="x"> </span><span class="kt">bool</span><span class="x">
</span><span class="p">}</span><span class="x">
</span></code></pre></div></div>

<p><code class="highlighter-rouge">r.alloc.AllocateNext()</code> returns the offset of next available IP from the first
IP (<code class="highlighter-rouge">r.base</code>) in this CIDR, and <code class="highlighter-rouge">addIPOffset()</code> converts the offset to a
<code class="highlighter-rouge">net.IP</code> format presentation.</p>

<p>moving on, let’s see the allocation details, in
<code class="highlighter-rouge">k8s.io/kubernetes/pkg/registry/core/service/allocator/bimap.go</code>:</p>

<div class="language-go highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c">// AllocateNext reserves one of the items from the pool.</span><span class="x">
</span><span class="c">// (0, false, nil) may be returned if there are no items left.</span><span class="x">
</span><span class="k">func</span><span class="x"> </span><span class="p">(</span><span class="n">r</span><span class="x"> </span><span class="o">*</span><span class="n">AllocationBitmap</span><span class="p">)</span><span class="x"> </span><span class="n">AllocateNext</span><span class="p">()</span><span class="x"> </span><span class="p">(</span><span class="kt">int</span><span class="p">,</span><span class="x"> </span><span class="kt">bool</span><span class="p">,</span><span class="x"> </span><span class="kt">error</span><span class="p">)</span><span class="x"> </span><span class="p">{</span><span class="x">
	</span><span class="n">next</span><span class="p">,</span><span class="x"> </span><span class="n">ok</span><span class="x"> </span><span class="o">:=</span><span class="x"> </span><span class="n">r</span><span class="o">.</span><span class="n">strategy</span><span class="o">.</span><span class="n">AllocateBit</span><span class="p">(</span><span class="n">r</span><span class="o">.</span><span class="n">allocated</span><span class="p">,</span><span class="x"> </span><span class="n">r</span><span class="o">.</span><span class="n">max</span><span class="p">,</span><span class="x"> </span><span class="n">r</span><span class="o">.</span><span class="n">count</span><span class="p">)</span><span class="x">
	</span><span class="n">r</span><span class="o">.</span><span class="n">count</span><span class="o">++</span><span class="x">
	</span><span class="n">r</span><span class="o">.</span><span class="n">allocated</span><span class="x"> </span><span class="o">=</span><span class="x"> </span><span class="n">r</span><span class="o">.</span><span class="n">allocated</span><span class="o">.</span><span class="n">SetBit</span><span class="p">(</span><span class="n">r</span><span class="o">.</span><span class="n">allocated</span><span class="p">,</span><span class="x"> </span><span class="n">next</span><span class="p">,</span><span class="x"> </span><span class="m">1</span><span class="p">)</span><span class="x">
	</span><span class="k">return</span><span class="x"> </span><span class="n">next</span><span class="p">,</span><span class="x"> </span><span class="no">true</span><span class="p">,</span><span class="x"> </span><span class="no">nil</span><span class="x">
</span><span class="p">}</span><span class="x">

</span><span class="k">func</span><span class="x"> </span><span class="p">(</span><span class="n">rss</span><span class="x"> </span><span class="n">randomScanStrategy</span><span class="p">)</span><span class="x"> </span><span class="n">AllocateBit</span><span class="p">(</span><span class="n">allocated</span><span class="x"> </span><span class="o">*</span><span class="n">big</span><span class="o">.</span><span class="n">Int</span><span class="p">,</span><span class="x"> </span><span class="n">max</span><span class="p">,</span><span class="x"> </span><span class="n">count</span><span class="x"> </span><span class="kt">int</span><span class="p">)</span><span class="x"> </span><span class="p">(</span><span class="kt">int</span><span class="p">,</span><span class="x"> </span><span class="kt">bool</span><span class="p">)</span><span class="x"> </span><span class="p">{</span><span class="x">
	</span><span class="k">if</span><span class="x"> </span><span class="n">count</span><span class="x"> </span><span class="o">&gt;=</span><span class="x"> </span><span class="n">max</span><span class="x"> </span><span class="p">{</span><span class="x">
		</span><span class="k">return</span><span class="x"> </span><span class="m">0</span><span class="p">,</span><span class="x"> </span><span class="no">false</span><span class="x">
	</span><span class="p">}</span><span class="x">
	</span><span class="n">offset</span><span class="x"> </span><span class="o">:=</span><span class="x"> </span><span class="n">rss</span><span class="o">.</span><span class="n">rand</span><span class="o">.</span><span class="n">Intn</span><span class="p">(</span><span class="n">max</span><span class="p">)</span><span class="x">
	</span><span class="k">for</span><span class="x"> </span><span class="n">i</span><span class="x"> </span><span class="o">:=</span><span class="x"> </span><span class="m">0</span><span class="p">;</span><span class="x"> </span><span class="n">i</span><span class="x"> </span><span class="o">&lt;</span><span class="x"> </span><span class="n">max</span><span class="p">;</span><span class="x"> </span><span class="n">i</span><span class="o">++</span><span class="x"> </span><span class="p">{</span><span class="x">
		</span><span class="n">at</span><span class="x"> </span><span class="o">:=</span><span class="x"> </span><span class="p">(</span><span class="n">offset</span><span class="x"> </span><span class="o">+</span><span class="x"> </span><span class="n">i</span><span class="p">)</span><span class="x"> </span><span class="o">%</span><span class="x"> </span><span class="n">max</span><span class="x">
		</span><span class="k">if</span><span class="x"> </span><span class="n">allocated</span><span class="o">.</span><span class="n">Bit</span><span class="p">(</span><span class="n">at</span><span class="p">)</span><span class="x"> </span><span class="o">==</span><span class="x"> </span><span class="m">0</span><span class="x"> </span><span class="p">{</span><span class="x">
			</span><span class="k">return</span><span class="x"> </span><span class="n">at</span><span class="p">,</span><span class="x"> </span><span class="no">true</span><span class="x">
		</span><span class="p">}</span><span class="x">
	</span><span class="p">}</span><span class="x">
	</span><span class="k">return</span><span class="x"> </span><span class="m">0</span><span class="p">,</span><span class="x"> </span><span class="no">false</span><span class="x">
</span><span class="p">}</span><span class="x">

</span><span class="k">func</span><span class="x"> </span><span class="p">(</span><span class="n">contiguousScanStrategy</span><span class="p">)</span><span class="x"> </span><span class="n">AllocateBit</span><span class="p">(</span><span class="n">allocated</span><span class="x"> </span><span class="o">*</span><span class="n">big</span><span class="o">.</span><span class="n">Int</span><span class="p">,</span><span class="x"> </span><span class="n">max</span><span class="p">,</span><span class="x"> </span><span class="n">count</span><span class="x"> </span><span class="kt">int</span><span class="p">)</span><span class="x"> </span><span class="p">(</span><span class="kt">int</span><span class="p">,</span><span class="x"> </span><span class="kt">bool</span><span class="p">)</span><span class="x"> </span><span class="p">{</span><span class="x">
	</span><span class="k">if</span><span class="x"> </span><span class="n">count</span><span class="x"> </span><span class="o">&gt;=</span><span class="x"> </span><span class="n">max</span><span class="x"> </span><span class="p">{</span><span class="x">
		</span><span class="k">return</span><span class="x"> </span><span class="m">0</span><span class="p">,</span><span class="x"> </span><span class="no">false</span><span class="x">
	</span><span class="p">}</span><span class="x">
	</span><span class="k">for</span><span class="x"> </span><span class="n">i</span><span class="x"> </span><span class="o">:=</span><span class="x"> </span><span class="m">0</span><span class="p">;</span><span class="x"> </span><span class="n">i</span><span class="x"> </span><span class="o">&lt;</span><span class="x"> </span><span class="n">max</span><span class="p">;</span><span class="x"> </span><span class="n">i</span><span class="o">++</span><span class="x"> </span><span class="p">{</span><span class="x">
		</span><span class="k">if</span><span class="x"> </span><span class="n">allocated</span><span class="o">.</span><span class="n">Bit</span><span class="p">(</span><span class="n">i</span><span class="p">)</span><span class="x"> </span><span class="o">==</span><span class="x"> </span><span class="m">0</span><span class="x"> </span><span class="p">{</span><span class="x">
			</span><span class="k">return</span><span class="x"> </span><span class="n">i</span><span class="p">,</span><span class="x"> </span><span class="no">true</span><span class="x">
		</span><span class="p">}</span><span class="x">
	</span><span class="p">}</span><span class="x">
	</span><span class="k">return</span><span class="x"> </span><span class="m">0</span><span class="p">,</span><span class="x"> </span><span class="no">false</span><span class="x">
</span><span class="p">}</span><span class="x">
</span></code></pre></div></div>

<p>As seen above, the IPAM is really tiny. It maintains a bitmap for IP allocation,
when an IP is allocated out from the pool, the corresponding bit will be set to
1; when IP is returned to the pool, the bit is set to 0. In this way, it could
effectively manage the IP pool.</p>

<p>The IPAM even supports different allocation strategies, as the code snippets
shown, e.g. sequential or random.</p>

<h2 id="4-configure-network">4 Configure Network</h2>

<p>Now, IP addresses have been ready. Next steps are:</p>

<ul>
  <li>calulate routes, gateway</li>
  <li>configure ip, routes, gateway, sysctl, etc</li>
</ul>

<div class="language-go highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="x">	</span><span class="k">if</span><span class="x"> </span><span class="n">ipv4IsEnabled</span><span class="p">(</span><span class="n">ipam</span><span class="p">)</span><span class="x"> </span><span class="p">{</span><span class="x">
		</span><span class="n">ep</span><span class="o">.</span><span class="n">Addressing</span><span class="o">.</span><span class="n">IPV4</span><span class="x"> </span><span class="o">=</span><span class="x"> </span><span class="n">ipam</span><span class="o">.</span><span class="n">Address</span><span class="o">.</span><span class="n">IPV4</span><span class="x">

		</span><span class="n">ipConfig</span><span class="p">,</span><span class="x"> </span><span class="n">routes</span><span class="x"> </span><span class="o">:=</span><span class="x"> </span><span class="n">prepareIP</span><span class="p">(</span><span class="n">ep</span><span class="o">.</span><span class="n">Addressing</span><span class="o">.</span><span class="n">IPV4</span><span class="p">,</span><span class="x"> </span><span class="no">false</span><span class="p">,</span><span class="x"> </span><span class="o">&amp;</span><span class="n">state</span><span class="p">,</span><span class="x"> </span><span class="kt">int</span><span class="p">(</span><span class="n">conf</span><span class="o">.</span><span class="n">RouteMTU</span><span class="p">))</span><span class="x">
		</span><span class="n">res</span><span class="o">.</span><span class="n">IPs</span><span class="x"> </span><span class="o">=</span><span class="x"> </span><span class="nb">append</span><span class="p">(</span><span class="n">res</span><span class="o">.</span><span class="n">IPs</span><span class="p">,</span><span class="x"> </span><span class="n">ipConfig</span><span class="p">)</span><span class="x">
		</span><span class="n">res</span><span class="o">.</span><span class="n">Routes</span><span class="x"> </span><span class="o">=</span><span class="x"> </span><span class="nb">append</span><span class="p">(</span><span class="n">res</span><span class="o">.</span><span class="n">Routes</span><span class="p">,</span><span class="x"> </span><span class="n">routes</span><span class="o">...</span><span class="p">)</span><span class="x">
	</span><span class="p">}</span><span class="x">

	</span><span class="n">netNs</span><span class="o">.</span><span class="n">Do</span><span class="p">(</span><span class="k">func</span><span class="p">(</span><span class="n">_</span><span class="x"> </span><span class="n">ns</span><span class="o">.</span><span class="n">NetNS</span><span class="p">)</span><span class="x"> </span><span class="kt">error</span><span class="x"> </span><span class="p">{</span><span class="x">
		</span><span class="n">allInterfacesPath</span><span class="x"> </span><span class="o">:=</span><span class="x"> </span><span class="n">filepath</span><span class="o">.</span><span class="n">Join</span><span class="p">(</span><span class="s">"/proc"</span><span class="p">,</span><span class="x"> </span><span class="s">"sys"</span><span class="p">,</span><span class="x"> </span><span class="s">"net"</span><span class="p">,</span><span class="x"> </span><span class="s">"ipv6"</span><span class="p">,</span><span class="x"> </span><span class="s">"conf"</span><span class="p">,</span><span class="x"> </span><span class="s">"all"</span><span class="p">,</span><span class="x"> </span><span class="s">"disable_ipv6"</span><span class="p">)</span><span class="x">
		</span><span class="n">connector</span><span class="o">.</span><span class="n">WriteSysConfig</span><span class="p">(</span><span class="n">allInterfacesPath</span><span class="p">,</span><span class="x"> </span><span class="s">"0</span><span class="se">\n</span><span class="s">"</span><span class="p">)</span><span class="x">
		</span><span class="n">macAddrStr</span><span class="x"> </span><span class="o">=</span><span class="x"> </span><span class="n">configureIface</span><span class="p">(</span><span class="n">ipam</span><span class="p">,</span><span class="x"> </span><span class="n">args</span><span class="o">.</span><span class="n">IfName</span><span class="p">,</span><span class="x"> </span><span class="o">&amp;</span><span class="n">state</span><span class="p">)</span><span class="x">
		</span><span class="k">return</span><span class="x"> </span><span class="n">err</span><span class="x">
	</span><span class="p">})</span><span class="x">
</span></code></pre></div></div>

<h3 id="41-prepare-ip-addresses-routes-gateway">4.1 Prepare IP Addresses, Routes, Gateway</h3>

<p>First, call <code class="highlighter-rouge">prepareIP()</code> function to prepare the IP Addresses, gateways, route
entries, etc. The function will return a pointer to an <code class="highlighter-rouge">IPConfig</code>, which holds
the IP and gateway information, and a <code class="highlighter-rouge">Route</code> entry list.</p>

<p>In <code class="highlighter-rouge">plugins/cilium-cni/cilium-cni.go</code>:</p>

<div class="language-go highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">func</span><span class="x"> </span><span class="n">prepareIP</span><span class="p">(</span><span class="n">ipAddr</span><span class="x"> </span><span class="kt">string</span><span class="p">,</span><span class="x"> </span><span class="n">isIPv6</span><span class="x"> </span><span class="kt">bool</span><span class="p">,</span><span class="x"> </span><span class="n">state</span><span class="x"> </span><span class="o">*</span><span class="n">CmdState</span><span class="p">,</span><span class="x"> </span><span class="n">mtu</span><span class="x"> </span><span class="kt">int</span><span class="p">)</span><span class="x"> </span><span class="p">(</span><span class="o">*</span><span class="n">cniTypesVer</span><span class="o">.</span><span class="n">IPConfig</span><span class="p">,</span><span class="x"> </span><span class="p">[]</span><span class="o">*</span><span class="n">cniTypes</span><span class="o">.</span><span class="n">Route</span><span class="p">,</span><span class="x"> </span><span class="kt">error</span><span class="p">)</span><span class="x"> </span><span class="p">{</span><span class="x">
	</span><span class="k">if</span><span class="x"> </span><span class="n">isIPv6</span><span class="x"> </span><span class="p">{</span><span class="x">
        </span><span class="o">...</span><span class="x">
	</span><span class="p">}</span><span class="x"> </span><span class="k">else</span><span class="x"> </span><span class="p">{</span><span class="x">
		</span><span class="n">state</span><span class="o">.</span><span class="n">IP4</span><span class="x"> </span><span class="o">=</span><span class="x"> </span><span class="n">addressing</span><span class="o">.</span><span class="n">NewCiliumIPv4</span><span class="p">(</span><span class="n">ipAddr</span><span class="p">)</span><span class="x">
		</span><span class="n">state</span><span class="o">.</span><span class="n">IP4routes</span><span class="x"> </span><span class="o">=</span><span class="x"> </span><span class="n">connector</span><span class="o">.</span><span class="n">IPv4Routes</span><span class="p">(</span><span class="n">state</span><span class="o">.</span><span class="n">HostAddr</span><span class="p">,</span><span class="x"> </span><span class="n">mtu</span><span class="p">)</span><span class="x">
		</span><span class="n">routes</span><span class="x"> </span><span class="o">=</span><span class="x"> </span><span class="n">state</span><span class="o">.</span><span class="n">IP4routes</span><span class="x">
		</span><span class="n">ip</span><span class="x"> </span><span class="o">=</span><span class="x"> </span><span class="n">state</span><span class="o">.</span><span class="n">IP4</span><span class="x">
		</span><span class="n">gw</span><span class="x"> </span><span class="o">=</span><span class="x"> </span><span class="n">connector</span><span class="o">.</span><span class="n">IPv4Gateway</span><span class="p">(</span><span class="n">state</span><span class="o">.</span><span class="n">HostAddr</span><span class="p">)</span><span class="x">
		</span><span class="n">ipVersion</span><span class="x"> </span><span class="o">=</span><span class="x"> </span><span class="s">"4"</span><span class="x">
	</span><span class="p">}</span><span class="x">

	</span><span class="n">rt</span><span class="x"> </span><span class="o">:=</span><span class="x"> </span><span class="p">[]</span><span class="o">*</span><span class="n">cniTypes</span><span class="o">.</span><span class="n">Route</span><span class="p">{}</span><span class="x">
	</span><span class="k">for</span><span class="x"> </span><span class="n">_</span><span class="p">,</span><span class="x"> </span><span class="n">r</span><span class="x"> </span><span class="o">:=</span><span class="x"> </span><span class="k">range</span><span class="x"> </span><span class="n">routes</span><span class="x"> </span><span class="p">{</span><span class="x">
		</span><span class="n">rt</span><span class="x"> </span><span class="o">=</span><span class="x"> </span><span class="nb">append</span><span class="p">(</span><span class="n">rt</span><span class="p">,</span><span class="x"> </span><span class="n">newCNIRoute</span><span class="p">(</span><span class="n">r</span><span class="p">))</span><span class="x">
	</span><span class="p">}</span><span class="x">

	</span><span class="n">gwIP</span><span class="x"> </span><span class="o">:=</span><span class="x"> </span><span class="n">net</span><span class="o">.</span><span class="n">ParseIP</span><span class="p">(</span><span class="n">gw</span><span class="p">)</span><span class="x">

	</span><span class="k">return</span><span class="x"> </span><span class="o">&amp;</span><span class="n">cniTypesVer</span><span class="o">.</span><span class="n">IPConfig</span><span class="p">{</span><span class="x">
		</span><span class="n">Address</span><span class="o">:</span><span class="x"> </span><span class="o">*</span><span class="n">ip</span><span class="o">.</span><span class="n">EndpointPrefix</span><span class="p">(),</span><span class="x">
		</span><span class="n">Gateway</span><span class="o">:</span><span class="x"> </span><span class="n">gwIP</span><span class="p">,</span><span class="x">
		</span><span class="n">Version</span><span class="o">:</span><span class="x"> </span><span class="n">ipVersion</span><span class="p">,</span><span class="x">
	</span><span class="p">},</span><span class="x"> </span><span class="n">rt</span><span class="p">,</span><span class="x"> </span><span class="no">nil</span><span class="x">
</span><span class="p">}</span><span class="x">
</span></code></pre></div></div>

<p>Take IPv4 as exaple. Following functions are called:</p>

<ol>
  <li><code class="highlighter-rouge">NewCiliumIPv4</code></li>
  <li><code class="highlighter-rouge">IPv4Routes</code></li>
  <li><code class="highlighter-rouge">IPv4Gateway</code></li>
</ol>

<h4 id="ciliumip">CiliumIP</h4>

<p><code class="highlighter-rouge">NewCiliumIPv4()</code> will return a <code class="highlighter-rouge">CiliumIP</code> instance, <code class="highlighter-rouge">common/addressing/ip.go</code>:</p>

<div class="language-go highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">type</span><span class="x"> </span><span class="n">CiliumIP</span><span class="x"> </span><span class="k">interface</span><span class="x"> </span><span class="p">{</span><span class="x">
	</span><span class="n">IPNet</span><span class="p">(</span><span class="n">ones</span><span class="x"> </span><span class="kt">int</span><span class="p">)</span><span class="x"> </span><span class="o">*</span><span class="n">net</span><span class="o">.</span><span class="n">IPNet</span><span class="x">
	</span><span class="n">EndpointPrefix</span><span class="p">()</span><span class="x"> </span><span class="o">*</span><span class="n">net</span><span class="o">.</span><span class="n">IPNet</span><span class="x">
	</span><span class="n">IP</span><span class="p">()</span><span class="x"> </span><span class="n">net</span><span class="o">.</span><span class="n">IP</span><span class="x">
	</span><span class="n">String</span><span class="p">()</span><span class="x"> </span><span class="kt">string</span><span class="x">
	</span><span class="n">IsIPv6</span><span class="p">()</span><span class="x"> </span><span class="kt">bool</span><span class="x">
	</span><span class="n">GetFamilyString</span><span class="p">()</span><span class="x"> </span><span class="kt">string</span><span class="x">
	</span><span class="n">IsSet</span><span class="p">()</span><span class="x"> </span><span class="kt">bool</span><span class="x">
</span><span class="p">}</span><span class="x">
</span></code></pre></div></div>

<h4 id="routes">Routes</h4>

<p><code class="highlighter-rouge">IPv4Routes</code> returns IPv4 routes to be installed in endpoint’s networking
namespace.</p>

<p><code class="highlighter-rouge">pkg/endpoint/connector/ipam.go</code>:</p>

<div class="language-go highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">func</span><span class="x"> </span><span class="n">IPv4Routes</span><span class="p">(</span><span class="n">addr</span><span class="x"> </span><span class="o">*</span><span class="n">models</span><span class="o">.</span><span class="n">NodeAddressing</span><span class="p">,</span><span class="x"> </span><span class="n">linkMTU</span><span class="x"> </span><span class="kt">int</span><span class="p">)</span><span class="x"> </span><span class="p">([]</span><span class="n">route</span><span class="o">.</span><span class="n">Route</span><span class="p">,</span><span class="x"> </span><span class="kt">error</span><span class="p">)</span><span class="x"> </span><span class="p">{</span><span class="x">
	</span><span class="n">ip</span><span class="x"> </span><span class="o">:=</span><span class="x"> </span><span class="n">net</span><span class="o">.</span><span class="n">ParseIP</span><span class="p">(</span><span class="n">addr</span><span class="o">.</span><span class="n">IPV4</span><span class="o">.</span><span class="n">IP</span><span class="p">)</span><span class="x">
	</span><span class="k">return</span><span class="x"> </span><span class="p">[]</span><span class="n">route</span><span class="o">.</span><span class="n">Route</span><span class="p">{</span><span class="x">
		</span><span class="p">{</span><span class="x">
			</span><span class="n">Prefix</span><span class="o">:</span><span class="x"> </span><span class="n">net</span><span class="o">.</span><span class="n">IPNet</span><span class="p">{</span><span class="x">
				</span><span class="n">IP</span><span class="o">:</span><span class="x">   </span><span class="n">ip</span><span class="p">,</span><span class="x">
				</span><span class="n">Mask</span><span class="o">:</span><span class="x"> </span><span class="n">defaults</span><span class="o">.</span><span class="n">ContainerIPv4Mask</span><span class="p">,</span><span class="x">
			</span><span class="p">},</span><span class="x">
		</span><span class="p">},</span><span class="x">
		</span><span class="p">{</span><span class="x">
			</span><span class="n">Prefix</span><span class="o">:</span><span class="x">  </span><span class="n">defaults</span><span class="o">.</span><span class="n">IPv4DefaultRoute</span><span class="p">,</span><span class="x">
			</span><span class="n">Nexthop</span><span class="o">:</span><span class="x"> </span><span class="o">&amp;</span><span class="n">ip</span><span class="p">,</span><span class="x">
			</span><span class="n">MTU</span><span class="o">:</span><span class="x">     </span><span class="n">linkMTU</span><span class="p">,</span><span class="x">
		</span><span class="p">},</span><span class="x">
	</span><span class="p">},</span><span class="x"> </span><span class="no">nil</span><span class="x">
</span><span class="p">}</span><span class="x">
</span></code></pre></div></div>

<h4 id="gateway">Gateway</h4>

<p>note that, the gateway is just set to the host’s IP (TODO: more info on this):</p>

<div class="language-go highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c">// IPv4Gateway returns the IPv4 gateway address for endpoints.</span><span class="x">
</span><span class="k">func</span><span class="x"> </span><span class="n">IPv4Gateway</span><span class="p">(</span><span class="n">addr</span><span class="x"> </span><span class="o">*</span><span class="n">models</span><span class="o">.</span><span class="n">NodeAddressing</span><span class="p">)</span><span class="x"> </span><span class="kt">string</span><span class="x"> </span><span class="p">{</span><span class="x">
	</span><span class="c">// The host's IP is the gateway address</span><span class="x">
	</span><span class="k">return</span><span class="x"> </span><span class="n">addr</span><span class="o">.</span><span class="n">IPV4</span><span class="o">.</span><span class="n">IP</span><span class="x">
</span><span class="p">}</span><span class="x">
</span></code></pre></div></div>

<h3 id="42-configure-network">4.2 Configure Network</h3>

<p>After network information has been prepared well, next step is to
configure them to the container. This is achieved by calling <code class="highlighter-rouge">configureIface</code>:</p>

<div class="language-go highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">func</span><span class="x"> </span><span class="n">configureIface</span><span class="p">(</span><span class="n">ipam</span><span class="x"> </span><span class="o">*</span><span class="n">models</span><span class="o">.</span><span class="n">IPAMResponse</span><span class="p">,</span><span class="x"> </span><span class="n">ifName</span><span class="x"> </span><span class="kt">string</span><span class="p">,</span><span class="x"> </span><span class="n">state</span><span class="x"> </span><span class="o">*</span><span class="n">CmdState</span><span class="p">)</span><span class="x"> </span><span class="p">(</span><span class="kt">string</span><span class="p">,</span><span class="x"> </span><span class="kt">error</span><span class="p">)</span><span class="x"> </span><span class="p">{</span><span class="x">
	</span><span class="n">l</span><span class="x"> </span><span class="o">:=</span><span class="x"> </span><span class="n">netlink</span><span class="o">.</span><span class="n">LinkByName</span><span class="p">(</span><span class="n">ifName</span><span class="p">)</span><span class="x">

	</span><span class="n">addIPConfigToLink</span><span class="p">(</span><span class="n">state</span><span class="o">.</span><span class="n">IP4</span><span class="p">,</span><span class="x"> </span><span class="n">state</span><span class="o">.</span><span class="n">IP4routes</span><span class="p">,</span><span class="x"> </span><span class="n">l</span><span class="p">,</span><span class="x"> </span><span class="n">ifName</span><span class="p">)</span><span class="x">
	</span><span class="n">addIPConfigToLink</span><span class="p">(</span><span class="n">state</span><span class="o">.</span><span class="n">IP6</span><span class="p">,</span><span class="x"> </span><span class="n">state</span><span class="o">.</span><span class="n">IP6routes</span><span class="p">,</span><span class="x"> </span><span class="n">l</span><span class="p">,</span><span class="x"> </span><span class="n">ifName</span><span class="p">)</span><span class="x">
	</span><span class="n">netlink</span><span class="o">.</span><span class="n">LinkSetUp</span><span class="p">(</span><span class="n">l</span><span class="p">)</span><span class="x">
</span><span class="p">}</span><span class="x">
</span></code></pre></div></div>

<p><code class="highlighter-rouge">configureIface</code> first finds the link device by device name (<code class="highlighter-rouge">eth0</code> inside
container), then calls <code class="highlighter-rouge">addIPConfigToLink</code> to do the real jobs:</p>

<div class="language-go highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">func</span><span class="x"> </span><span class="n">addIPConfigToLink</span><span class="p">(</span><span class="n">ip</span><span class="x"> </span><span class="n">addressing</span><span class="o">.</span><span class="n">CiliumIP</span><span class="p">,</span><span class="x"> </span><span class="n">routes</span><span class="x"> </span><span class="p">[]</span><span class="n">route</span><span class="o">.</span><span class="n">Route</span><span class="p">,</span><span class="x"> </span><span class="n">link</span><span class="x"> </span><span class="n">netlink</span><span class="o">.</span><span class="n">Link</span><span class="p">,</span><span class="x"> </span><span class="n">ifName</span><span class="x"> </span><span class="kt">string</span><span class="p">)</span><span class="x"> </span><span class="kt">error</span><span class="x"> </span><span class="p">{</span><span class="x">
	</span><span class="n">addr</span><span class="x"> </span><span class="o">:=</span><span class="x"> </span><span class="o">&amp;</span><span class="n">netlink</span><span class="o">.</span><span class="n">Addr</span><span class="p">{</span><span class="n">IPNet</span><span class="o">:</span><span class="x"> </span><span class="n">ip</span><span class="o">.</span><span class="n">EndpointPrefix</span><span class="p">()}</span><span class="x">
	</span><span class="n">netlink</span><span class="o">.</span><span class="n">AddrAdd</span><span class="p">(</span><span class="n">link</span><span class="p">,</span><span class="x"> </span><span class="n">addr</span><span class="p">)</span><span class="x">

	</span><span class="c">// Sort provided routes to make sure we apply any more specific</span><span class="x">
	</span><span class="c">// routes first which may be used as nexthops in wider routes</span><span class="x">
	</span><span class="n">sort</span><span class="o">.</span><span class="n">Sort</span><span class="p">(</span><span class="n">route</span><span class="o">.</span><span class="n">ByMask</span><span class="p">(</span><span class="n">routes</span><span class="p">))</span><span class="x">

	</span><span class="k">for</span><span class="x"> </span><span class="n">_</span><span class="p">,</span><span class="x"> </span><span class="n">r</span><span class="x"> </span><span class="o">:=</span><span class="x"> </span><span class="k">range</span><span class="x"> </span><span class="n">routes</span><span class="x"> </span><span class="p">{</span><span class="x">
		</span><span class="n">rt</span><span class="x"> </span><span class="o">:=</span><span class="x"> </span><span class="o">&amp;</span><span class="n">netlink</span><span class="o">.</span><span class="n">Route</span><span class="p">{</span><span class="x">
			</span><span class="n">LinkIndex</span><span class="o">:</span><span class="x"> </span><span class="n">link</span><span class="o">.</span><span class="n">Attrs</span><span class="p">()</span><span class="o">.</span><span class="n">Index</span><span class="p">,</span><span class="x">
			</span><span class="n">Scope</span><span class="o">:</span><span class="x">     </span><span class="n">netlink</span><span class="o">.</span><span class="n">SCOPE_UNIVERSE</span><span class="p">,</span><span class="x">
			</span><span class="n">Dst</span><span class="o">:</span><span class="x">       </span><span class="o">&amp;</span><span class="n">r</span><span class="o">.</span><span class="n">Prefix</span><span class="p">,</span><span class="x">
			</span><span class="n">MTU</span><span class="o">:</span><span class="x">       </span><span class="n">r</span><span class="o">.</span><span class="n">MTU</span><span class="p">,</span><span class="x">
		</span><span class="p">}</span><span class="x">

		</span><span class="k">if</span><span class="x"> </span><span class="n">r</span><span class="o">.</span><span class="n">Nexthop</span><span class="x"> </span><span class="o">==</span><span class="x"> </span><span class="no">nil</span><span class="x"> </span><span class="p">{</span><span class="x">
			</span><span class="n">rt</span><span class="o">.</span><span class="n">Scope</span><span class="x"> </span><span class="o">=</span><span class="x"> </span><span class="n">netlink</span><span class="o">.</span><span class="n">SCOPE_LINK</span><span class="x">
		</span><span class="p">}</span><span class="x"> </span><span class="k">else</span><span class="x"> </span><span class="p">{</span><span class="x">
			</span><span class="n">rt</span><span class="o">.</span><span class="n">Gw</span><span class="x"> </span><span class="o">=</span><span class="x"> </span><span class="o">*</span><span class="n">r</span><span class="o">.</span><span class="n">Nexthop</span><span class="x">
		</span><span class="p">}</span><span class="x">

		</span><span class="n">netlink</span><span class="o">.</span><span class="n">RouteAdd</span><span class="p">(</span><span class="n">rt</span><span class="p">)</span><span class="x">
	</span><span class="p">}</span><span class="x">
</span><span class="p">}</span><span class="x">
</span></code></pre></div></div>

<p>It:</p>

<ol>
  <li>first call <code class="highlighter-rouge">netlink.AddrAdd</code> to add IP address to the device</li>
  <li>then install the route entries with <code class="highlighter-rouge">netlink.RouteAdd</code></li>
</ol>

<h2 id="5-create-endpoint">5 Create Endpoint</h2>

<p>What is an Endpoint?  An endpoint is a “<strong>namespaced network interface</strong> to which
cilium applies policies”.</p>

<p>From <code class="highlighter-rouge">api/v1/models/endpoint.go</code>:</p>

<div class="language-go highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">type</span><span class="x"> </span><span class="n">Endpoint</span><span class="x"> </span><span class="k">struct</span><span class="x"> </span><span class="p">{</span><span class="x">
	</span><span class="c">// The cilium-agent-local ID of the endpoint</span><span class="x">
	</span><span class="n">ID</span><span class="x"> </span><span class="kt">int64</span><span class="x"> </span><span class="s">`json:"id,omitempty"`</span><span class="x">

	</span><span class="c">// The desired configuration state of the endpoint</span><span class="x">
	</span><span class="n">Spec</span><span class="x"> </span><span class="o">*</span><span class="n">EndpointConfigurationSpec</span><span class="x"> </span><span class="s">`json:"spec,omitempty"`</span><span class="x">

	</span><span class="c">// The desired and realized configuration state of the endpoint</span><span class="x">
	</span><span class="n">Status</span><span class="x"> </span><span class="o">*</span><span class="n">EndpointStatus</span><span class="x"> </span><span class="s">`json:"status,omitempty"`</span><span class="x">
</span><span class="p">}</span><span class="x">
</span></code></pre></div></div>

<p>For more detailed information refer to <code class="highlighter-rouge">api/v1/models/endpoint*.go</code>, there are
couples of source files.</p>

<h3 id="51-cni-create-endpoint">5.1 CNI: Create Endpoint</h3>

<p>Start from CNI code, <code class="highlighter-rouge">plugins/cilium-cni/cilium-cni.go</code>:</p>

<div class="language-go highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="x">	</span><span class="n">ep</span><span class="o">.</span><span class="n">SyncBuildEndpoint</span><span class="x"> </span><span class="o">=</span><span class="x"> </span><span class="no">true</span><span class="x">
	</span><span class="n">c</span><span class="o">.</span><span class="n">EndpointCreate</span><span class="p">(</span><span class="n">ep</span><span class="p">)</span><span class="x">
</span></code></pre></div></div>

<p>It calls the client’s <code class="highlighter-rouge">EndpointCreate()</code> method.</p>

<h3 id="52-cilium-client-create-endpoint">5.2 Cilium Client: Create Endpoint</h3>

<p>In <code class="highlighter-rouge">pkg/client/endpoint.go</code>:</p>

<div class="language-go highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">func</span><span class="x"> </span><span class="p">(</span><span class="n">c</span><span class="x"> </span><span class="o">*</span><span class="n">Client</span><span class="p">)</span><span class="x"> </span><span class="n">EndpointCreate</span><span class="p">(</span><span class="n">ep</span><span class="x"> </span><span class="o">*</span><span class="n">models</span><span class="o">.</span><span class="n">EndpointChangeRequest</span><span class="p">)</span><span class="x"> </span><span class="kt">error</span><span class="x"> </span><span class="p">{</span><span class="x">
	</span><span class="n">id</span><span class="x"> </span><span class="o">:=</span><span class="x"> </span><span class="n">pkgEndpointID</span><span class="o">.</span><span class="n">NewCiliumID</span><span class="p">(</span><span class="n">ep</span><span class="o">.</span><span class="n">ID</span><span class="p">)</span><span class="x">
	</span><span class="n">params</span><span class="x"> </span><span class="o">:=</span><span class="x"> </span><span class="n">endpoint</span><span class="o">.</span><span class="n">NewPutEndpointIDParams</span><span class="p">()</span><span class="o">.</span><span class="n">WithID</span><span class="p">(</span><span class="n">id</span><span class="p">)</span><span class="o">.</span><span class="n">WithEndpoint</span><span class="p">(</span><span class="n">ep</span><span class="p">)</span><span class="o">.</span><span class="n">WithTimeout</span><span class="p">(</span><span class="n">api</span><span class="o">.</span><span class="n">ClientTimeout</span><span class="p">)</span><span class="x">
	</span><span class="n">_</span><span class="x"> </span><span class="o">:=</span><span class="x"> </span><span class="n">c</span><span class="o">.</span><span class="n">Endpoint</span><span class="o">.</span><span class="n">PutEndpointID</span><span class="p">(</span><span class="n">params</span><span class="p">)</span><span class="x">
	</span><span class="k">return</span><span class="x"> </span><span class="n">Hint</span><span class="p">(</span><span class="n">err</span><span class="p">)</span><span class="x">
</span><span class="p">}</span><span class="x">
</span></code></pre></div></div>

<p>Ignore the <code class="highlighter-rouge">ep.ID</code>, it is not used now.</p>

<p>First call <code class="highlighter-rouge">NewCiliumID()</code> to generate the local endpoint identifier,
<code class="highlighter-rouge">pkg/endpoint/id/id.go</code>:</p>

<div class="language-go highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">const</span><span class="x"> </span><span class="p">(</span><span class="x">
	</span><span class="c">// CiliumLocalIdPrefix is a numeric identifier with local scope. It has</span><span class="x">
	</span><span class="c">// no cluster wide meaning and is only unique in the scope of a single</span><span class="x">
	</span><span class="c">// agent. An endpoint is guaranteed to always have a local scope identifier.</span><span class="x">
	</span><span class="n">CiliumLocalIdPrefix</span><span class="x"> </span><span class="n">PrefixType</span><span class="x"> </span><span class="o">=</span><span class="x"> </span><span class="s">"cilium-local"</span><span class="x">
</span><span class="p">)</span><span class="x">

</span><span class="c">// NewCiliumID returns a new endpoint identifier of type CiliumLocalIdPrefix</span><span class="x">
</span><span class="k">func</span><span class="x"> </span><span class="n">NewCiliumID</span><span class="p">(</span><span class="n">id</span><span class="x"> </span><span class="kt">int64</span><span class="p">)</span><span class="x"> </span><span class="kt">string</span><span class="x"> </span><span class="p">{</span><span class="x">
	</span><span class="k">return</span><span class="x"> </span><span class="n">fmt</span><span class="o">.</span><span class="n">Sprintf</span><span class="p">(</span><span class="s">"%s:%d"</span><span class="p">,</span><span class="x"> </span><span class="n">CiliumLocalIdPrefix</span><span class="p">,</span><span class="x"> </span><span class="n">id</span><span class="p">)</span><span class="x">
</span><span class="p">}</span><span class="x">
</span></code></pre></div></div>

<p><del>as the comments say, this ID is host-local, which means it is unique within
the host. So, the final generated ID will be something like
<code class="highlighter-rouge">cilium-local:53057</code>.</del></p>

<p>Then, the client code arranges request data, and <code class="highlighter-rouge">PUT</code> that data to Cilium REST
API with <code class="highlighter-rouge">PutEndpointID(params)</code>, in <code class="highlighter-rouge">api/client/endpoint/endpoint_client.go</code>:</p>

<div class="language-go highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">func</span><span class="x"> </span><span class="p">(</span><span class="n">a</span><span class="x"> </span><span class="o">*</span><span class="n">Client</span><span class="p">)</span><span class="x"> </span><span class="n">PutEndpointID</span><span class="p">(</span><span class="n">params</span><span class="x"> </span><span class="o">*</span><span class="n">PutEndpointIDParams</span><span class="p">)</span><span class="x"> </span><span class="p">(</span><span class="o">*</span><span class="n">PutEndpointIDCreated</span><span class="p">,</span><span class="x"> </span><span class="kt">error</span><span class="p">)</span><span class="x"> </span><span class="p">{</span><span class="x">
	</span><span class="n">result</span><span class="x"> </span><span class="o">:=</span><span class="x"> </span><span class="n">a</span><span class="o">.</span><span class="n">transport</span><span class="o">.</span><span class="n">Submit</span><span class="p">(</span><span class="o">&amp;</span><span class="n">runtime</span><span class="o">.</span><span class="n">ClientOperation</span><span class="p">{</span><span class="x">
		</span><span class="n">ID</span><span class="o">:</span><span class="x">                 </span><span class="s">"PutEndpointID"</span><span class="p">,</span><span class="x">
		</span><span class="n">Method</span><span class="o">:</span><span class="x">             </span><span class="s">"PUT"</span><span class="p">,</span><span class="x">
		</span><span class="n">PathPattern</span><span class="o">:</span><span class="x">        </span><span class="s">"/endpoint/{id}"</span><span class="p">,</span><span class="x">
		</span><span class="n">Params</span><span class="o">:</span><span class="x">             </span><span class="n">params</span><span class="p">,</span><span class="x">
	</span><span class="p">})</span><span class="x">
	</span><span class="k">return</span><span class="x"> </span><span class="n">result</span><span class="o">.</span><span class="p">(</span><span class="o">*</span><span class="n">PutEndpointIDCreated</span><span class="p">),</span><span class="x"> </span><span class="no">nil</span><span class="x">
</span><span class="p">}</span><span class="x">
</span></code></pre></div></div>

<h3 id="53-cilium-http-server-create-endpoint">5.3 Cilium HTTP Server: Create Endpoint</h3>

<p>The API server is embedded in the daemon process.
HTTP requests entrypoint, <code class="highlighter-rouge">api/server/restapi/endpint/put_endpoint_id.go</code>:</p>

<div class="language-go highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">type</span><span class="x"> </span><span class="n">PutEndpointID</span><span class="x"> </span><span class="k">struct</span><span class="x"> </span><span class="p">{</span><span class="x">
	</span><span class="n">Context</span><span class="x"> </span><span class="o">*</span><span class="n">middleware</span><span class="o">.</span><span class="n">Context</span><span class="x">
	</span><span class="n">Handler</span><span class="x"> </span><span class="n">PutEndpointIDHandler</span><span class="x">
</span><span class="p">}</span><span class="x">

</span><span class="k">func</span><span class="x"> </span><span class="p">(</span><span class="n">o</span><span class="x"> </span><span class="o">*</span><span class="n">PutEndpointID</span><span class="p">)</span><span class="x"> </span><span class="n">ServeHTTP</span><span class="p">(</span><span class="n">rw</span><span class="x"> </span><span class="n">http</span><span class="o">.</span><span class="n">ResponseWriter</span><span class="p">,</span><span class="x"> </span><span class="n">r</span><span class="x"> </span><span class="o">*</span><span class="n">http</span><span class="o">.</span><span class="n">Request</span><span class="p">)</span><span class="x"> </span><span class="p">{</span><span class="x">
	</span><span class="n">route</span><span class="p">,</span><span class="x"> </span><span class="n">rCtx</span><span class="p">,</span><span class="x"> </span><span class="n">_</span><span class="x"> </span><span class="o">:=</span><span class="x"> </span><span class="n">o</span><span class="o">.</span><span class="n">Context</span><span class="o">.</span><span class="n">RouteInfo</span><span class="p">(</span><span class="n">r</span><span class="p">)</span><span class="x">
	</span><span class="k">var</span><span class="x"> </span><span class="n">Params</span><span class="x"> </span><span class="o">=</span><span class="x"> </span><span class="n">NewPutEndpointIDParams</span><span class="p">()</span><span class="x">

	</span><span class="k">if</span><span class="x"> </span><span class="n">err</span><span class="x"> </span><span class="o">:=</span><span class="x"> </span><span class="n">o</span><span class="o">.</span><span class="n">Context</span><span class="o">.</span><span class="n">BindValidRequest</span><span class="p">(</span><span class="n">r</span><span class="p">,</span><span class="x"> </span><span class="n">route</span><span class="p">,</span><span class="x"> </span><span class="o">&amp;</span><span class="n">Params</span><span class="p">);</span><span class="x"> </span><span class="n">err</span><span class="x"> </span><span class="o">!=</span><span class="x"> </span><span class="no">nil</span><span class="x"> </span><span class="p">{</span><span class="x"> </span><span class="c">// bind params</span><span class="x">
		</span><span class="n">o</span><span class="o">.</span><span class="n">Context</span><span class="o">.</span><span class="n">Respond</span><span class="p">(</span><span class="n">rw</span><span class="p">,</span><span class="x"> </span><span class="n">r</span><span class="p">,</span><span class="x"> </span><span class="n">route</span><span class="o">.</span><span class="n">Produces</span><span class="p">,</span><span class="x"> </span><span class="n">route</span><span class="p">,</span><span class="x"> </span><span class="n">err</span><span class="p">)</span><span class="x">
		</span><span class="k">return</span><span class="x">
	</span><span class="p">}</span><span class="x">

	</span><span class="n">res</span><span class="x"> </span><span class="o">:=</span><span class="x"> </span><span class="n">o</span><span class="o">.</span><span class="n">Handler</span><span class="o">.</span><span class="n">Handle</span><span class="p">(</span><span class="n">Params</span><span class="p">)</span><span class="x"> </span><span class="c">// actually handle the request</span><span class="x">

	</span><span class="n">o</span><span class="o">.</span><span class="n">Context</span><span class="o">.</span><span class="n">Respond</span><span class="p">(</span><span class="n">rw</span><span class="p">,</span><span class="x"> </span><span class="n">r</span><span class="p">,</span><span class="x"> </span><span class="n">route</span><span class="o">.</span><span class="n">Produces</span><span class="p">,</span><span class="x"> </span><span class="n">route</span><span class="p">,</span><span class="x"> </span><span class="n">res</span><span class="p">)</span><span class="x">
</span><span class="p">}</span><span class="x">
</span></code></pre></div></div>

<p>The real job will be done in <code class="highlighter-rouge">o.Handler.Handle()</code>.</p>

<h3 id="54-http-handler">5.4 HTTP Handler</h3>

<p>The HTTP handler for <code class="highlighter-rouge">PutEndpointID</code>, <code class="highlighter-rouge">daemon/endpoint.go</code>:</p>

<div class="language-go highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">type</span><span class="x"> </span><span class="n">putEndpointID</span><span class="x"> </span><span class="k">struct</span><span class="x"> </span><span class="p">{</span><span class="x">
	</span><span class="n">d</span><span class="x"> </span><span class="o">*</span><span class="n">Daemon</span><span class="x">
</span><span class="p">}</span><span class="x">

</span><span class="k">func</span><span class="x"> </span><span class="n">NewPutEndpointIDHandler</span><span class="p">(</span><span class="n">d</span><span class="x"> </span><span class="o">*</span><span class="n">Daemon</span><span class="p">)</span><span class="x"> </span><span class="n">PutEndpointIDHandler</span><span class="x"> </span><span class="p">{</span><span class="x">
	</span><span class="k">return</span><span class="x"> </span><span class="o">&amp;</span><span class="n">putEndpointID</span><span class="p">{</span><span class="n">d</span><span class="o">:</span><span class="x"> </span><span class="n">d</span><span class="p">}</span><span class="x">
</span><span class="p">}</span><span class="x">

</span><span class="k">func</span><span class="x"> </span><span class="p">(</span><span class="n">h</span><span class="x"> </span><span class="o">*</span><span class="n">putEndpointID</span><span class="p">)</span><span class="x"> </span><span class="n">Handle</span><span class="p">(</span><span class="n">params</span><span class="x"> </span><span class="n">PutEndpointIDParams</span><span class="p">)</span><span class="x"> </span><span class="n">middleware</span><span class="o">.</span><span class="n">Responder</span><span class="x"> </span><span class="p">{</span><span class="x">
	</span><span class="n">epTemplate</span><span class="x"> </span><span class="o">:=</span><span class="x"> </span><span class="n">params</span><span class="o">.</span><span class="n">Endpoint</span><span class="x">

	</span><span class="n">h</span><span class="o">.</span><span class="n">d</span><span class="o">.</span><span class="n">createEndpoint</span><span class="p">(</span><span class="n">params</span><span class="o">.</span><span class="n">HTTPRequest</span><span class="o">.</span><span class="n">Context</span><span class="p">(),</span><span class="x"> </span><span class="n">epTemplate</span><span class="p">)</span><span class="x">
</span><span class="p">}</span><span class="x">
</span></code></pre></div></div>

<p>as we could see, the handler calls daemon’s <code class="highlighter-rouge">createEndpoint</code> method, which is
defined in the same file. This method attempts to create the endpoint
corresponding to the change request that was specified.</p>

<div class="language-go highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">func</span><span class="x"> </span><span class="p">(</span><span class="n">d</span><span class="x"> </span><span class="o">*</span><span class="n">Daemon</span><span class="p">)</span><span class="x"> </span><span class="n">createEndpoint</span><span class="p">(</span><span class="n">ctx</span><span class="x"> </span><span class="n">context</span><span class="o">.</span><span class="n">Context</span><span class="p">,</span><span class="x"> </span><span class="n">epTemplate</span><span class="x"> </span><span class="o">*</span><span class="n">models</span><span class="o">.</span><span class="n">EndpointChangeRequest</span><span class="p">)</span><span class="x"> </span><span class="p">(</span><span class="o">*</span><span class="n">endpoint</span><span class="o">.</span><span class="n">Endpoint</span><span class="p">,</span><span class="x"> </span><span class="kt">error</span><span class="p">)</span><span class="x"> </span><span class="p">{</span><span class="x">

	</span><span class="n">endpointmanager</span><span class="o">.</span><span class="n">AddEndpoint</span><span class="p">(</span><span class="n">d</span><span class="p">,</span><span class="x"> </span><span class="n">ep</span><span class="p">,</span><span class="x"> </span><span class="s">"Create endpoint from API PUT"</span><span class="p">)</span><span class="x">
	</span><span class="n">ep</span><span class="o">.</span><span class="n">UpdateLabels</span><span class="p">(</span><span class="n">d</span><span class="p">,</span><span class="x"> </span><span class="n">addLabels</span><span class="p">,</span><span class="x"> </span><span class="n">infoLabels</span><span class="p">,</span><span class="x"> </span><span class="no">true</span><span class="p">)</span><span class="x">

	</span><span class="k">if</span><span class="x"> </span><span class="n">build</span><span class="x"> </span><span class="p">{</span><span class="x">
		</span><span class="c">// Do not synchronously regenerate the endpoint when first creating it.</span><span class="x">
		</span><span class="c">// We have custom logic later for waiting for specific checkpoints to be</span><span class="x">
		</span><span class="c">// reached upon regeneration later (checking for when BPF programs have</span><span class="x">
		</span><span class="c">// been compiled), as opposed to waiting for the entire regeneration to</span><span class="x">
		</span><span class="c">// be complete (including proxies being configured). This is done to</span><span class="x">
		</span><span class="c">// avoid a chicken-and-egg problem with L7 policies are imported which</span><span class="x">
		</span><span class="c">// select the endpoint being generated, as when such policies are</span><span class="x">
		</span><span class="c">// imported, regeneration blocks on waiting for proxies to be</span><span class="x">
		</span><span class="c">// configured. When Cilium is used with Istio, though, the proxy is</span><span class="x">
		</span><span class="c">// started as a sidecar, and is not launched yet when this specific code</span><span class="x">
		</span><span class="c">// is executed; if we waited for regeneration to be complete, including</span><span class="x">
		</span><span class="c">// proxy configuration, this code would effectively deadlock addition</span><span class="x">
		</span><span class="c">// of endpoints.</span><span class="x">
		</span><span class="n">ep</span><span class="o">.</span><span class="n">Regenerate</span><span class="p">(</span><span class="n">d</span><span class="p">,</span><span class="x"> </span><span class="o">&amp;</span><span class="n">endpoint</span><span class="o">.</span><span class="n">ExternalRegenerationMetadata</span><span class="p">{</span><span class="x">
			</span><span class="n">Reason</span><span class="o">:</span><span class="x"> </span><span class="s">"Initial build on endpoint creation"</span><span class="p">,</span><span class="x">
		</span><span class="p">})</span><span class="x">
	</span><span class="p">}</span><span class="x">

	</span><span class="c">// Wait for any successful BPF regeneration, which is indicated by any</span><span class="x">
	</span><span class="c">// positive policy revision (&gt;0). As long as at least one BPF</span><span class="x">
	</span><span class="c">// regeneration is successful, the endpoint has network connectivity</span><span class="x">
	</span><span class="c">// so we can return from the creation API call.</span><span class="x">
	</span><span class="n">revCh</span><span class="x"> </span><span class="o">:=</span><span class="x"> </span><span class="n">ep</span><span class="o">.</span><span class="n">WaitForPolicyRevision</span><span class="p">(</span><span class="n">ctx</span><span class="p">,</span><span class="x"> </span><span class="m">1</span><span class="p">)</span><span class="x">
</span><span class="p">}</span><span class="x">
</span></code></pre></div></div>

<p><code class="highlighter-rouge">endpointmanager.AddEndpoint</code> will further call <code class="highlighter-rouge">Insert(ep)</code>.</p>

<p>Another important thing done in this method is <strong>triggering BPF code
re-generation</strong>, by calling <code class="highlighter-rouge">ep.Regenerate()</code> with reason “Initial build on
endpoint creation”.</p>

<p>If re-generated successful, the revision number will be positive.</p>

<p>As long as at least one BPF regeneration is successful, the endpoint has network
connectivity.</p>

<h3 id="55-re-generate-bpf-code">5.5 Re-generate BPF Code</h3>

<p>This is a typical workflow [3]:</p>

<ol>
  <li>generate eBPF source code (in a subset of C)</li>
  <li>compile to ELF file with LLVM, which contains program code, specification for maps and related relocation data</li>
  <li>parse ELF content and load the program into the kernel with tools like <code class="highlighter-rouge">tc</code> (traffic control)</li>
</ol>

<blockquote>
  <p>In eBPF, maps are efficient key/value stores in the kernel that can be shared
between various eBPF programs, but also between user space.</p>
</blockquote>

<p>Now let’s continue the BPF code regeneration path.</p>

<p><code class="highlighter-rouge">pkg/endpoint/policy.go</code>:</p>

<div class="language-go highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c">// Regenerate forces the regeneration of endpoint programs &amp; policy</span><span class="x">
</span><span class="k">func</span><span class="x"> </span><span class="p">(</span><span class="n">e</span><span class="x"> </span><span class="o">*</span><span class="n">Endpoint</span><span class="p">)</span><span class="x"> </span><span class="n">Regenerate</span><span class="p">(</span><span class="n">owner</span><span class="x"> </span><span class="n">Owner</span><span class="p">,</span><span class="x"> </span><span class="n">regenMetadata</span><span class="x"> </span><span class="o">*</span><span class="n">ExternalRegenerationMetadata</span><span class="p">)</span><span class="x"> </span><span class="o">&lt;-</span><span class="k">chan</span><span class="x"> </span><span class="kt">bool</span><span class="x"> </span><span class="p">{</span><span class="x">
	</span><span class="n">done</span><span class="x"> </span><span class="o">:=</span><span class="x"> </span><span class="nb">make</span><span class="p">(</span><span class="k">chan</span><span class="x"> </span><span class="kt">bool</span><span class="p">,</span><span class="x"> </span><span class="m">1</span><span class="p">)</span><span class="x">
	</span><span class="k">go</span><span class="x"> </span><span class="k">func</span><span class="p">()</span><span class="x"> </span><span class="p">{</span><span class="x">
		</span><span class="k">defer</span><span class="x"> </span><span class="k">func</span><span class="p">()</span><span class="x"> </span><span class="p">{</span><span class="x">
			</span><span class="n">done</span><span class="x"> </span><span class="o">&lt;-</span><span class="x"> </span><span class="n">buildSuccess</span><span class="x">
			</span><span class="nb">close</span><span class="p">(</span><span class="n">done</span><span class="p">)</span><span class="x">
		</span><span class="p">}()</span><span class="x">

		</span><span class="n">doneFunc</span><span class="x"> </span><span class="o">:=</span><span class="x"> </span><span class="n">owner</span><span class="o">.</span><span class="n">QueueEndpointBuild</span><span class="p">(</span><span class="kt">uint64</span><span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">ID</span><span class="p">))</span><span class="x">
		</span><span class="k">if</span><span class="x"> </span><span class="n">doneFunc</span><span class="x"> </span><span class="o">!=</span><span class="x"> </span><span class="no">nil</span><span class="x"> </span><span class="p">{</span><span class="x">
			</span><span class="n">regenContext</span><span class="o">.</span><span class="n">DoneFunc</span><span class="x"> </span><span class="o">=</span><span class="x"> </span><span class="n">doneFunc</span><span class="x">
			</span><span class="n">err</span><span class="x"> </span><span class="o">:=</span><span class="x"> </span><span class="n">e</span><span class="o">.</span><span class="n">regenerate</span><span class="p">(</span><span class="n">owner</span><span class="p">,</span><span class="x"> </span><span class="n">regenContext</span><span class="p">)</span><span class="x">
			</span><span class="n">doneFunc</span><span class="p">()</span><span class="x"> </span><span class="c">// in case not called already</span><span class="x">

			</span><span class="c">// notify monitor about endpoint regeneration result</span><span class="x">
		</span><span class="p">}</span><span class="x"> </span><span class="k">else</span><span class="x"> </span><span class="p">{</span><span class="x">
			</span><span class="n">buildSuccess</span><span class="x"> </span><span class="o">=</span><span class="x"> </span><span class="no">false</span><span class="x">
		</span><span class="p">}</span><span class="x">
	</span><span class="p">}()</span><span class="x">

	</span><span class="k">return</span><span class="x"> </span><span class="n">done</span><span class="x">
</span><span class="p">}</span><span class="x">
</span></code></pre></div></div>

<p>It calls enpoint’s <code class="highlighter-rouge">regenerate</code> method, which is defined in the same file:</p>

<div class="language-go highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">func</span><span class="x"> </span><span class="p">(</span><span class="n">e</span><span class="x"> </span><span class="o">*</span><span class="n">Endpoint</span><span class="p">)</span><span class="x"> </span><span class="n">regenerate</span><span class="p">(</span><span class="n">owner</span><span class="x"> </span><span class="n">Owner</span><span class="p">,</span><span class="x"> </span><span class="n">context</span><span class="x"> </span><span class="o">*</span><span class="n">regenerationContext</span><span class="p">)</span><span class="x"> </span><span class="p">(</span><span class="n">retErr</span><span class="x"> </span><span class="kt">error</span><span class="p">)</span><span class="x"> </span><span class="p">{</span><span class="x">
	</span><span class="n">origDir</span><span class="x"> </span><span class="o">:=</span><span class="x"> </span><span class="n">e</span><span class="o">.</span><span class="n">StateDirectoryPath</span><span class="p">()</span><span class="x">
	</span><span class="n">context</span><span class="o">.</span><span class="n">datapathRegenerationContext</span><span class="o">.</span><span class="n">currentDir</span><span class="x"> </span><span class="o">=</span><span class="x"> </span><span class="n">origDir</span><span class="x">

	</span><span class="c">// This is the temporary directory to store the generated headers,</span><span class="x">
	</span><span class="c">// the original existing directory is not overwritten until the</span><span class="x">
	</span><span class="c">// entire generation process has succeeded.</span><span class="x">
	</span><span class="n">tmpDir</span><span class="x"> </span><span class="o">:=</span><span class="x"> </span><span class="n">e</span><span class="o">.</span><span class="n">NextDirectoryPath</span><span class="p">()</span><span class="x">
	</span><span class="n">context</span><span class="o">.</span><span class="n">datapathRegenerationContext</span><span class="o">.</span><span class="n">nextDir</span><span class="x"> </span><span class="o">=</span><span class="x"> </span><span class="n">tmpDir</span><span class="x">
	</span><span class="n">os</span><span class="o">.</span><span class="n">MkdirAll</span><span class="p">(</span><span class="n">tmpDir</span><span class="p">,</span><span class="x"> </span><span class="m">0777</span><span class="p">)</span><span class="x">

	</span><span class="n">revision</span><span class="p">,</span><span class="x"> </span><span class="n">compilationExecuted</span><span class="x"> </span><span class="o">=</span><span class="x"> </span><span class="n">e</span><span class="o">.</span><span class="n">regenerateBPF</span><span class="p">(</span><span class="n">owner</span><span class="p">,</span><span class="x"> </span><span class="n">context</span><span class="p">)</span><span class="x">

	</span><span class="k">return</span><span class="x"> </span><span class="n">e</span><span class="o">.</span><span class="n">updateRealizedState</span><span class="p">(</span><span class="n">stats</span><span class="p">,</span><span class="x"> </span><span class="n">origDir</span><span class="p">,</span><span class="x"> </span><span class="n">revision</span><span class="p">,</span><span class="x"> </span><span class="n">compilationExecuted</span><span class="p">)</span><span class="x">
</span><span class="p">}</span><span class="x">
</span></code></pre></div></div>

<p>As BPF code regeneration is a series of file based operations, <code class="highlighter-rouge">regenerate</code> will
first prepare working directories for the process, then, call endpoint’s
<code class="highlighter-rouge">regenerateBPF</code> method.</p>

<p><code class="highlighter-rouge">regenerateBPF</code> rewrites all headers and updates all BPF maps to reflect the
specified endpoint.</p>

<p><code class="highlighter-rouge">pkg/endpoint/bpf.go</code>:</p>

<div class="language-go highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">func</span><span class="x"> </span><span class="p">(</span><span class="n">e</span><span class="x"> </span><span class="o">*</span><span class="n">Endpoint</span><span class="p">)</span><span class="x"> </span><span class="n">regenerateBPF</span><span class="p">(</span><span class="n">owner</span><span class="x"> </span><span class="n">Owner</span><span class="p">,</span><span class="x"> </span><span class="n">regenContext</span><span class="x"> </span><span class="o">*</span><span class="n">regenerationContext</span><span class="p">)</span><span class="x"> </span><span class="p">(</span><span class="n">revnum</span><span class="x"> </span><span class="kt">uint64</span><span class="p">,</span><span class="x"> </span><span class="n">compiled</span><span class="x"> </span><span class="kt">bool</span><span class="p">,</span><span class="x"> </span><span class="n">reterr</span><span class="x"> </span><span class="kt">error</span><span class="p">)</span><span class="x"> </span><span class="p">{</span><span class="x">
	</span><span class="n">e</span><span class="o">.</span><span class="n">runPreCompilationSteps</span><span class="p">(</span><span class="n">owner</span><span class="p">,</span><span class="x"> </span><span class="n">regenContext</span><span class="p">)</span><span class="x">

	</span><span class="k">if</span><span class="x"> </span><span class="n">option</span><span class="o">.</span><span class="n">Config</span><span class="o">.</span><span class="n">DryMode</span><span class="x"> </span><span class="p">{</span><span class="x"> </span><span class="c">// No need to compile BPF in dry mode.</span><span class="x">
		</span><span class="k">return</span><span class="x"> </span><span class="n">e</span><span class="o">.</span><span class="n">nextPolicyRevision</span><span class="p">,</span><span class="x"> </span><span class="no">false</span><span class="p">,</span><span class="x"> </span><span class="no">nil</span><span class="x">
	</span><span class="p">}</span><span class="x">

	</span><span class="c">// Wait for connection tracking cleaning to complete</span><span class="x">
	</span><span class="o">&lt;-</span><span class="n">datapathRegenCtxt</span><span class="o">.</span><span class="n">ctCleaned</span><span class="x">

	</span><span class="n">compilationExecuted</span><span class="x"> </span><span class="o">=</span><span class="x"> </span><span class="n">e</span><span class="o">.</span><span class="n">realizeBPFState</span><span class="p">(</span><span class="n">regenContext</span><span class="p">)</span><span class="x">

	</span><span class="c">// Hook the endpoint into the endpoint and endpoint to policy tables then expose it</span><span class="x">
	</span><span class="n">eppolicymap</span><span class="o">.</span><span class="n">WriteEndpoint</span><span class="p">(</span><span class="n">datapathRegenCtxt</span><span class="o">.</span><span class="n">epInfoCache</span><span class="o">.</span><span class="n">keys</span><span class="p">,</span><span class="x"> </span><span class="n">e</span><span class="o">.</span><span class="n">PolicyMap</span><span class="o">.</span><span class="n">Fd</span><span class="p">)</span><span class="x">
	</span><span class="n">lxcmap</span><span class="o">.</span><span class="n">WriteEndpoint</span><span class="p">(</span><span class="n">datapathRegenCtxt</span><span class="o">.</span><span class="n">epInfoCache</span><span class="p">)</span><span class="x">

	</span><span class="c">// Signal that BPF program has been generated.</span><span class="x">
	</span><span class="c">// The endpoint has at least L3/L4 connectivity at this point.</span><span class="x">
	</span><span class="n">e</span><span class="o">.</span><span class="n">CloseBPFProgramChannel</span><span class="p">()</span><span class="x">

	</span><span class="c">// Allow another builder to start while we wait for the proxy</span><span class="x">
	</span><span class="k">if</span><span class="x"> </span><span class="n">regenContext</span><span class="o">.</span><span class="n">DoneFunc</span><span class="x"> </span><span class="o">!=</span><span class="x"> </span><span class="no">nil</span><span class="x"> </span><span class="p">{</span><span class="x">
		</span><span class="n">regenContext</span><span class="o">.</span><span class="n">DoneFunc</span><span class="p">()</span><span class="x">
	</span><span class="p">}</span><span class="x">

	</span><span class="n">e</span><span class="o">.</span><span class="n">ctCleaned</span><span class="x"> </span><span class="o">=</span><span class="x"> </span><span class="no">true</span><span class="x">

	</span><span class="c">// Synchronously try to update PolicyMap for this endpoint.</span><span class="x">
	</span><span class="c">//</span><span class="x">
	</span><span class="c">// This must be done after allocating the new redirects, to update the</span><span class="x">
	</span><span class="c">// policy map with the new proxy ports.</span><span class="x">
	</span><span class="n">e</span><span class="o">.</span><span class="n">syncPolicyMap</span><span class="p">()</span><span class="x">

	</span><span class="k">return</span><span class="x"> </span><span class="n">datapathRegenCtxt</span><span class="o">.</span><span class="n">epInfoCache</span><span class="o">.</span><span class="n">revision</span><span class="p">,</span><span class="x"> </span><span class="n">compilationExecuted</span><span class="p">,</span><span class="x"> </span><span class="n">err</span><span class="x">
</span><span class="p">}</span><span class="x">
</span></code></pre></div></div>

<p>BPF source code (in restricted C) is generated in <code class="highlighter-rouge">e.runPreCompilationSteps</code>,
and write to file through <code class="highlighter-rouge">writeHeaderfile</code> in the end of the function:</p>

<div class="language-go highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c">// runPreCompilationSteps runs all of the regeneration steps that are necessary</span><span class="x">
</span><span class="c">// right before compiling the BPF for the given endpoint.</span><span class="x">
</span><span class="k">func</span><span class="x"> </span><span class="p">(</span><span class="n">e</span><span class="x"> </span><span class="o">*</span><span class="n">Endpoint</span><span class="p">)</span><span class="x"> </span><span class="n">runPreCompilationSteps</span><span class="p">(</span><span class="n">owner</span><span class="x"> </span><span class="n">Owner</span><span class="p">,</span><span class="x"> </span><span class="n">regenContext</span><span class="x"> </span><span class="o">*</span><span class="n">regenerationContext</span><span class="p">)</span><span class="x"> </span><span class="p">(</span><span class="kt">error</span><span class="p">)</span><span class="x"> </span><span class="p">{</span><span class="x">
	</span><span class="n">currentDir</span><span class="x"> </span><span class="o">:=</span><span class="x"> </span><span class="n">datapathRegenCtxt</span><span class="o">.</span><span class="n">currentDir</span><span class="x">
	</span><span class="n">nextDir</span><span class="x"> </span><span class="o">:=</span><span class="x"> </span><span class="n">datapathRegenCtxt</span><span class="o">.</span><span class="n">nextDir</span><span class="x">

	</span><span class="k">if</span><span class="x"> </span><span class="n">e</span><span class="o">.</span><span class="n">PolicyMap</span><span class="x"> </span><span class="o">==</span><span class="x"> </span><span class="no">nil</span><span class="x"> </span><span class="p">{</span><span class="x">
		</span><span class="n">e</span><span class="o">.</span><span class="n">PolicyMap</span><span class="x"> </span><span class="o">=</span><span class="x"> </span><span class="n">policymap</span><span class="o">.</span><span class="n">OpenMap</span><span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">PolicyMapPathLocked</span><span class="p">())</span><span class="x">
		</span><span class="n">e</span><span class="o">.</span><span class="n">PolicyMap</span><span class="o">.</span><span class="n">Flush</span><span class="p">()</span><span class="x"> </span><span class="c">// Clean up map contents</span><span class="x">

		</span><span class="c">// Also reset the in-memory state of the realized state as the</span><span class="x">
		</span><span class="c">// BPF map content is guaranteed to be empty right now.</span><span class="x">
		</span><span class="n">e</span><span class="o">.</span><span class="n">realizedPolicy</span><span class="o">.</span><span class="n">PolicyMapState</span><span class="x"> </span><span class="o">=</span><span class="x"> </span><span class="nb">make</span><span class="p">(</span><span class="n">policy</span><span class="o">.</span><span class="n">MapState</span><span class="p">)</span><span class="x">
	</span><span class="p">}</span><span class="x">

	</span><span class="k">if</span><span class="x"> </span><span class="n">e</span><span class="o">.</span><span class="n">bpfConfigMap</span><span class="x"> </span><span class="o">==</span><span class="x"> </span><span class="no">nil</span><span class="x"> </span><span class="p">{</span><span class="x">
		</span><span class="n">e</span><span class="o">.</span><span class="n">bpfConfigMap</span><span class="x"> </span><span class="o">=</span><span class="x"> </span><span class="n">bpfconfig</span><span class="o">.</span><span class="n">OpenMapWithName</span><span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">BPFConfigMapPath</span><span class="p">(),</span><span class="x"> </span><span class="n">e</span><span class="o">.</span><span class="n">BPFConfigMapName</span><span class="p">())</span><span class="x">
		</span><span class="n">e</span><span class="o">.</span><span class="n">realizedBPFConfig</span><span class="x"> </span><span class="o">=</span><span class="x"> </span><span class="o">&amp;</span><span class="n">bpfconfig</span><span class="o">.</span><span class="n">EndpointConfig</span><span class="p">{}</span><span class="x">
	</span><span class="p">}</span><span class="x">

	</span><span class="c">// Only generate &amp; populate policy map if a security identity is set up for</span><span class="x">
	</span><span class="c">// this endpoint.</span><span class="x">
	</span><span class="k">if</span><span class="x"> </span><span class="n">e</span><span class="o">.</span><span class="n">SecurityIdentity</span><span class="x"> </span><span class="o">!=</span><span class="x"> </span><span class="no">nil</span><span class="x"> </span><span class="p">{</span><span class="x">
		</span><span class="n">err</span><span class="x"> </span><span class="o">=</span><span class="x"> </span><span class="n">e</span><span class="o">.</span><span class="n">regeneratePolicy</span><span class="p">(</span><span class="n">owner</span><span class="p">)</span><span class="x">

		</span><span class="c">// Configure the new network policy with the proxies.</span><span class="x">
		</span><span class="n">e</span><span class="o">.</span><span class="n">updateNetworkPolicy</span><span class="p">(</span><span class="n">owner</span><span class="p">,</span><span class="x"> </span><span class="n">datapathRegenCtxt</span><span class="o">.</span><span class="n">proxyWaitGroup</span><span class="p">)</span><span class="x">
	</span><span class="p">}</span><span class="x">

	</span><span class="c">// Generate header file specific to this endpoint for use in compiling</span><span class="x">
	</span><span class="c">// BPF programs for this endpoint.</span><span class="x">
	</span><span class="n">e</span><span class="o">.</span><span class="n">writeHeaderfile</span><span class="p">(</span><span class="n">nextDir</span><span class="p">,</span><span class="x"> </span><span class="n">owner</span><span class="p">)</span><span class="x">
</span><span class="p">}</span><span class="x">
</span></code></pre></div></div>

<p>Continue the calling stack to <code class="highlighter-rouge">e.realizeBPFState</code>:</p>

<div class="language-go highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">func</span><span class="x"> </span><span class="p">(</span><span class="n">e</span><span class="x"> </span><span class="o">*</span><span class="n">Endpoint</span><span class="p">)</span><span class="x"> </span><span class="n">realizeBPFState</span><span class="p">(</span><span class="n">regenContext</span><span class="x"> </span><span class="o">*</span><span class="n">regenerationContext</span><span class="p">)</span><span class="x"> </span><span class="p">(</span><span class="n">compilationExecuted</span><span class="x"> </span><span class="kt">bool</span><span class="p">,</span><span class="x"> </span><span class="n">err</span><span class="x"> </span><span class="kt">error</span><span class="p">)</span><span class="x"> </span><span class="p">{</span><span class="x">
	</span><span class="k">if</span><span class="x"> </span><span class="n">datapathRegenCtxt</span><span class="o">.</span><span class="n">bpfHeaderfilesChanged</span><span class="x"> </span><span class="o">||</span><span class="x"> </span><span class="n">datapathRegenCtxt</span><span class="o">.</span><span class="n">reloadDatapath</span><span class="x"> </span><span class="p">{</span><span class="x">
		</span><span class="c">// Compile and install BPF programs for this endpoint</span><span class="x">
		</span><span class="k">if</span><span class="x"> </span><span class="n">datapathRegenCtxt</span><span class="o">.</span><span class="n">bpfHeaderfilesChanged</span><span class="x"> </span><span class="p">{</span><span class="x">
			</span><span class="n">loader</span><span class="o">.</span><span class="n">CompileAndLoad</span><span class="p">(</span><span class="n">datapathRegenCtxt</span><span class="o">.</span><span class="n">completionCtx</span><span class="p">,</span><span class="x"> </span><span class="n">datapathRegenCtxt</span><span class="o">.</span><span class="n">epInfoCache</span><span class="p">)</span><span class="x">
			</span><span class="n">compilationExecuted</span><span class="x"> </span><span class="o">=</span><span class="x"> </span><span class="no">true</span><span class="x">
		</span><span class="p">}</span><span class="x"> </span><span class="k">else</span><span class="x"> </span><span class="p">{</span><span class="x">
			</span><span class="n">loader</span><span class="o">.</span><span class="n">ReloadDatapath</span><span class="p">(</span><span class="n">datapathRegenCtxt</span><span class="o">.</span><span class="n">completionCtx</span><span class="p">,</span><span class="x"> </span><span class="n">datapathRegenCtxt</span><span class="o">.</span><span class="n">epInfoCache</span><span class="p">)</span><span class="x">
		</span><span class="p">}</span><span class="x">

		</span><span class="n">e</span><span class="o">.</span><span class="n">bpfHeaderfileHash</span><span class="x"> </span><span class="o">=</span><span class="x"> </span><span class="n">datapathRegenCtxt</span><span class="o">.</span><span class="n">bpfHeaderfilesHash</span><span class="x">
	</span><span class="p">}</span><span class="x"> </span><span class="k">else</span><span class="x"> </span><span class="p">{</span><span class="x">
		</span><span class="n">Debug</span><span class="p">(</span><span class="s">"BPF header file unchanged, skipping BPF compilation and installation"</span><span class="p">)</span><span class="x">
	</span><span class="p">}</span><span class="x">

	</span><span class="k">return</span><span class="x"> </span><span class="n">compilationExecuted</span><span class="p">,</span><span class="x"> </span><span class="no">nil</span><span class="x">
</span><span class="p">}</span><span class="x">
</span></code></pre></div></div>

<p><code class="highlighter-rouge">CompileAndLoad</code> compiles and reloads the datapath programs (BPF code).</p>

<p><code class="highlighter-rouge">ReloadDatapath</code> forces the datapath programs to be reloaded. It does
not guarantee recompilation of the programs.</p>

<h3 id="56-compile-and-link-bpf-code">5.6 Compile and Link BPF Code</h3>

<p>Moving on, <code class="highlighter-rouge">CompileAndLoad</code> function.</p>

<p><code class="highlighter-rouge">CompileAndLoad</code> compiles the BPF datapath programs for the specified endpoint
and loads it onto the interface associated with the endpoint.</p>

<p><code class="highlighter-rouge">pkt/datapath/loader/loader.go</code>:</p>

<div class="language-go highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c">// Expects the caller to have created the directory at the path ep.StateDir().</span><span class="x">
</span><span class="k">func</span><span class="x"> </span><span class="n">CompileAndLoad</span><span class="p">(</span><span class="n">ctx</span><span class="x"> </span><span class="n">context</span><span class="o">.</span><span class="n">Context</span><span class="p">,</span><span class="x"> </span><span class="n">ep</span><span class="x"> </span><span class="n">endpoint</span><span class="p">)</span><span class="x"> </span><span class="kt">error</span><span class="x"> </span><span class="p">{</span><span class="x">
	</span><span class="n">dirs</span><span class="x"> </span><span class="o">:=</span><span class="x"> </span><span class="n">directoryInfo</span><span class="p">{</span><span class="x">
		</span><span class="n">Library</span><span class="o">:</span><span class="x"> </span><span class="n">option</span><span class="o">.</span><span class="n">Config</span><span class="o">.</span><span class="n">BpfDir</span><span class="p">,</span><span class="x">
		</span><span class="n">Runtime</span><span class="o">:</span><span class="x"> </span><span class="n">option</span><span class="o">.</span><span class="n">Config</span><span class="o">.</span><span class="n">StateDir</span><span class="p">,</span><span class="x">
		</span><span class="n">State</span><span class="o">:</span><span class="x">   </span><span class="n">ep</span><span class="o">.</span><span class="n">StateDir</span><span class="p">(),</span><span class="x">
		</span><span class="n">Output</span><span class="o">:</span><span class="x">  </span><span class="n">ep</span><span class="o">.</span><span class="n">StateDir</span><span class="p">(),</span><span class="x">
	</span><span class="p">}</span><span class="x">
	</span><span class="k">return</span><span class="x"> </span><span class="n">compileAndLoad</span><span class="p">(</span><span class="n">ctx</span><span class="p">,</span><span class="x"> </span><span class="n">ep</span><span class="p">,</span><span class="x"> </span><span class="o">&amp;</span><span class="n">dirs</span><span class="p">)</span><span class="x">
</span><span class="p">}</span><span class="x">

</span><span class="k">func</span><span class="x"> </span><span class="n">compileAndLoad</span><span class="p">(</span><span class="n">ctx</span><span class="x"> </span><span class="n">context</span><span class="o">.</span><span class="n">Context</span><span class="p">,</span><span class="x"> </span><span class="n">ep</span><span class="x"> </span><span class="n">endpoint</span><span class="p">,</span><span class="x"> </span><span class="n">dirs</span><span class="x"> </span><span class="o">*</span><span class="n">directoryInfo</span><span class="p">)</span><span class="x"> </span><span class="kt">error</span><span class="x"> </span><span class="p">{</span><span class="x">
	</span><span class="n">compileDatapath</span><span class="p">(</span><span class="n">ctx</span><span class="p">,</span><span class="x"> </span><span class="n">ep</span><span class="p">,</span><span class="x"> </span><span class="n">dirs</span><span class="p">,</span><span class="x"> </span><span class="n">debug</span><span class="p">)</span><span class="x">
	</span><span class="k">return</span><span class="x"> </span><span class="n">reloadDatapath</span><span class="p">(</span><span class="n">ctx</span><span class="p">,</span><span class="x"> </span><span class="n">ep</span><span class="p">,</span><span class="x"> </span><span class="n">dirs</span><span class="p">)</span><span class="x">
</span><span class="p">}</span><span class="x">

</span><span class="c">// compileDatapath invokes the compiler and linker to create all state files for</span><span class="x">
</span><span class="c">// the BPF datapath, with the primary target being the BPF ELF binary.</span><span class="x">
</span><span class="c">//</span><span class="x">
</span><span class="c">// If debug is enabled, create also the following output files:</span><span class="x">
</span><span class="c">// * Preprocessed C</span><span class="x">
</span><span class="c">// * Assembly</span><span class="x">
</span><span class="c">// * Object compiled with debug symbols</span><span class="x">
</span><span class="k">func</span><span class="x"> </span><span class="n">compileDatapath</span><span class="p">(</span><span class="n">ctx</span><span class="x"> </span><span class="n">context</span><span class="o">.</span><span class="n">Context</span><span class="p">,</span><span class="x"> </span><span class="n">ep</span><span class="x"> </span><span class="n">endpoint</span><span class="p">,</span><span class="x"> </span><span class="n">dirs</span><span class="x"> </span><span class="o">*</span><span class="n">directoryInfo</span><span class="p">,</span><span class="x"> </span><span class="n">debug</span><span class="x"> </span><span class="kt">bool</span><span class="p">)</span><span class="x"> </span><span class="kt">error</span><span class="x"> </span><span class="p">{</span><span class="x">
	</span><span class="c">// Compile the new program</span><span class="x">
	</span><span class="n">compile</span><span class="p">(</span><span class="n">ctx</span><span class="p">,</span><span class="x"> </span><span class="n">datapathProg</span><span class="p">,</span><span class="x"> </span><span class="n">dirs</span><span class="p">,</span><span class="x"> </span><span class="n">debug</span><span class="p">)</span><span class="x">
</span><span class="p">}</span><span class="x">
</span></code></pre></div></div>

<p>The real compiling and linking work is done in <code class="highlighter-rouge">compile()</code> function, which calls
<code class="highlighter-rouge">clang/llvm</code> to compile and link the C source code into BPF byte code, in
<code class="highlighter-rouge">pkt/datapath/loader/compile.go</code>:</p>

<div class="language-go highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c">// compile and link a program.</span><span class="x">
</span><span class="k">func</span><span class="x"> </span><span class="n">compile</span><span class="p">(</span><span class="n">ctx</span><span class="x"> </span><span class="n">context</span><span class="o">.</span><span class="n">Context</span><span class="p">,</span><span class="x"> </span><span class="n">prog</span><span class="x"> </span><span class="o">*</span><span class="n">progInfo</span><span class="p">,</span><span class="x"> </span><span class="n">dir</span><span class="x"> </span><span class="o">*</span><span class="n">directoryInfo</span><span class="p">,</span><span class="x"> </span><span class="n">debug</span><span class="x"> </span><span class="kt">bool</span><span class="p">)</span><span class="x"> </span><span class="p">(</span><span class="n">err</span><span class="x"> </span><span class="kt">error</span><span class="p">)</span><span class="x"> </span><span class="p">{</span><span class="x">
	</span><span class="n">args</span><span class="x"> </span><span class="o">:=</span><span class="x"> </span><span class="nb">make</span><span class="p">([]</span><span class="kt">string</span><span class="p">,</span><span class="x"> </span><span class="m">0</span><span class="p">,</span><span class="x"> </span><span class="m">16</span><span class="p">)</span><span class="x">
	</span><span class="k">if</span><span class="x"> </span><span class="n">prog</span><span class="o">.</span><span class="n">OutputType</span><span class="x"> </span><span class="o">==</span><span class="x"> </span><span class="n">outputSource</span><span class="x"> </span><span class="p">{</span><span class="x">
		</span><span class="n">args</span><span class="x"> </span><span class="o">=</span><span class="x"> </span><span class="nb">append</span><span class="p">(</span><span class="n">args</span><span class="p">,</span><span class="x"> </span><span class="s">"-E"</span><span class="p">)</span><span class="x"> </span><span class="c">// Preprocessor</span><span class="x">
	</span><span class="p">}</span><span class="x"> </span><span class="k">else</span><span class="x"> </span><span class="p">{</span><span class="x">
		</span><span class="n">args</span><span class="x"> </span><span class="o">=</span><span class="x"> </span><span class="nb">append</span><span class="p">(</span><span class="n">args</span><span class="p">,</span><span class="x"> </span><span class="s">"-emit-llvm"</span><span class="p">)</span><span class="x">
		</span><span class="k">if</span><span class="x"> </span><span class="n">debug</span><span class="x"> </span><span class="p">{</span><span class="x">
			</span><span class="n">args</span><span class="x"> </span><span class="o">=</span><span class="x"> </span><span class="nb">append</span><span class="p">(</span><span class="n">args</span><span class="p">,</span><span class="x"> </span><span class="s">"-g"</span><span class="p">)</span><span class="x">
		</span><span class="p">}</span><span class="x">
	</span><span class="p">}</span><span class="x">
	</span><span class="n">args</span><span class="x"> </span><span class="o">=</span><span class="x"> </span><span class="nb">append</span><span class="p">(</span><span class="n">args</span><span class="p">,</span><span class="x"> </span><span class="n">standardCFlags</span><span class="o">...</span><span class="p">)</span><span class="x">
	</span><span class="n">args</span><span class="x"> </span><span class="o">=</span><span class="x"> </span><span class="nb">append</span><span class="p">(</span><span class="n">args</span><span class="p">,</span><span class="x"> </span><span class="n">progCFlags</span><span class="p">(</span><span class="n">prog</span><span class="p">,</span><span class="x"> </span><span class="n">dir</span><span class="p">)</span><span class="o">...</span><span class="p">)</span><span class="x">

	</span><span class="c">// Compilation is split between two exec calls. First clang generates</span><span class="x">
	</span><span class="c">// LLVM bitcode and then later llc compiles it to byte-code.</span><span class="x">
	</span><span class="k">if</span><span class="x"> </span><span class="n">prog</span><span class="o">.</span><span class="n">OutputType</span><span class="x"> </span><span class="o">==</span><span class="x"> </span><span class="n">outputSource</span><span class="x"> </span><span class="p">{</span><span class="x">
		</span><span class="n">compileCmd</span><span class="x"> </span><span class="o">:=</span><span class="x"> </span><span class="n">exec</span><span class="o">.</span><span class="n">CommandContext</span><span class="p">(</span><span class="n">ctx</span><span class="p">,</span><span class="x"> </span><span class="n">compiler</span><span class="p">,</span><span class="x"> </span><span class="n">args</span><span class="o">...</span><span class="p">)</span><span class="x">
		</span><span class="n">_</span><span class="x"> </span><span class="o">=</span><span class="x"> </span><span class="n">compileCmd</span><span class="o">.</span><span class="n">CombinedOutput</span><span class="p">(</span><span class="n">log</span><span class="p">,</span><span class="x"> </span><span class="n">debug</span><span class="p">)</span><span class="x">
	</span><span class="p">}</span><span class="x"> </span><span class="k">else</span><span class="x"> </span><span class="p">{</span><span class="x">
		</span><span class="k">switch</span><span class="x"> </span><span class="n">prog</span><span class="o">.</span><span class="n">OutputType</span><span class="x"> </span><span class="p">{</span><span class="x">
		</span><span class="k">case</span><span class="x"> </span><span class="n">outputObject</span><span class="o">:</span><span class="x">
			</span><span class="n">compileAndLink</span><span class="p">(</span><span class="n">ctx</span><span class="p">,</span><span class="x"> </span><span class="n">prog</span><span class="p">,</span><span class="x"> </span><span class="n">dir</span><span class="p">,</span><span class="x"> </span><span class="n">debug</span><span class="p">,</span><span class="x"> </span><span class="n">args</span><span class="o">...</span><span class="p">)</span><span class="x">
		</span><span class="k">case</span><span class="x"> </span><span class="n">outputAssembly</span><span class="o">:</span><span class="x">
			</span><span class="n">compileAndLink</span><span class="p">(</span><span class="n">ctx</span><span class="p">,</span><span class="x"> </span><span class="n">prog</span><span class="p">,</span><span class="x"> </span><span class="n">dir</span><span class="p">,</span><span class="x"> </span><span class="no">false</span><span class="p">,</span><span class="x"> </span><span class="n">args</span><span class="o">...</span><span class="p">)</span><span class="x">
		</span><span class="k">default</span><span class="o">:</span><span class="x">
			</span><span class="n">log</span><span class="o">.</span><span class="n">Fatalf</span><span class="p">(</span><span class="s">"Unhandled progInfo.OutputType %s"</span><span class="p">,</span><span class="x"> </span><span class="n">prog</span><span class="o">.</span><span class="n">OutputType</span><span class="p">)</span><span class="x">
		</span><span class="p">}</span><span class="x">
	</span><span class="p">}</span><span class="x">
</span><span class="p">}</span><span class="x">
</span></code></pre></div></div>

<h3 id="57-reload-datapath">5.7 Reload Datapath</h3>

<p>At last, reload the BPF code.</p>

<p>Note that update of the datapath does not cause connections to be dropped [3].</p>

<p><code class="highlighter-rouge">pkt/datapath/loader/loader.go</code>:</p>

<div class="language-go highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">func</span><span class="x"> </span><span class="n">reloadDatapath</span><span class="p">(</span><span class="n">ctx</span><span class="x"> </span><span class="n">context</span><span class="o">.</span><span class="n">Context</span><span class="p">,</span><span class="x"> </span><span class="n">ep</span><span class="x"> </span><span class="n">endpoint</span><span class="p">,</span><span class="x"> </span><span class="n">dirs</span><span class="x"> </span><span class="o">*</span><span class="n">directoryInfo</span><span class="p">)</span><span class="x"> </span><span class="kt">error</span><span class="x"> </span><span class="p">{</span><span class="x">
	</span><span class="c">// Replace the current program</span><span class="x">
	</span><span class="n">objPath</span><span class="x"> </span><span class="o">:=</span><span class="x"> </span><span class="n">path</span><span class="o">.</span><span class="n">Join</span><span class="p">(</span><span class="n">dirs</span><span class="o">.</span><span class="n">Output</span><span class="p">,</span><span class="x"> </span><span class="n">endpointObj</span><span class="p">)</span><span class="x">
	</span><span class="k">if</span><span class="x"> </span><span class="n">ep</span><span class="o">.</span><span class="n">MustGraftDatapathMap</span><span class="p">()</span><span class="x"> </span><span class="p">{</span><span class="x">
		</span><span class="k">if</span><span class="x"> </span><span class="n">err</span><span class="x"> </span><span class="o">:=</span><span class="x"> </span><span class="n">graftDatapath</span><span class="p">(</span><span class="n">ctx</span><span class="p">,</span><span class="x"> </span><span class="n">ep</span><span class="o">.</span><span class="n">MapPath</span><span class="p">(),</span><span class="x"> </span><span class="n">objPath</span><span class="p">,</span><span class="x"> </span><span class="n">symbolFromEndpoint</span><span class="p">);</span><span class="x"> </span><span class="n">err</span><span class="x"> </span><span class="o">!=</span><span class="x"> </span><span class="no">nil</span><span class="x"> </span><span class="p">{</span><span class="x">
			</span><span class="n">scopedLog</span><span class="x"> </span><span class="o">:=</span><span class="x"> </span><span class="n">ep</span><span class="o">.</span><span class="n">Logger</span><span class="p">(</span><span class="n">Subsystem</span><span class="p">)</span><span class="o">.</span><span class="n">WithFields</span><span class="p">(</span><span class="n">logrus</span><span class="o">.</span><span class="n">Fields</span><span class="p">{</span><span class="x">
				</span><span class="n">logfields</span><span class="o">.</span><span class="n">Path</span><span class="o">:</span><span class="x"> </span><span class="n">objPath</span><span class="p">,</span><span class="x">
			</span><span class="p">})</span><span class="x">
			</span><span class="n">scopedLog</span><span class="o">.</span><span class="n">WithError</span><span class="p">(</span><span class="n">err</span><span class="p">)</span><span class="o">.</span><span class="n">Warn</span><span class="p">(</span><span class="s">"JoinEP: Failed to load program"</span><span class="p">)</span><span class="x">
			</span><span class="k">return</span><span class="x"> </span><span class="n">err</span><span class="x">
		</span><span class="p">}</span><span class="x">
	</span><span class="p">}</span><span class="x"> </span><span class="k">else</span><span class="x"> </span><span class="p">{</span><span class="x">
		</span><span class="k">if</span><span class="x"> </span><span class="n">err</span><span class="x"> </span><span class="o">:=</span><span class="x"> </span><span class="n">replaceDatapath</span><span class="p">(</span><span class="n">ctx</span><span class="p">,</span><span class="x"> </span><span class="n">ep</span><span class="o">.</span><span class="n">InterfaceName</span><span class="p">(),</span><span class="x"> </span><span class="n">objPath</span><span class="p">,</span><span class="x"> </span><span class="n">symbolFromEndpoint</span><span class="p">);</span><span class="x"> </span><span class="n">err</span><span class="x"> </span><span class="o">!=</span><span class="x"> </span><span class="no">nil</span><span class="x"> </span><span class="p">{</span><span class="x">
			</span><span class="n">scopedLog</span><span class="x"> </span><span class="o">:=</span><span class="x"> </span><span class="n">ep</span><span class="o">.</span><span class="n">Logger</span><span class="p">(</span><span class="n">Subsystem</span><span class="p">)</span><span class="o">.</span><span class="n">WithFields</span><span class="p">(</span><span class="n">logrus</span><span class="o">.</span><span class="n">Fields</span><span class="p">{</span><span class="x">
				</span><span class="n">logfields</span><span class="o">.</span><span class="n">Path</span><span class="o">:</span><span class="x"> </span><span class="n">objPath</span><span class="p">,</span><span class="x">
				</span><span class="n">logfields</span><span class="o">.</span><span class="n">Veth</span><span class="o">:</span><span class="x"> </span><span class="n">ep</span><span class="o">.</span><span class="n">InterfaceName</span><span class="p">(),</span><span class="x">
			</span><span class="p">})</span><span class="x">
			</span><span class="n">scopedLog</span><span class="o">.</span><span class="n">WithError</span><span class="p">(</span><span class="n">err</span><span class="p">)</span><span class="o">.</span><span class="n">Warn</span><span class="p">(</span><span class="s">"JoinEP: Failed to load program"</span><span class="p">)</span><span class="x">
			</span><span class="k">return</span><span class="x"> </span><span class="n">err</span><span class="x">
		</span><span class="p">}</span><span class="x">
	</span><span class="p">}</span><span class="x">

	</span><span class="k">return</span><span class="x"> </span><span class="no">nil</span><span class="x">
</span><span class="p">}</span><span class="x">
</span></code></pre></div></div>

<p>Source and object files are stored at <code class="highlighter-rouge">/var/run/cilium/state/&lt;endpoint_id&gt;</code> on
cilium agent.  also see <code class="highlighter-rouge">/var/lib/cilium</code> for more details.</p>

<p>Then, call <code class="highlighter-rouge">replaceDatapath</code> to migrate (gracefully update) BPF maps (k/v store
in kernel) and replace <code class="highlighter-rouge">tc</code> filter rules.</p>

<p><code class="highlighter-rouge">pkt/datapath/loader/netlink.go</code>:</p>

<div class="language-go highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c">// replaceDatapath the qdisc and BPF program for a endpoint</span><span class="x">
</span><span class="k">func</span><span class="x"> </span><span class="n">replaceDatapath</span><span class="p">(</span><span class="n">ctx</span><span class="x"> </span><span class="n">context</span><span class="o">.</span><span class="n">Context</span><span class="p">,</span><span class="x"> </span><span class="n">ifName</span><span class="x"> </span><span class="kt">string</span><span class="p">,</span><span class="x"> </span><span class="n">objPath</span><span class="x"> </span><span class="kt">string</span><span class="p">,</span><span class="x"> </span><span class="n">progSec</span><span class="x"> </span><span class="kt">string</span><span class="p">)</span><span class="x"> </span><span class="kt">error</span><span class="x"> </span><span class="p">{</span><span class="x">
	</span><span class="n">err</span><span class="x"> </span><span class="o">:=</span><span class="x"> </span><span class="n">replaceQdisc</span><span class="p">(</span><span class="n">ifName</span><span class="p">)</span><span class="x">

	</span><span class="n">cmd</span><span class="x"> </span><span class="o">:=</span><span class="x"> </span><span class="n">exec</span><span class="o">.</span><span class="n">CommandContext</span><span class="p">(</span><span class="n">ctx</span><span class="p">,</span><span class="x"> </span><span class="s">"cilium-map-migrate"</span><span class="p">,</span><span class="x"> </span><span class="s">"-s"</span><span class="p">,</span><span class="x"> </span><span class="n">objPath</span><span class="p">)</span><span class="x">
	</span><span class="n">cmd</span><span class="o">.</span><span class="n">CombinedOutput</span><span class="p">(</span><span class="n">log</span><span class="p">,</span><span class="x"> </span><span class="no">true</span><span class="p">)</span><span class="x">

	</span><span class="k">defer</span><span class="x"> </span><span class="k">func</span><span class="p">()</span><span class="x"> </span><span class="p">{</span><span class="x">
		</span><span class="k">if</span><span class="x"> </span><span class="n">err</span><span class="x"> </span><span class="o">==</span><span class="x"> </span><span class="no">nil</span><span class="x"> </span><span class="p">{</span><span class="x">
			</span><span class="n">retCode</span><span class="x"> </span><span class="o">=</span><span class="x"> </span><span class="s">"0"</span><span class="x">
		</span><span class="p">}</span><span class="x"> </span><span class="k">else</span><span class="x"> </span><span class="p">{</span><span class="x">
			</span><span class="n">retCode</span><span class="x"> </span><span class="o">=</span><span class="x"> </span><span class="s">"1"</span><span class="x">
		</span><span class="p">}</span><span class="x">
		</span><span class="n">args</span><span class="x"> </span><span class="o">:=</span><span class="x"> </span><span class="p">[]</span><span class="kt">string</span><span class="p">{</span><span class="s">"-e"</span><span class="p">,</span><span class="x"> </span><span class="n">objPath</span><span class="p">,</span><span class="x"> </span><span class="s">"-r"</span><span class="p">,</span><span class="x"> </span><span class="n">retCode</span><span class="p">}</span><span class="x">
		</span><span class="n">cmd</span><span class="x"> </span><span class="o">:=</span><span class="x"> </span><span class="n">exec</span><span class="o">.</span><span class="n">CommandContext</span><span class="p">(</span><span class="n">ctx</span><span class="p">,</span><span class="x"> </span><span class="s">"cilium-map-migrate"</span><span class="p">,</span><span class="x"> </span><span class="n">args</span><span class="o">...</span><span class="p">)</span><span class="x">
		</span><span class="n">_</span><span class="p">,</span><span class="x"> </span><span class="n">_</span><span class="x"> </span><span class="o">=</span><span class="x"> </span><span class="n">cmd</span><span class="o">.</span><span class="n">CombinedOutput</span><span class="p">(</span><span class="n">log</span><span class="p">,</span><span class="x"> </span><span class="no">true</span><span class="p">)</span><span class="x"> </span><span class="c">// ignore errors</span><span class="x">
	</span><span class="p">}()</span><span class="x">

	</span><span class="n">args</span><span class="x"> </span><span class="o">:=</span><span class="x"> </span><span class="p">[]</span><span class="kt">string</span><span class="p">{</span><span class="s">"filter"</span><span class="p">,</span><span class="x"> </span><span class="s">"replace"</span><span class="p">,</span><span class="x"> </span><span class="s">"dev"</span><span class="p">,</span><span class="x"> </span><span class="n">ifName</span><span class="p">,</span><span class="x"> </span><span class="s">"ingress"</span><span class="p">,</span><span class="x">
		</span><span class="s">"prio"</span><span class="p">,</span><span class="x"> </span><span class="s">"1"</span><span class="p">,</span><span class="x"> </span><span class="s">"handle"</span><span class="p">,</span><span class="x"> </span><span class="s">"1"</span><span class="p">,</span><span class="x"> </span><span class="s">"bpf"</span><span class="p">,</span><span class="x"> </span><span class="s">"da"</span><span class="p">,</span><span class="x"> </span><span class="s">"obj"</span><span class="p">,</span><span class="x"> </span><span class="n">objPath</span><span class="p">,</span><span class="x">
		</span><span class="s">"sec"</span><span class="p">,</span><span class="x"> </span><span class="n">progSec</span><span class="p">,</span><span class="x">
	</span><span class="p">}</span><span class="x">
	</span><span class="n">cmd</span><span class="x"> </span><span class="o">=</span><span class="x"> </span><span class="n">exec</span><span class="o">.</span><span class="n">CommandContext</span><span class="p">(</span><span class="n">ctx</span><span class="p">,</span><span class="x"> </span><span class="s">"tc"</span><span class="p">,</span><span class="x"> </span><span class="n">args</span><span class="o">...</span><span class="p">)</span><span class="o">.</span><span class="n">WithFilters</span><span class="p">(</span><span class="n">libbpfFixupMsg</span><span class="p">)</span><span class="x">
	</span><span class="n">_</span><span class="x"> </span><span class="o">=</span><span class="x"> </span><span class="n">cmd</span><span class="o">.</span><span class="n">CombinedOutput</span><span class="p">(</span><span class="n">log</span><span class="p">,</span><span class="x"> </span><span class="no">true</span><span class="p">)</span><span class="x">
</span><span class="p">}</span><span class="x">
</span></code></pre></div></div>

<p>it first calls <code class="highlighter-rouge">replaceQdisc</code>, which is defined in the same file:</p>

<div class="language-go highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">func</span><span class="x"> </span><span class="n">replaceQdisc</span><span class="p">(</span><span class="n">ifName</span><span class="x"> </span><span class="kt">string</span><span class="p">)</span><span class="x"> </span><span class="kt">error</span><span class="x"> </span><span class="p">{</span><span class="x">
	</span><span class="n">link</span><span class="p">,</span><span class="x"> </span><span class="n">err</span><span class="x"> </span><span class="o">:=</span><span class="x"> </span><span class="n">netlink</span><span class="o">.</span><span class="n">LinkByName</span><span class="p">(</span><span class="n">ifName</span><span class="p">)</span><span class="x">
	</span><span class="n">attrs</span><span class="x"> </span><span class="o">:=</span><span class="x"> </span><span class="n">netlink</span><span class="o">.</span><span class="n">QdiscAttrs</span><span class="p">{</span><span class="x">
		</span><span class="n">LinkIndex</span><span class="o">:</span><span class="x"> </span><span class="n">link</span><span class="o">.</span><span class="n">Attrs</span><span class="p">()</span><span class="o">.</span><span class="n">Index</span><span class="p">,</span><span class="x">
		</span><span class="n">Handle</span><span class="o">:</span><span class="x">    </span><span class="n">netlink</span><span class="o">.</span><span class="n">MakeHandle</span><span class="p">(</span><span class="m">0xffff</span><span class="p">,</span><span class="x"> </span><span class="m">0</span><span class="p">),</span><span class="x">
		</span><span class="n">Parent</span><span class="o">:</span><span class="x">    </span><span class="n">netlink</span><span class="o">.</span><span class="n">HANDLE_CLSACT</span><span class="p">,</span><span class="x">
	</span><span class="p">}</span><span class="x">

	</span><span class="n">qdisc</span><span class="x"> </span><span class="o">:=</span><span class="x"> </span><span class="o">&amp;</span><span class="n">netlink</span><span class="o">.</span><span class="n">GenericQdisc</span><span class="p">{</span><span class="x">
		</span><span class="n">QdiscAttrs</span><span class="o">:</span><span class="x"> </span><span class="n">attrs</span><span class="p">,</span><span class="x">
		</span><span class="n">QdiscType</span><span class="o">:</span><span class="x">  </span><span class="s">"clsact"</span><span class="p">,</span><span class="x">
	</span><span class="p">}</span><span class="x">

	</span><span class="n">netlink</span><span class="o">.</span><span class="n">QdiscReplace</span><span class="p">(</span><span class="n">qdisc</span><span class="p">)</span><span class="x">
</span><span class="p">}</span><span class="x">
</span></code></pre></div></div>

<p>then runs following 3 shell commands in wrapped code:</p>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>cilium-map-migrate <span class="nt">-s</span> &lt;objPath&gt;

<span class="nv">$ </span>tc filter replace dev &lt;ifName&gt; ingress prio 1 handle 1 bpf da obj &lt;objPath&gt; sec &lt;progSec&gt;

<span class="nv">$ </span>cilium-map-migrate <span class="nt">-e</span> &lt;objPath&gt; <span class="nt">-r</span> &lt;retCode&gt;
</code></pre></div></div>

<p><code class="highlighter-rouge">cilium-map-migrate</code> tool is implemented in <code class="highlighter-rouge">bpf/cilium-map-migrate.c</code>.
This tool has no <code class="highlighter-rouge">-h</code> or <code class="highlighter-rouge">--help</code> options, you need to check the source code
for the (few) options provided.</p>

<p><a href="http://borkmann.ch/talks/2016_netdev2.pdf"><code class="highlighter-rouge">tc</code> is used here for</a>:</p>

<ul>
  <li>Drop monitor for policy learning</li>
  <li>Packet tracing infrastructure</li>
  <li><code class="highlighter-rouge">bpf_trace_printk()</code> replacement</li>
</ul>

<p>Refer to [2, 3] for more on this.</p>

<p>After above steps are done, we will see something like this on the host:</p>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>tc qdisc | <span class="nb">grep</span> &lt;ifName&gt;
qdisc noqueue 0: dev &lt;ifName&gt; root refcnt 2
qdisc clsact ffff: dev &lt;ifName&gt; parent ffff:fff1

<span class="c"># or</span>
<span class="nv">$ </span>tc qdisc show dev &lt;ifName&gt; ingress
qdisc noqueue 0: root refcnt 2
qdisc clsact ffff: parent ffff:fff1
</code></pre></div></div>

<h2 id="6-conclusion">6 Conclusion</h2>

<p>OK! This is what happens when calling Cilium CNI plugin to add network for a
container. For the limited space, we only covered some of the most important
steps and their corresponding implementations. Hope we could dive into more of
them in future posts.</p>

<p><strong>At the end, thanks to the Cilium team for making it so cool!</strong></p>

<h2 id="references">References</h2>

<ol>
  <li>Cilium source code, <a href="https://github.com/cilium/cilium">https://github.com/cilium/cilium</a></li>
  <li><a href="http://borkmann.ch/talks/2016_netdev2.pdf">Advanced programmability and recent updates with tc’s cls bpf</a>, 2016</li>
  <li><a href="https://opensource.googleblog.com/2016/11/cilium-networking-and-security.html">Cilium: Networking and security for containers with BPF and XDP</a>, Google Blog, 2016</li>
</ol>


  <!-- POST NAVIGATION -->
  <div class="postNav clearfix">
     
      <a class="prev" href="/blog/how-does-ltrace-work-zh/"><span>&laquo;&nbsp;[译] ltrace 是如何工作的</span>
      
    </a>
      
      
      <a class="next" href="/blog/nat-zh/"><span>[译] NAT - 网络地址转换&nbsp;&raquo;</span>
       
      </a>
     
  </div>
</div>


         

      </div>
   </div><!-- end .content -->

   <div class="footer">
   <div class="container">
      <p class="copy">&copy; 2016-2019
      <a href="https://arthurchiao.github.io">Arthur Chiao</a>, Powered by
      <a href="http://jekyllrb.com">Jekyll </a>, Theme originated from
      <a href="https://github.com/brianmaierjr/long-haul"> Long Haul.</a>

      <script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>
      <span id="busuanzi_container_site_pv"> Site visits:
          <span id="busuanzi_value_site_pv"></span>, powered by<a href="http://busuanzi.ibruce.info/"> busuanzi</a>
      </span>

      </p>

      <div class="footer-links"> 
         <ul class="noList"> 
            
            <li><a href="https://www.facebook.com/profile.php?id=100014334455077">
                  <svg id="facebook-square" class="custom-icon" version="1.1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" viewBox="0 0 100 100" style="height: 30px; width: 30px;"><circle class="outer-shape" cx="50" cy="50" r="48" style="opacity: 1;"></circle>
                  <path class="inner-shape" style="opacity: 1;" transform="translate(25,25) scale(0.5)" d="M82.667,1H17.335C8.351,1,1,8.351,1,17.336v65.329c0,8.99,7.351,16.335,16.334,16.335h65.332 C91.652,99.001,99,91.655,99,82.665V17.337C99,8.353,91.652,1.001,82.667,1L82.667,1z M84.318,50H68.375v42.875H50V50h-8.855V35.973 H50v-9.11c0-12.378,5.339-19.739,19.894-19.739h16.772V22.3H72.967c-4.066-0.007-4.57,2.12-4.57,6.078l-0.023,7.594H86.75 l-2.431,14.027V50z"></path>
                  </svg>
            </a></li>
            
            
            <li><a href="https://linkedin.com/in/yanan-zhao-7691317b?trk=hp-identity-photo">
                  <svg id="linkedin" class="custom-icon" version="1.1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" viewBox="0 0 100 100" style="height: 30px; width: 30px;"><circle class="outer-shape" cx="50" cy="50" r="48" style="opacity: 1;"></circle>
                  <path class="inner-shape" style="opacity: 1;" transform="translate(25,25) scale(0.5)" d="M99.001,19.428c-3.606,1.608-7.48,2.695-11.547,3.184c4.15-2.503,7.338-6.466,8.841-11.189 c-3.885,2.318-8.187,4-12.768,4.908c-3.667-3.931-8.893-6.387-14.676-6.387c-11.104,0-20.107,9.054-20.107,20.223 c0,1.585,0.177,3.128,0.52,4.609c-16.71-0.845-31.525-8.895-41.442-21.131C6.092,16.633,5.1,20.107,5.1,23.813 c0,7.017,3.55,13.208,8.945,16.834c-3.296-0.104-6.397-1.014-9.106-2.529c-0.002,0.085-0.002,0.17-0.002,0.255 c0,9.799,6.931,17.972,16.129,19.831c-1.688,0.463-3.463,0.71-5.297,0.71c-1.296,0-2.555-0.127-3.783-0.363 c2.559,8.034,9.984,13.882,18.782,14.045c-6.881,5.424-15.551,8.657-24.971,8.657c-1.623,0-3.223-0.096-4.796-0.282 c8.898,5.738,19.467,9.087,30.82,9.087c36.982,0,57.206-30.817,57.206-57.543c0-0.877-0.02-1.748-0.059-2.617 C92.896,27.045,96.305,23.482,99.001,19.428z"></path>
                  </svg>
            </a></li>
            
            
            <li><a href="https://github.com/ArthurChiao">
                  <svg id="github" class="custom-icon" version="1.1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" viewBox="0 0 100 100" style="height: 30px; width: 30px;"><circle class="outer-shape" cx="50" cy="50" r="48" style="opacity: 1;"></circle>
                  <path class="inner-shape" style="opacity: 1;" transform="translate(25,25) scale(0.5)" d="M50,1C22.938,1,1,22.938,1,50s21.938,49,49,49s49-21.938,49-49S77.062,1,50,1z M79.099,79.099 c-3.782,3.782-8.184,6.75-13.083,8.823c-1.245,0.526-2.509,0.989-3.79,1.387v-7.344c0-3.86-1.324-6.699-3.972-8.517 c1.659-0.16,3.182-0.383,4.57-0.67c1.388-0.287,2.855-0.702,4.402-1.245c1.547-0.543,2.935-1.189,4.163-1.938 c1.228-0.75,2.409-1.723,3.541-2.919s2.082-2.552,2.847-4.067s1.372-3.334,1.818-5.455c0.446-2.121,0.67-4.458,0.67-7.01 c0-4.945-1.611-9.155-4.833-12.633c1.467-3.828,1.308-7.991-0.478-12.489l-1.197-0.143c-0.829-0.096-2.321,0.255-4.474,1.053 c-2.153,0.798-4.57,2.105-7.249,3.924c-3.797-1.053-7.736-1.579-11.82-1.579c-4.115,0-8.039,0.526-11.772,1.579 c-1.69-1.149-3.294-2.097-4.809-2.847c-1.515-0.75-2.727-1.26-3.637-1.532c-0.909-0.271-1.754-0.439-2.536-0.503 c-0.782-0.064-1.284-0.079-1.507-0.048c-0.223,0.031-0.383,0.064-0.478,0.096c-1.787,4.53-1.946,8.694-0.478,12.489 c-3.222,3.477-4.833,7.688-4.833,12.633c0,2.552,0.223,4.889,0.67,7.01c0.447,2.121,1.053,3.94,1.818,5.455 c0.765,1.515,1.715,2.871,2.847,4.067s2.313,2.169,3.541,2.919c1.228,0.751,2.616,1.396,4.163,1.938 c1.547,0.543,3.014,0.957,4.402,1.245c1.388,0.287,2.911,0.511,4.57,0.67c-2.616,1.787-3.924,4.626-3.924,8.517v7.487 c-1.445-0.43-2.869-0.938-4.268-1.53c-4.899-2.073-9.301-5.041-13.083-8.823c-3.782-3.782-6.75-8.184-8.823-13.083 C9.934,60.948,8.847,55.56,8.847,50s1.087-10.948,3.231-16.016c2.073-4.899,5.041-9.301,8.823-13.083s8.184-6.75,13.083-8.823 C39.052,9.934,44.44,8.847,50,8.847s10.948,1.087,16.016,3.231c4.9,2.073,9.301,5.041,13.083,8.823 c3.782,3.782,6.75,8.184,8.823,13.083c2.143,5.069,3.23,10.457,3.23,16.016s-1.087,10.948-3.231,16.016 C85.848,70.915,82.88,75.317,79.099,79.099L79.099,79.099z"></path>
                  </svg>
            </a></li>
             
            
            <li><a href="mailto:arthurchiao@hotmail.com">
                  <svg id="mail" class="custom-icon" version="1.1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" viewBox="0 0 100 100" style="height: 30px; width: 30px;"><circle class="outer-shape" cx="50" cy="50" r="48" style="opacity: 1;"></circle>
                  <path class="inner-shape" style="opacity: 1;" transform="translate(25,25) scale(0.5)" d="M50,1C22.938,1,1,22.938,1,50s21.938,49,49,49s49-21.938,49-49S77.062,1,50,1z M25.5,25.5h49 c0.874,0,1.723,0.188,2.502,0.542L50,57.544L22.998,26.041C23.777,25.687,24.626,25.499,25.5,25.5L25.5,25.5z M19.375,68.375v-36.75 c0-0.128,0.005-0.256,0.014-0.383l17.96,20.953L19.587,69.958C19.448,69.447,19.376,68.916,19.375,68.375L19.375,68.375z M74.5,74.5 h-49c-0.541,0-1.072-0.073-1.583-0.212l17.429-17.429L50,66.956l8.653-10.096l17.429,17.429C75.572,74.427,75.041,74.5,74.5,74.5 L74.5,74.5z M80.625,68.375c0,0.541-0.073,1.072-0.211,1.583L62.652,52.195l17.96-20.953c0.008,0.127,0.014,0.255,0.014,0.383 L80.625,68.375L80.625,68.375z"></path>
                  </svg>
            </a></li>
            
         </ul>
      </div>
   </div>
</div><!-- end .footer -->

   <!-- Add jQuery and other scripts -->
<script src="//ajax.googleapis.com/ajax/libs/jquery/1.11.2/jquery.min.js"></script>
<script>window.jQuery || document.write('<script src=""><\/script>')</script>
<script src="/assets/js/dropcap.min.js"></script>
<script src="/assets/js/responsive-nav.min.js"></script>
<script src="/assets/js/scripts.js"></script>


</body>

</html>
